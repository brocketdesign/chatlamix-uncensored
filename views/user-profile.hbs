<!DOCTYPE html>
<html lang="{{lang}}">
{{> dashboard-header}}
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <!-- Swiper CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <!-- Profile CSS -->
    <link rel="stylesheet" href="/css/user-profile.css">
    <link rel="stylesheet" href="/css/chat-list-tabs.css">
    <link rel="stylesheet" href="/css/character.css">
    <!-- Modal CSS -->
    <link rel="stylesheet" href="/css/user-points.css">
    <link rel="stylesheet" href="/css/chat-footer.css">
    <link rel="stylesheet" href="/css/personas.css">
    <!-- Chat/Character CSS -->
    <link rel="stylesheet" href="/css/chat-suggestions.css">
    <link rel="stylesheet" href="/css/chat-scenario.css">
    <link rel="stylesheet" href="/css/chat-goals-widget.css">
    <link rel="stylesheet" href="/css/chat-history-sidebar.css">
    <!-- Character Specific CSS -->
    <link rel="stylesheet" href="/css/character-gallery.css">
    {{#if isCreator}}
    <link rel="stylesheet" href="/css/creators.css">
    <link rel="stylesheet" href="/css/subscriptions.css">
    {{/if}}
</head>
<body class="user-profile-page">
    {{> dashboard-nav}}

    <div id="swup" class="profile-container {{#if isCreator}}creator-profile{{/if}}" 
         id="userProfilePage" 
         data-user-id="{{userData._id}}"
         data-user-data="{{json userData}}">
        
        <!-- Instagram-style Profile Header -->
        <div class="ig-profile-header">
            <!-- Profile Info Section -->
            <div class="ig-profile-info">
                <div class="ig-avatar-section">
                    <div class="ig-avatar-ring {{#if isCreator}}creator-ring{{/if}}">
                        <img id="profileImage" 
                             class="ig-avatar" 
                             src="{{default userData.profileUrl '/img/avatar.png'}}" 
                             alt="{{userData.nickname}}">
                        {{#if (or isMyProfile isAdmin)}}
                        <div class="ig-avatar-edit" id="editProfileImageBtn" title="Change profile picture">
                            <i class="bi bi-camera-fill"></i>
                        </div>
                        {{/if}}
                    </div>
                    {{#if creatorData.verified}}
                    <div class="ig-verified-badge" title="Verified Creator">
                        <i class="bi bi-patch-check-fill"></i>
                    </div>
                    {{/if}}
                </div>
                
                <div class="ig-stats-row">
                    {{#if isMyProfile}}
                    <div class="ig-stat likes-tab" style="cursor: pointer;">
                        <span class="ig-stat-number">{{default userData.imageLikeCount 0}}</span>
                        <span class="ig-stat-label">{{translations.profile.likes}}</span>
                    </div>
                    {{/if}}
                    <div class="ig-stat characters-tab" style="cursor: pointer;">
                        <span class="ig-stat-number">{{default userData.chatCount 0}}</span>
                        <span class="ig-stat-label">{{translations.profile.characters}}</span>
                    </div>
                    <div class="ig-stat" data-bs-toggle="modal" data-bs-target="#followingModal" style="cursor: pointer;">
                        <span class="ig-stat-number">{{default userData.followCount 0}}</span>
                        <span class="ig-stat-label">{{translations.profile.following}}</span>
                    </div>
                    <div class="ig-stat" data-bs-toggle="modal" data-bs-target="#followersModal" style="cursor: pointer;">
                        <span class="ig-stat-number">{{default userData.followerCount 0}}</span>
                        <span class="ig-stat-label">{{translations.profile.followers}}</span>
                    </div>
                </div>
            </div>

            <!-- Bio Section -->
            <div class="ig-bio-section">
                <h1 class="ig-display-name">
                    {{#if isCreator}}
                        {{default creatorData.displayName userData.nickname}}
                        <span class="ig-creator-badge" title="{{translations.profile.creatorBadgeTitle}}">
                            <i class="bi bi-brush-fill"></i>
                        </span>
                        {{#if creatorData.verified}}
                        <span class="ig-verified-icon" title="{{translations.profile.verifiedCreator}}">
                            <i class="bi bi-patch-check-fill"></i>
                        </span>
                        {{/if}}
                    {{else}}
                        {{userData.nickname}}
                    {{/if}}
                    {{#if userData.username}}
                    <span class="ig-username">@{{userData.username}}</span>
                    {{/if}}
                </h1>
                
                {{#if isCreator}}
                <span class="ig-category-badge">
                    <i class="bi bi-tag-fill"></i> {{creatorData.categoryLabel}}
                </span>
                {{/if}}
                
                {{#if userData.bio}}
                    <p class="ig-bio">{{userData.bio}}</p>
                {{else if creatorData.bio}}
                    <p class="ig-bio">{{creatorData.bio}}</p>
                {{/if}}
                
                {{!-- Subscription Status Badge --}}
                {{#if isMyProfile}}
                <div class="ig-membership-badge {{#if isPremium}}premium{{else}}free{{/if}}">
                    {{#if isPremium}}
                    <i class="bi bi-gem"></i> Premium Member
                    {{else}}
                    <i class="bi bi-person"></i> Free Member
                    {{/if}}
                </div>
                {{/if}}
                
                {{!-- Creator Social Links --}}
                {{#if isCreator}}
                {{#if creatorData.socialLinks}}
                <div class="ig-social-links">
                    {{#if creatorData.socialLinks.instagram}}
                    <a href="{{creatorData.socialLinks.instagram}}" target="_blank" class="ig-social-link" title="Instagram">
                        <i class="bi bi-instagram"></i>
                    </a>
                    {{/if}}
                    {{#if creatorData.socialLinks.twitter}}
                    <a href="{{creatorData.socialLinks.twitter}}" target="_blank" class="ig-social-link" title="Twitter">
                        <i class="bi bi-twitter-x"></i>
                    </a>
                    {{/if}}
                    {{#if creatorData.socialLinks.youtube}}
                    <a href="{{creatorData.socialLinks.youtube}}" target="_blank" class="ig-social-link" title="YouTube">
                        <i class="bi bi-youtube"></i>
                    </a>
                    {{/if}}
                    {{#if creatorData.socialLinks.website}}
                    <a href="{{creatorData.socialLinks.website}}" target="_blank" class="ig-social-link" title="Website">
                        <i class="bi bi-globe"></i>
                    </a>
                    {{/if}}
                </div>
                {{/if}}
                {{/if}}
            </div>

            <!-- Action Buttons Row -->
            <div class="ig-action-row">
                {{#if isMyProfile}}
                    {{!-- My Profile Actions - Creator Section Hidden (Coming Soon) --}}
                    <a href="#" onclick="loadSettingsPage()" class="ig-secondary-btn" title="Settings">
                        <i class="bi bi-gear"></i>
                    </a>
                {{else}}
                    {{!-- Other User's Profile Actions --}}
                    <button class="ig-chat-btn ig-follow-btn {{#if userData.follow}}following{{/if}}" 
                            data-user-id="{{userData._id}}"
                            onclick="toggleFollow(this)">
                        <i class="bi {{#if userData.follow}}bi-person-check-fill{{else}}bi-person-plus-fill{{/if}}"></i>
                        <span class="user-follow">
                            {{#if userData.follow}}
                                {{translations.profile.following}}
                            {{else}}
                                {{translations.profile.follow}}
                            {{/if}}
                        </span>
                    </button>
                    
                    {{!-- Subscribe Button for Creator Profiles --}}
                    {{#if isCreator}}
                    <button class="ig-secondary-btn ig-subscribe-btn" 
                            data-creator-id="{{userData._id}}"
                            onclick="handleSubscribe(this)"
                            title="{{#if translations.profile.subscribe}}{{translations.profile.subscribe}}{{else}}Subscribe{{/if}}">
                        <i class="bi bi-star-fill"></i>
                    </button>
                    {{/if}}
                {{/if}}
            </div>
        </div>

        <!-- Image Moderation Alert -->
        <div id="imageModerationFlagged" class="moderation-alert" style="display: none;">
            <i class="bi bi-exclamation-triangle"></i>
            {{translations.setting.imageModerationFlagged}}
        </div>

        <!-- Instagram-style Tab Navigation -->
        <div class="ig-tab-nav">
            {{#if isMyProfile}}
            <button class="ig-tab active" data-tab="images" title="{{translations.profile.likes}}">
                <i class="bi bi-heart"></i>
            </button>
            {{/if}}
            <button class="ig-tab {{#unless isMyProfile}}active{{/unless}}" data-tab="characters" title="{{translations.profile.characters}}">
                <i class="bi bi-chat-square-dots"></i>
            </button>
            <button class="ig-tab" data-tab="posts" title="{{translations.profile.posts}}">
                <i class="bi bi-grid-3x3"></i>
            </button>
            <button class="ig-tab" data-tab="about" title="{{translations.about}}">
                <i class="bi bi-person-badge"></i>
            </button>
        </div>

        <!-- Content Areas -->
        <div class="tab-content">
            {{#if isMyProfile}}
            <!-- Likes Tab -->
            <div id="images-tab" class="tab-pane active">
                <!-- Description + SFW/NSFW Toggle -->
                <div class="ig-section-card ig-info-card likes-toggle-row my-1">
                    <div class="likes-info">
                        <i class="bi bi-info-circle-fill"></i>
                        <span class="text-muted likes-info-text">{{translations.profile.likesTabInfo}}</span>
                        <span class="text-muted likes-info-text-short">
                            {{#if translations.profile.likesTabInfoShort}}
                                {{translations.profile.likesTabInfoShort}}
                            {{else}}
                                Only you can see your liked posts.
                            {{/if}}
                        </span>
                    </div>
                    <div class="likes-toggle" id="userContentTypeToggle">
                        <label class="ig-toggle">
                            <input type="checkbox" id="showNsfwLikes">
                            <span class="ig-toggle-slider"></span>
                            <span class="ig-toggle-label">Show NSFW</span>
                        </label>
                    </div>
                </div>

                <div class="media-grid" id="user-images-gallery">
                    <!-- Loading state -->
                    <div class="loading-grid">
                        <div class="loading-item"></div>
                        <div class="loading-item"></div>
                        <div class="loading-item"></div>
                        <div class="loading-item"></div>
                        <div class="loading-item"></div>
                        <div class="loading-item"></div>
                    </div>
                </div>
                <div id="images-pagination-controls" class="load-more-area"></div>
            </div>
            {{/if}}

            <!-- Characters Tab -->
            <div id="characters-tab" class="tab-pane {{#unless isMyProfile}}active{{/unless}}" {{#if isMyProfile}}style="display: none;"{{/if}}>
                <div class="media-grid characters-grid" id="user-chat-gallery">
                    <!-- Loading state -->
                    <div class="loading-grid">
                        <div class="loading-item"></div>
                        <div class="loading-item"></div>
                        <div class="loading-item"></div>
                    </div>
                </div>
                <div id="user-chat-pagination-controls" class="load-more-area"></div>
            </div>

            <!-- Posts Tab (Public Profile Posts - Phase 1) -->
            <div id="posts-tab" class="tab-pane" style="display: none;">
                <!-- Post Controls (Owner Only) -->
                {{#if isMyProfile}}
                <div class="ig-post-controls">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <div class="d-flex align-items-center gap-2">
                            <label class="ig-toggle">
                                <input type="checkbox" id="showNsfwPosts">
                                <span class="ig-toggle-slider"></span>
                                <span class="ig-toggle-label">Show NSFW</span>
                            </label>
                        </div>
                        <div class="d-flex gap-2">
                            <a href="/dashboard/posts" class="ig-secondary-btn ig-small-btn">
                                <i class="bi bi-grid"></i>
                            </a>
                            <button class="ig-secondary-btn ig-small-btn" data-bs-toggle="modal" data-bs-target="#createPostModal">
                                <i class="bi bi-plus-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>
                {{/if}}

                <!-- Profile Posts Grid -->
                <div class="profile-posts-section">
                    <div id="profile-posts-grid" class="media-grid">
                        <div class="loading-grid">
                            <div class="loading-item"></div>
                            <div class="loading-item"></div>
                            <div class="loading-item"></div>
                        </div>
                    </div>
                    <div id="posts-pagination-controls" class="d-flex justify-content-center my-3"></div>
                </div>

                {{#if isMyProfile}}
                <!-- Scheduled Posts Section (Owner Only) -->
                <div class="ig-section-card" style="margin: 16px;">
                    <div class="ig-section-header">
                        <i class="bi bi-calendar-event" style="color: #fbbf24;"></i>
                        <span>{{translations.profile.scheduledPosts}}</span>
                        <a href="/dashboard/schedules" class="ig-section-link">
                            <i class="bi bi-arrow-right"></i>
                        </a>
                    </div>
                    <div id="user-schedules" class="ig-schedules-list">
                        <div class="ig-empty-state small">
                            <i class="bi bi-hourglass-split"></i>
                            <p>{{translations.profile.loadingSchedules}}</p>
                        </div>
                    </div>
                </div>
                {{/if}}
            </div>

            <!-- About Tab -->
            <div id="about-tab" class="tab-pane" style="display: none;">
                <div class="ig-about-container">
                    <!-- User Attributes Grid -->
                    <div class="ig-attributes-grid">
                        <!-- Member Since Card -->
                        <div class="ig-attribute-card">
                            <div class="ig-attribute-icon" style="background: linear-gradient(135deg, #8b5cf6, #a855f7);">
                                <i class="bi bi-calendar-heart"></i>
                            </div>
                            <div class="ig-attribute-content">
                                <span class="ig-attribute-label">Member Since</span>
                                <span class="ig-attribute-value" id="memberSince">{{userData.createdAt}}</span>
                            </div>
                        </div>

                        <!-- Subscription Status Card -->
                        <div class="ig-attribute-card">
                            <div class="ig-attribute-icon" style="background: linear-gradient(135deg, {{#if isPremium}}#fbbf24, #f59e0b{{else}}#6b7280, #4b5563{{/if}});">
                                <i class="bi bi-{{#if isPremium}}gem{{else}}person{{/if}}"></i>
                            </div>
                            <div class="ig-attribute-content">
                                <span class="ig-attribute-label">Membership</span>
                                <span class="ig-attribute-value {{#if isPremium}}ig-premium-badge{{/if}}">
                                    {{#if isPremium}}Premium{{else}}Free{{/if}}
                                </span>
                            </div>
                        </div>

                        <!-- Preferred Style Card -->
                        {{#if userData.preferredImageStyle}}
                        <div class="ig-attribute-card">
                            <div class="ig-attribute-icon" style="background: linear-gradient(135deg, #ec4899, #f472b6);">
                                <i class="bi bi-palette-fill"></i>
                            </div>
                            <div class="ig-attribute-content">
                                <span class="ig-attribute-label">Preferred Style</span>
                                <span class="ig-attribute-value" style="text-transform: capitalize;">{{userData.preferredImageStyle}}</span>
                            </div>
                        </div>
                        {{/if}}

                        <!-- Images Created Card -->
                        <div class="ig-attribute-card">
                            <div class="ig-attribute-icon" style="background: linear-gradient(135deg, #10b981, #34d399);">
                                <i class="bi bi-images"></i>
                            </div>
                            <div class="ig-attribute-content">
                                <span class="ig-attribute-label">Images Created</span>
                                <span class="ig-attribute-value">{{default userData.imageCount 0}}</span>
                            </div>
                        </div>

                        <!-- Videos Created Card -->
                        {{#if userData.videoCount}}
                        <div class="ig-attribute-card">
                            <div class="ig-attribute-icon" style="background: linear-gradient(135deg, #3b82f6, #60a5fa);">
                                <i class="bi bi-film"></i>
                            </div>
                            <div class="ig-attribute-content">
                                <span class="ig-attribute-label">Videos Created</span>
                                <span class="ig-attribute-value">{{userData.videoCount}}</span>
                            </div>
                        </div>
                        {{/if}}

                        <!-- Points Card (Only for own profile) -->
                        {{#if isMyProfile}}
                        <div class="ig-attribute-card">
                            <div class="ig-attribute-icon" style="background: linear-gradient(135deg, #f59e0b, #fbbf24);">
                                <i class="bi bi-coin"></i>
                            </div>
                            <div class="ig-attribute-content">
                                <span class="ig-attribute-label">Points</span>
                                <span class="ig-attribute-value">{{default userData.points 0}}</span>
                            </div>
                        </div>
                        {{/if}}

                        <!-- Login Streak Card (Only for own profile) -->
                        {{#if isMyProfile}}
                        {{#if userData.loginStreak}}
                        <div class="ig-attribute-card">
                            <div class="ig-attribute-icon" style="background: linear-gradient(135deg, #ef4444, #f87171);">
                                <i class="bi bi-fire"></i>
                            </div>
                            <div class="ig-attribute-content">
                                <span class="ig-attribute-label">Login Streak</span>
                                <span class="ig-attribute-value">{{userData.loginStreak}} days</span>
                            </div>
                        </div>
                        {{/if}}
                        {{/if}}
                    </div>

                    <!-- Bio Section -->
                    {{#if userData.bio}}
                    <div class="ig-section-card">
                        <div class="ig-section-header">
                            <i class="bi bi-chat-quote"></i>
                            <span>About Me</span>
                        </div>
                        <p class="ig-section-text">{{userData.bio}}</p>
                    </div>
                    {{/if}}

                    <!-- Preferences Section (Only for own profile) -->
                    {{#if isMyProfile}}
                    <div class="ig-section-card">
                        <div class="ig-section-header">
                            <i class="bi bi-sliders"></i>
                            <span>Preferences</span>
                        </div>
                        <div class="ig-preferences-list">
                            {{#if userData.lang}}
                            <div class="ig-preference-item">
                                <span class="ig-preference-label">Language</span>
                                <span class="ig-preference-value" style="text-transform: uppercase;">{{userData.lang}}</span>
                            </div>
                            {{/if}}
                            {{#if userData.showNSFW}}
                            <div class="ig-preference-item">
                                <span class="ig-preference-label">NSFW Content</span>
                                <span class="ig-preference-value">{{#ifEquals userData.showNSFW "true"}}Enabled{{else}}Disabled{{/ifEquals}}</span>
                            </div>
                            {{/if}}
                        </div>
                    </div>
                    {{/if}}

                    <!-- Quick Actions (for own profile) -->
                    {{#if isMyProfile}}
                    <div class="ig-quick-links">
                        <a href="#" onclick="loadSettingsPage()" class="ig-quick-link">
                            <i class="bi bi-gear"></i>
                            <span>Settings</span>
                        </a>
                        <a href="/favorites" class="ig-quick-link">
                            <i class="bi bi-star"></i>
                            <span>Favorites</span>
                        </a>
                        <a href="/dashboard" class="ig-quick-link">
                            <i class="bi bi-speedometer2"></i>
                            <span>Dashboard</span>
                        </a>
                    </div>
                    {{/if}}
                </div>
            </div>
        </div>

        <!-- File Input (Hidden) -->
        {{#if (or isMyProfile isAdmin)}}
            <input type="file" class="form-control" id="profileImageInput" name="profileImageInput" accept="image/*" style="display: none;">
        {{/if}}

        <!-- Followers Modal -->
        <div class="modal fade followers-modal" id="followersModal" tabindex="-1" aria-labelledby="followersModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content followers-modal-content">
                    <div class="modal-header followers-modal-header">
                        <h5 class="modal-title followers-modal-title" id="followersModalLabel">
                            <i class="bi bi-people-fill me-2"></i>{{userData.nickname}} {{translations.followers.followersListTitleFollowers}}
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body followers-modal-body">
                        <div id="followers-list" class="followers-list-container">
                            <!-- Followers will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Following Modal -->
        <div class="modal fade followers-modal" id="followingModal" tabindex="-1" aria-labelledby="followingModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content followers-modal-content">
                    <div class="modal-header followers-modal-header">
                        <h5 class="modal-title followers-modal-title" id="followingModalLabel">
                            <i class="bi bi-person-check-fill me-2"></i>{{userData.nickname}} {{translations.followers.followingListTitle}}
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body followers-modal-body">
                        <div id="following-list" class="followers-list-container">
                            <!-- Following will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {{> dashboard-footer}}

    <script>
        $(document).ready(function(){
            const isMyProfile = `{{isMyProfile}}` == 'true'
            const isAdmin = `{{isAdmin}}` == 'true'
            const userId = '{{userData._id}}';
            
            // Format member since date
            const memberSinceEl = document.getElementById('memberSince');
            if (memberSinceEl) {
                const date = new Date(memberSinceEl.textContent);
                if (!isNaN(date)) {
                    memberSinceEl.textContent = date.toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'short', 
                        day: 'numeric' 
                    });
                }
            }
            
            if(isMyProfile || isAdmin) {
                // Handle profile image editing
                $('#editProfileImageBtn').on('click', function() {
                    $('#profileImageInput').click();
                });

                $('#profileImageInput').change(function(event) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        $('#profileImage').attr('src', e.target.result).show();
                    }
                    reader.readAsDataURL(event.target.files[0]);

                    const formData = new FormData();
                    const profileImage = $('#profileImageInput')[0].files[0];
                    if (profileImage) {
                        formData.append('profile', profileImage);
                        $.ajax({
                            url: '/user/update-info/' + userId,
                            method: 'POST',
                            data: formData,
                            processData: false,
                            contentType: false,
                            success: function(response) {
                                if (window.Clerk) {
                                    const clerkUserId = Clerk.user.id;
                                    const file = new File([profileImage], profileImage.name, { type: profileImage.type });
                                    Clerk.user.setProfileImage({
                                        userId: clerkUserId,
                                        file
                                    })
                                        .then(response => {
                                            console.log("Clerk user profile image updated:", response);
                                        })
                                        .catch(error => {
                                            console.error("Error updating Clerk user profile image:", error);
                                        });
                                }
                            },
                            error: function(jqXHR) {
                                console.log(jqXHR.responseJSON.error)
                            }
                        });
                    }
                });
            }

            // Instagram-style Tab switching functionality
            $('.ig-tab').on('click', function() {
                const tabName = $(this).data('tab');
                
                // Update active tab button
                $('.ig-tab').removeClass('active');
                $(this).addClass('active');
                
                // Hide all tab panes
                $('.tab-pane').hide();
                
                // Show selected tab pane and load data
                if (tabName === 'images') {
                    $('#images-tab').show();
                    // Load with current content type selection
                    const currentContentType = window.userProfile ? window.userProfile.contentType : 'SFW';
                    loadUserImages(userId, 1, true, false, currentContentType);
                } else if (tabName === 'characters') {
                    $('#characters-tab').show();
                    // Force refresh with cache-busting to show latest characters first
                    displayUserChats(userId, 1, true, true);
                } else if (tabName === 'posts') {
                    $('#posts-tab').show();
                    loadProfilePosts(1);
                    if (isMyProfile) {
                        loadUserSchedules();
                    }
                } else if (tabName === 'about') {
                    $('#about-tab').show();
                }
            });
            
            // Handle stat clicks to switch tabs
            $('.ig-stat.likes-tab').on('click', function() {
                $('.ig-tab[data-tab="images"]').click();
            });
            
            $('.ig-stat.characters-tab').on('click', function() {
                $('.ig-tab[data-tab="characters"]').click();
            });

            // Current posts page state
            let currentPostsPage = 1;
            let showNsfw = false;

            // NSFW toggle handler
            $('#showNsfwPosts').on('change', function() {
                showNsfw = $(this).is(':checked');
                loadProfilePosts(1);
            });
            
            // Load profile posts (Phase 1 - public posts visible to all)
            async function loadProfilePosts(page = 1) {
                const container = $('#profile-posts-grid');
                const paginationContainer = $('#posts-pagination-controls');
                currentPostsPage = page;
                
                container.html(`
                    <div class="text-center p-4 text-muted">
                        <i class="bi bi-hourglass-split fs-4 mb-2"></i>
                        <p class="mb-0">Loading posts...</p>
                    </div>
                `);
                
                try {
                    const response = await fetch(`/api/user/${userId}/public-posts?page=${page}&limit=12&nsfw=${showNsfw}`);
                    const data = await response.json();
                    
                    if (!data.success || !data.posts || data.posts.length === 0) {
                        container.html(`
                            <div class="text-center p-4 text-muted">
                                <i class="bi bi-images fs-1 mb-2"></i>
                                <p class="mb-0">${isMyProfile ? 'No posts yet. Create your first post!' : 'No posts yet.'}</p>
                            </div>
                        `);
                        paginationContainer.html('');
                        return;
                    }
                    
                    // Render posts grid
                    container.html(data.posts.map(post => renderPostCard(post)).join(''));
                    
                    // Render pagination
                    if (data.pagination.totalPages > 1) {
                        renderPostsPagination(data.pagination, paginationContainer);
                    } else {
                        paginationContainer.html('');
                    }
                } catch (error) {
                    console.error('Error loading profile posts:', error);
                    container.html(`
                        <div class="text-center p-4 text-muted">
                            <i class="bi bi-exclamation-triangle fs-4 mb-2"></i>
                            <p class="mb-0">Failed to load posts</p>
                        </div>
                    `);
                }
            }

            // Render a single post card
            function renderPostCard(post) {
                const mediaUrl = post.content?.imageUrl || post.content?.thumbnailUrl || post.content?.videoUrl;
                const isVideo = post.type === 'video';
                const caption = post.content?.caption || '';
                const likes = post.likes || 0;
                const commentsCount = (post.comments || []).length;
                const isNsfw = post.metadata?.nsfw;
                const visibility = post.visibility || 'public';
                
                // Visibility badge
                let visibilityBadge = '';
                if (isMyProfile && visibility !== 'public') {
                    const visIcons = {
                        'followers': '<i class="bi bi-people-fill"></i>',
                        'subscribers': '<i class="bi bi-credit-card-fill"></i>',
                        'private': '<i class="bi bi-lock-fill"></i>'
                    };
                    visibilityBadge = `<span class="visibility-badge">${visIcons[visibility] || ''}</span>`;
                }
                
                return `
                    <div class="post-card" data-post-id="${post._id}" onclick="openPostModal('${post._id}')">
                        <div class="post-media ${isNsfw && !showNsfw ? 'nsfw-blur' : ''}">
                            ${isVideo 
                                ? `<video src="${mediaUrl}" muted></video><span class="video-indicator"><i class="bi bi-play-fill"></i></span>`
                                : `<img src="${mediaUrl}" alt="Post" onerror="this.src='/img/placeholder.png'">`
                            }
                            ${visibilityBadge}
                            ${isNsfw ? '<span class="nsfw-badge">NSFW</span>' : ''}
                        </div>
                        <div class="post-overlay">
                            <div class="post-stats">
                                <span><i class="bi bi-heart-fill"></i> ${likes}</span>
                                <span><i class="bi bi-chat-fill"></i> ${commentsCount}</span>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Render pagination controls for posts
            function renderPostsPagination(pagination, container) {
                const { page, totalPages } = pagination;
                let html = '<nav><ul class="pagination pagination-sm mb-0">';
                
                // Previous button
                html += `<li class="page-item ${page === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="loadProfilePosts(${page - 1}); return false;">
                        <i class="bi bi-chevron-left"></i>
                    </a>
                </li>`;
                
                // Page numbers
                const startPage = Math.max(1, page - 2);
                const endPage = Math.min(totalPages, page + 2);
                
                for (let i = startPage; i <= endPage; i++) {
                    html += `<li class="page-item ${i === page ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="loadProfilePosts(${i}); return false;">${i}</a>
                    </li>`;
                }
                
                // Next button
                html += `<li class="page-item ${page === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="loadProfilePosts(${page + 1}); return false;">
                        <i class="bi bi-chevron-right"></i>
                    </a>
                </li>`;
                
                html += '</ul></nav>';
                container.html(html);
            }

            // Make loadProfilePosts available globally for pagination
            window.loadProfilePosts = loadProfilePosts;

            // Open post modal (placeholder - can be enhanced)
            window.openPostModal = function(postId) {
                // TODO: Implement full post modal view
                console.log('Opening post:', postId);
            }

            // Toggle post like
            async function togglePostLike(postId, action) {
                try {
                    const response = await fetch(`/api/posts/${postId}/like`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action })
                    });
                    const data = await response.json();
                    if (data.success) {
                        loadProfilePosts(currentPostsPage);
                    }
                } catch (error) {
                    console.error('Error toggling like:', error);
                }
            }
            
            // Load user's schedules
            async function loadUserSchedules() {
                const container = $('#user-schedules');
                try {
                    const response = await fetch('/api/schedules?limit=5');
                    const data = await response.json();
                    
                    if (!data.success || !data.schedules || data.schedules.length === 0) {
                        container.html(`
                            <div class="text-center p-4 text-muted">
                                <i class="bi bi-calendar-x fs-1 mb-2"></i>
                                <p class="mb-0">No scheduled posts</p>
                            </div>
                        `);
                        return;
                    }
                    
                    container.html(data.schedules.map(schedule => `
                        <div class="recent-post-item">
                            <div class="post-thumbnail d-flex align-items-center justify-content-center" style="background: rgba(255, 193, 7, 0.1);">
                                <i class="bi bi-${schedule.type === 'recurring' ? 'arrow-repeat' : 'calendar-event'} text-warning fs-4"></i>
                            </div>
                            <div class="post-details">
                                <div class="post-text">${schedule.description || schedule.actionData?.prompt || 'Scheduled task'}</div>
                                <div class="post-meta">
                                    <span>
                                        <i class="bi bi-gear me-1"></i>${schedule.actionType || 'generate_image'}
                                    </span>
                                    ${schedule.type === 'recurring' 
                                        ? `<span><i class="bi bi-arrow-repeat me-1"></i>${schedule.cronExpression || 'Recurring'}</span>`
                                        : `<span><i class="bi bi-calendar me-1"></i>${schedule.scheduledFor ? new Date(schedule.scheduledFor).toLocaleDateString() : 'Pending'}</span>`
                                    }
                                    <span class="badge ${schedule.status === 'active' ? 'bg-success' : schedule.status === 'paused' ? 'bg-warning' : 'bg-secondary'}">${schedule.status || 'pending'}</span>
                                </div>
                            </div>
                        </div>
                    `).join(''));
                } catch (error) {
                    console.error('Error loading schedules:', error);
                    container.html(`
                        <div class="text-center p-4 text-muted">
                            <i class="bi bi-exclamation-triangle fs-4 mb-2"></i>
                            <p class="mb-0">Failed to load schedules</p>
                        </div>
                    `);
                }
            }
            
            // Format time ago helper
            function formatTimeAgo(dateString) {
                if (!dateString) return 'Unknown';
                const date = new Date(dateString);
                const now = new Date();
                const seconds = Math.floor((now - date) / 1000);
                
                if (seconds < 60) return 'Just now';
                if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
                if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
                if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;
                return date.toLocaleDateString();
            }

            // Initialize user profile state for content type filtering
            if (typeof window.userProfile === 'undefined') {
                window.userProfile = {
                    contentType: 'SFW', // default to SFW
                    sfwPagination: {
                        currentPage: 0,
                        totalPages: 0
                    },
                    nsfwPagination: {
                        currentPage: 0,
                        totalPages: 0
                    }
                };

                // On first load, clear ALL old caches to prevent mixing
                if (userId && typeof clearAllUserImageCaches === 'function') {
                    clearAllUserImageCaches(userId);
                    console.log('[DEBUG] Initial load - cleared all old caches');
                }
            }

            // Initialize content type toggle for user liked images
            const showNsfwLikes = document.getElementById('showNsfwLikes');
            if (showNsfwLikes) {
                // Set initial state based on current content type
                showNsfwLikes.checked = window.userProfile.contentType === 'NSFW';

                showNsfwLikes.addEventListener('change', function() {
                    const selectedType = this.checked ? 'NSFW' : 'SFW';

                    // If already selected, do nothing
                    if (selectedType === window.userProfile.contentType) {
                        return;
                    }

                    // Update user profile content type
                    window.userProfile.contentType = selectedType;

                    // Clear the loadedImages array to prevent gallery mixing
                    window.loadedImages = [];

                    // Clear ALL user image caches (old cache + SFW + NSFW)
                    // This prevents loading mixed content from old caches
                    if (typeof clearAllUserImageCaches === 'function') {
                        clearAllUserImageCaches(userId);
                        console.log(`[DEBUG] Switched to ${selectedType} - all caches cleared`);
                    }

                    // Clear the images grid and show loading state
                    const imagesGrid = document.getElementById('user-images-gallery');
                    if (imagesGrid) {
                        imagesGrid.innerHTML = `
                            <div class="loading-grid">
                                <div class="loading-item"></div>
                                <div class="loading-item"></div>
                                <div class="loading-item"></div>
                                <div class="loading-item"></div>
                                <div class="loading-item"></div>
                                <div class="loading-item"></div>
                            </div>
                        `;
                    }

                    // Load images for the selected content type
                    if (userId) {
                        loadUserImages(userId, 1, true, false, selectedType);
                    }
                });
            }

            // Load initial data with default SFW content type
            loadUserImages(userId, 1, true, false, window.userProfile.contentType);
        });
    </script>

    <script>
        $(document).ready(function(){
            $(document).on('click', '.open-chat', function(){
                const chatId = $(this).data('id');
                if (window.self !== window.top) {
                    window.parent.postMessage({ event: 'openChat', chatId: chatId }, '*');
                } else {
                    window.location = `/chat/${chatId}`
                }
            });
        });
    </script>

    <script>
        function loadFollowList(type, containerId) {
            const userId = '{{userData._id}}';
            $(`#${containerId}`).html(`
                <div class="followers-loading">
                    <div class="followers-loading-spinner">
                        <i class="bi bi-arrow-repeat"></i>
                    </div>
                    <span>Loading...</span>
                </div>
            `);
            $.get(`/user/${userId}/followers-or-followings?type=${type}&page=1`, function(data) {
                let html = '';
                if (data.users && data.users.length > 0) {
                    data.users.forEach(user => {
                        html += `
                            <a href="/user/${user.userId}" class="follower-item">
                                <div class="follower-avatar-wrapper">
                                    <img src="${user.profilePicture || '/img/avatar.png'}" alt="${user.userName}" class="follower-avatar">
                                </div>
                                <div class="follower-info-content">
                                    <div class="follower-name-row">
                                        <span class="follower-username">${user.userName}</span>
                                    </div>
                                    ${user.userBio ? `<p class="follower-bio">${user.userBio}</p>` : '<p class="follower-bio follower-bio-placeholder">No bio yet</p>'}
                                </div>
                                <div class="follower-action">
                                    <i class="bi bi-chevron-right"></i>
                                </div>
                            </a>
                        `;
                    });
                } else {
                    html = `
                        <div class="followers-empty">
                            <i class="bi bi-people"></i>
                            <span>${type === 'followers' ? 'No followers yet' : 'Not following anyone yet'}</span>
                        </div>
                    `;
                }
                $(`#${containerId}`).html(html);
            }).fail(function() {
                $(`#${containerId}`).html(`
                    <div class="followers-error">
                        <i class="bi bi-exclamation-triangle"></i>
                        <span>Failed to load list. Please try again.</span>
                        <button class="followers-retry-btn" onclick="loadFollowList('${type}', '${containerId}')">
                            <i class="bi bi-arrow-clockwise"></i> Retry
                        </button>
                    </div>
                `);
            });
        }

        $('#followersModal').on('show.bs.modal', function() {
            loadFollowList('followers', 'followers-list');
        });

        $('#followingModal').on('show.bs.modal', function() {
            loadFollowList('following', 'following-list');
        });
    </script>

    <style>
        /* Debug Badge for Content Type */
        .debug-content-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            z-index: 10;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            pointer-events: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .debug-content-badge.sfw {
            background: #10b981;
            color: white;
        }

        .debug-content-badge.nsfw {
            background: #ef4444;
            color: white;
        }

        /* Likes Tab Inline Toggle Row */
        .likes-toggle-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            font-size: 12px;
        }

        .likes-info {
            display: flex;
            align-items: center;
            gap: 6px;
            min-width: 0;
            flex: 1;
            white-space: nowrap;
        }

        .likes-info-text,
        .likes-info-text-short {
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .likes-info-text-short {
            display: none;
        }

        .likes-toggle {
            flex-shrink: 0;
        }

        @media (max-width: 520px) {
            .likes-info-text {
                display: none;
            }

            .likes-info-text-short {
                display: inline;
            }
        }

        footer{display: inline !important;}
        .sticky-bottom{display: inline-block !important;width: 100%;}
        .isLoading .fa-image{
            display: none;
        }
        .isLoading .fa-spin{
            display: inherit !important;
        }
        .avatar{
            object-fit: cover;
            object-position: top;
            width: 32px;
        }
        .card-img-top.girls_avatar {
            object-fit: cover;
            object-position: top;
            width: 100%;  
            margin: auto;
            border-radius: 15px;
            height: 350px;
            padding: 0 5px;  
            background-position: top;
            background-size: cover;
        }
        .swal-image.analyze{
            object-fit: cover;
            object-position: top;
            width: auto !important;
            height: 200px !important;
            border-radius: 6px !important;
        }
        .card-header, .card-footer {
            flex-shrink: 0;
        }
        .card-body {
            flex-grow: 1;
            overflow-y: auto;
            position: relative;
        }
        .chat-contain .card-body{
            width: 100%;
        }
        .character-title{
            font-weight: 600;
            font-size: 16px;
            color: black;
        }
        .character-short-description {
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            font-size: 13px;
        }
        .scroll-horizontal {
            flex-wrap: nowrap;
            width: 100%;
            flex-direction: row;
            overflow-x: scroll;
        }
        @media (max-width: 600px) {
            .chat-contain .card-body{
                width: 100%;
            }
        }
        
        /* ====================================
           FOLLOWERS MODAL STYLES - Modern Native App Design
           ==================================== */
        .followers-modal .modal-dialog {
            max-width: 420px;
            margin: 1rem auto;
        }
        
        .followers-modal-content {
            background: var(--bg-secondary, #1a1a1a);
            border: 1px solid var(--border-color, rgba(255, 255, 255, 0.1));
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        
        .followers-modal-header {
            background: linear-gradient(135deg, var(--primary-color, #8240FF) 0%, #9d5cff 100%);
            border-bottom: none;
            padding: 1.25rem 1.5rem;
            position: relative;
        }
        
        .followers-modal-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        }
        
        .followers-modal-title {
            color: #fff;
            font-weight: 600;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            margin: 0;
        }
        
        .followers-modal-title i {
            font-size: 1.2rem;
        }
        
        .followers-modal-body {
            padding: 0;
            max-height: 60vh;
            overflow-y: auto;
            background: var(--bg-secondary, #1a1a1a);
        }
        
        .followers-modal-body::-webkit-scrollbar {
            width: 4px;
        }
        
        .followers-modal-body::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .followers-modal-body::-webkit-scrollbar-thumb {
            background: var(--primary-color, #8240FF);
            border-radius: 4px;
        }
        
        .followers-list-container {
            display: flex;
            flex-direction: column;
        }
        
        /* Follower Item - Native App Style */
        .follower-item {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            gap: 14px;
            text-decoration: none;
            background: transparent;
            border-bottom: 1px solid var(--border-color, rgba(255, 255, 255, 0.06));
            transition: background 0.2s ease, transform 0.15s ease;
            cursor: pointer;
        }
        
        .follower-item:hover {
            background: rgba(130, 64, 255, 0.1);
            text-decoration: none;
        }
        
        .follower-item:active {
            transform: scale(0.98);
            background: rgba(130, 64, 255, 0.15);
        }
        
        .follower-item:last-child {
            border-bottom: none;
        }
        
        .follower-avatar-wrapper {
            position: relative;
            flex-shrink: 0;
        }
        
        .follower-avatar {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            object-fit: cover;
            object-position: top;
            border: 2px solid var(--primary-color, #8240FF);
            background: var(--bg-tertiary, #252525);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        
        .follower-item:hover .follower-avatar {
            border-color: #9d5cff;
            box-shadow: 0 0 0 3px rgba(130, 64, 255, 0.2);
        }
        
        .follower-info-content {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        
        .follower-name-row {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .follower-username {
            font-weight: 600;
            font-size: 15px;
            color: var(--text-primary, #fff);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .follower-bio {
            font-size: 13px;
            color: var(--text-secondary, #b0b0b0);
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.4;
        }
        
        .follower-bio-placeholder {
            font-style: italic;
            color: var(--text-muted, #6c757d);
        }
        
        .follower-action {
            flex-shrink: 0;
            color: var(--text-muted, #6c757d);
            transition: color 0.2s ease, transform 0.2s ease;
        }
        
        .follower-item:hover .follower-action {
            color: var(--primary-color, #8240FF);
            transform: translateX(3px);
        }
        
        /* Loading State */
        .followers-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 48px 24px;
            gap: 12px;
            color: var(--text-secondary, #b0b0b0);
        }
        
        .followers-loading-spinner {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .followers-loading-spinner i {
            font-size: 24px;
            color: var(--primary-color, #8240FF);
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Empty State */
        .followers-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 48px 24px;
            gap: 12px;
            color: var(--text-secondary, #b0b0b0);
        }
        
        .followers-empty i {
            font-size: 48px;
            color: var(--text-muted, #6c757d);
            opacity: 0.5;
        }
        
        .followers-empty span {
            font-size: 15px;
            text-align: center;
        }
        
        /* Error State */
        .followers-error {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 48px 24px;
            gap: 12px;
            color: var(--text-secondary, #b0b0b0);
        }
        
        .followers-error i {
            font-size: 36px;
            color: var(--danger-color, #ff4040);
        }
        
        .followers-error span {
            font-size: 14px;
            text-align: center;
        }
        
        .followers-retry-btn {
            margin-top: 8px;
            padding: 8px 20px;
            background: var(--primary-color, #8240FF);
            color: #fff;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s ease, transform 0.15s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .followers-retry-btn:hover {
            background: #9d5cff;
            transform: translateY(-1px);
        }
        
        .followers-retry-btn:active {
            transform: translateY(0) scale(0.98);
        }
        
        /* Responsive adjustments */
        @media (max-width: 480px) {
            .followers-modal .modal-dialog {
                margin: 0.5rem;
                max-width: calc(100% - 1rem);
            }
            
            .followers-modal-content {
                border-radius: 16px;
            }
            
            .follower-item {
                padding: 12px 14px;
            }
            
            .follower-avatar {
                width: 46px;
                height: 46px;
            }
            
            .follower-username {
                font-size: 14px;
            }
            
            .follower-bio {
                font-size: 12px;
            }
        }
        
        /* Posts Tab Styles - Recent Posts Design */
        .recent-posts-list,
        .schedules-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .recent-post-item {
            display: flex;
            gap: 12px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            margin-bottom: 10px;
            transition: background 0.2s;
        }

        .recent-post-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .recent-post-item .post-thumbnail {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            overflow: hidden;
            flex-shrink: 0;
            background: rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .recent-post-item .post-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .recent-post-item .post-details {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .recent-post-item .post-text {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.85);
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            line-height: 1.4;
        }

        .recent-post-item .post-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
            flex-wrap: wrap;
        }

        .recent-post-item .post-platforms {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .recent-post-item .platform-badge {
            display: inline-flex;
            align-items: center;
            color: rgba(255, 255, 255, 0.7);
        }

        .recent-post-item .post-time {
            display: flex;
            align-items: center;
        }

        .recent-post-item .badge {
            font-size: 10px;
            padding: 2px 6px;
        }
        
        .posts-section,
        .schedules-section {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid rgba(130, 64, 255, 0.1);
        }

        /* Phase 1: Profile Posts Grid Styles */
        .posts-controls {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 12px 16px;
            border: 1px solid rgba(130, 64, 255, 0.1);
        }

        .posts-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 4px;
        }

        @media (max-width: 768px) {
            .posts-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .post-card {
            position: relative;
            aspect-ratio: 1;
            overflow: hidden;
            border-radius: 4px;
            cursor: pointer;
            background: rgba(0, 0, 0, 0.2);
        }

        .post-card .post-media {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .post-card .post-media img,
        .post-card .post-media video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .post-card .post-media.nsfw-blur img,
        .post-card .post-media.nsfw-blur video {
            filter: blur(20px);
        }

        .post-card .video-indicator {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .post-card .visibility-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            background: rgba(130, 64, 255, 0.8);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }

        .post-card .nsfw-badge {
            position: absolute;
            bottom: 8px;
            left: 8px;
            background: rgba(220, 53, 69, 0.9);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
        }

        .post-card .post-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .post-card:hover .post-overlay {
            opacity: 1;
        }

        .post-card .post-stats {
            display: flex;
            gap: 16px;
            color: white;
            font-size: 14px;
            font-weight: 600;
        }

        .post-card .post-stats span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .profile-posts-section {
            min-height: 200px;
        }

        /* Form check styling */
        .form-check-input:checked {
            background-color: #8240FF;
            border-color: #8240FF;
        }

        .form-check-label {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
        }
        
        /* ========================================
           CREATOR PROFILE ENHANCEMENTS
           ======================================== */
        
        /* Creator Header Styles */
        .creator-profile .profile-header.creator-header {
            background: transparent;
        }
        
        .creator-cover {
            background-size: cover !important;
            background-position: center !important;
            position: relative;
        }
        
        .cover-gradient-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to bottom, 
                rgba(0,0,0,0.1) 0%, 
                rgba(0,0,0,0.3) 50%,
                rgba(0,0,0,0.7) 100%);
            z-index: 0;
        }
        
        .cover-edit-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 10;
            background: rgba(0, 0, 0, 0.5);
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(4px);
        }
        
        .cover-edit-btn:hover {
            background: rgba(130, 64, 255, 0.8);
            transform: scale(1.1);
        }
        
        /* Creator Verified Badge on Avatar */
        .creator-verified-badge {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: #4CAF50;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        /* Creator Category Badge */
        .creator-category-badge {
            display: inline-block;
            background: linear-gradient(90.9deg, #D2B8FF 2.74%, #8240FF 102.92%);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-top: 8px;
        }
        
        /* Creator Social Links */
        .creator-social-links {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 15px;
        }
        
        .social-link {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            color: white;
            text-decoration: none;
            transition: all 0.3s ease;
            backdrop-filter: blur(4px);
        }
        
        .social-link:hover {
            background: rgba(130, 64, 255, 0.8);
            transform: translateY(-3px);
            color: white;
        }
        
        /* Action Button Variants */
        .action-btn-gradient {
            background: linear-gradient(90.9deg, #D2B8FF 2.74%, #8240FF 102.92%);
            color: white;
            border: none;
        }
        
        .action-btn-gradient:hover {
            background: linear-gradient(90.9deg, #E0C8FF 2.74%, #9050FF 102.92%);
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(130, 64, 255, 0.3);
        }
        
        .become-creator-btn i,
        .subscribe-btn i {
            color: #FFD700;
        }
        
        .my-profile-actions {
            display: flex !important;
        }
        
        /* Creator Profile Avatar Container */
        .creator-profile .profile-avatar-container {
            position: relative;
        }
        
        /* Responsive Creator Styles */
        @media (max-width: 768px) {
            .creator-social-links {
                gap: 8px;
            }
            
            .social-link {
                width: 36px;
                height: 36px;
                font-size: 0.9rem;
            }
            
            .cover-edit-btn {
                top: 10px;
                right: 10px;
                width: 38px;
                height: 38px;
            }
        }
    </style>
    
    {{!-- Cover Image Input for Creators --}}
    {{#if isCreator}}
    {{#if (or isMyProfile isAdmin)}}
    <input type="file" id="coverImageInput" name="coverImage" accept="image/*" style="display: none;">
    <script>
        // Cover image upload functionality
        $(document).ready(function() {
            const editCoverBtn = document.getElementById('editCoverBtn');
            const coverImageInput = document.getElementById('coverImageInput');
            
            if (editCoverBtn && coverImageInput) {
                editCoverBtn.addEventListener('click', function() {
                    coverImageInput.click();
                });
                
                coverImageInput.addEventListener('change', async function(e) {
                    if (this.files && this.files[0]) {
                        const file = this.files[0];
                        
                        // Validate file type
                        if (!file.type.startsWith('image/')) {
                            if (typeof Swal !== 'undefined') {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Invalid File',
                                    text: 'Please select an image file.',
                                    confirmButtonColor: '#8240FF'
                                });
                            }
                            return;
                        }
                        
                        // Show loading
                        if (typeof Swal !== 'undefined') {
                            Swal.fire({
                                title: 'Uploading...',
                                text: 'Please wait while we upload your cover image.',
                                allowOutsideClick: false,
                                didOpen: () => {
                                    Swal.showLoading();
                                }
                            });
                        }
                        
                        try {
                            const formData = new FormData();
                            formData.append('coverImage', file);
                            
                            const response = await fetch('/api/creators/cover-image', {
                                method: 'POST',
                                body: formData
                            });
                            
                            const result = await response.json();
                            
                            if (result.success) {
                                // Update the cover image
                                const coverDiv = document.querySelector('.creator-cover');
                                if (coverDiv) {
                                    coverDiv.style.backgroundImage = `url('${result.coverImage}')`;
                                }
                                
                                if (typeof Swal !== 'undefined') {
                                    Swal.fire({
                                        icon: 'success',
                                        title: 'Success!',
                                        text: 'Cover image updated successfully.',
                                        confirmButtonColor: '#8240FF'
                                    });
                                }
                            } else {
                                throw new Error(result.error || 'Upload failed');
                            }
                        } catch (error) {
                            console.error('Cover upload error:', error);
                            if (typeof Swal !== 'undefined') {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Upload Failed',
                                    text: error.message || 'Failed to upload cover image.',
                                    confirmButtonColor: '#8240FF'
                                });
                            }
                        }
                    }
                });
            }
        });
    </script>
    {{/if}}
    {{/if}}
    
    {{#if isCreator}}
    {{#unless isMyProfile}}
    <!-- Subscribe Modal -->
    <div class="modal fade" id="subscribeModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-white border-secondary">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">
                        <i class="bi bi-star me-2"></i>{{translations.subscriptions.subscribeTo}} {{default creatorData.displayName userData.nickname}}
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="subscribeTierOptions" class="subscribe-modal">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        {{translations.subscriptions.cancel}}
                    </button>
                    <button type="button" class="btn btn-primary" id="confirmSubscribeBtn" disabled>
                        <i class="bi bi-star-fill me-1"></i>{{translations.subscriptions.subscribe}}
                    </button>
                </div>
            </div>
        </div>
    </div>
    {{/unless}}
    {{/if}}

    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.19.0/js/md5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    
    <!-- Core Scripts -->
    <script src="/js/chat-list.js"></script>
    <script src="/js/favorites.js"></script>
    <script src="/js/character-infos.js"></script>
    <script src="/js/dashboard-category.js"></script>
    <script src="/js/social-connections.js"></script>
    <script src="/js/chat-tool-swiper.js"></script>
    
    <!-- Module Scripts -->
    <script src="/js/modules/ui-helpers.js"></script>
    <script src="/js/modules/chat-filters.js"></script>
    <script src="/js/modules/popular-chats.js"></script>
    <script src="/js/modules/latest-chats.js"></script>
    <script src="/js/modules/checkout.js"></script>
    
    <!-- Subscriptions -->
    <script src="/js/subscriptions.js"></script>
    <script>
        // Subscribe button handler
        const creatorId = '{{userData._id}}';
        let selectedTierId = null;
        let creatorTiers = [];
        
        async function handleSubscribe(button) {
            // Check if user is logged in
            const isLoggedIn = '{{user._id}}' !== '';
            
            if (!isLoggedIn) {
                window.location.href = '/login?redirect=/user/' + creatorId;
                return;
            }
            
            // Check if already subscribed
            try {
                const checkResponse = await fetch(`/api/subscriptions/check/${creatorId}`);
                const checkData = await checkResponse.json();
                
                if (checkData.isSubscribed) {
                    if (typeof Swal !== 'undefined') {
                        Swal.fire({
                            icon: 'info',
                            title: '{{translations.subscriptions.alreadySubscribed}}',
                            text: `You're already subscribed with the ${checkData.subscription?.tier?.name || 'current'} tier.`,
                            confirmButtonColor: '#8240FF',
                            showCancelButton: true,
                            cancelButtonText: 'OK',
                            confirmButtonText: 'Manage Subscriptions'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                window.location.href = '/subscriptions';
                            }
                        });
                    }
                    return;
                }
            } catch (error) {
                console.error('Error checking subscription:', error);
            }
            
            // Load tiers and show modal
            await loadCreatorTiers();
            new bootstrap.Modal(document.getElementById('subscribeModal')).show();
        }
        
        async function loadCreatorTiers() {
            const container = document.getElementById('subscribeTierOptions');
            
            try {
                const response = await fetch(`/api/tiers/creator/${creatorId}`);
                const data = await response.json();
                
                if (data.success && data.tiers && data.tiers.length > 0) {
                    creatorTiers = data.tiers;
                    renderTierOptions();
                } else {
                    container.innerHTML = `
                        <div class="text-center py-4 text-muted">
                            <i class="bi bi-info-circle fs-1 mb-2"></i>
                            <p>This creator hasn't set up subscription tiers yet.</p>
                        </div>
                    `;
                    document.getElementById('confirmSubscribeBtn').disabled = true;
                }
            } catch (error) {
                console.error('Error loading tiers:', error);
                container.innerHTML = `
                    <div class="text-center py-4 text-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>Failed to load tiers
                    </div>
                `;
            }
        }
        
        function renderTierOptions() {
            const container = document.getElementById('subscribeTierOptions');
            
            container.innerHTML = creatorTiers.map(tier => `
                <div class="tier-option ${tier.isFree ? 'free' : ''}" data-tier-id="${tier._id}" onclick="selectTier('${tier._id}')">
                    <div class="d-flex align-items-center gap-3">
                        <div class="tier-radio"></div>
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fw-bold text-white">${escapeHtml(tier.name)}</span>
                                <span class="fw-bold ${tier.isFree ? 'text-muted' : 'text-primary'}">
                                    ${tier.isFree ? '{{translations.subscriptions.free}}' : formatPrice(tier.price, tier.currency)}
                                </span>
                            </div>
                            <p class="mb-2 small text-muted">${escapeHtml(tier.description || '')}</p>
                            ${tier.benefits && tier.benefits.length > 0 ? `
                                <ul class="list-unstyled mb-0 small">
                                    ${tier.benefits.slice(0, 3).map(b => `
                                        <li class="text-muted">
                                            <i class="bi bi-check text-success me-1"></i>${escapeHtml(b)}
                                        </li>
                                    `).join('')}
                                    ${tier.benefits.length > 3 ? `<li class="text-muted">+ ${tier.benefits.length - 3} more</li>` : ''}
                                </ul>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Auto-select free tier if exists
            const freeTier = creatorTiers.find(t => t.isFree);
            if (freeTier) {
                selectTier(freeTier._id);
            }
        }
        
        function selectTier(tierId) {
            selectedTierId = tierId;
            
            document.querySelectorAll('.tier-option').forEach(option => {
                option.classList.toggle('selected', option.dataset.tierId === tierId);
            });
            
            document.getElementById('confirmSubscribeBtn').disabled = false;
        }
        
        document.getElementById('confirmSubscribeBtn')?.addEventListener('click', async function() {
            if (!selectedTierId) {
                alert('Please select a tier');
                return;
            }
            
            const tier = creatorTiers.find(t => t._id === selectedTierId);
            this.disabled = true;
            this.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Processing...';
            
            try {
                if (tier.isFree || tier.price === 0) {
                    // Free subscription
                    const response = await fetch('/api/subscriptions/free', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            creatorId: creatorId,
                            tierId: selectedTierId
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        bootstrap.Modal.getInstance(document.getElementById('subscribeModal')).hide();
                        if (typeof Swal !== 'undefined') {
                            Swal.fire({
                                icon: 'success',
                                title: '{{translations.subscriptions.subscriptionSuccess}}',
                                text: `You're now subscribed to ${tier.name} tier!`,
                                confirmButtonColor: '#8240FF'
                            }).then(() => {
                                window.location.reload();
                            });
                        } else {
                            window.location.reload();
                        }
                    } else {
                        throw new Error(data.error || 'Failed to subscribe');
                    }
                } else {
                    // Paid subscription - redirect to checkout
                    const response = await fetch('/api/subscriptions/checkout', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            creatorId: creatorId,
                            tierId: selectedTierId
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success && data.url) {
                        window.location.href = data.url;
                    } else {
                        throw new Error(data.error || 'Failed to create checkout session');
                    }
                }
            } catch (error) {
                console.error('Error subscribing:', error);
                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        icon: 'error',
                        title: '{{translations.subscriptions.subscriptionFailed}}',
                        text: error.message,
                        confirmButtonColor: '#8240FF'
                    });
                } else {
                    alert('Failed to subscribe: ' + error.message);
                }
            } finally {
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-star-fill me-1"></i>{{translations.subscriptions.subscribe}}';
            }
        });
        
        // Utility functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }
        
        function formatPrice(priceInCents, currency) {
            const symbols = { USD: '$', EUR: '', JPY: '', GBP: '' };
            const symbol = symbols[currency] || currency;
            
            if (currency === 'JPY') {
                return `${symbol}${priceInCents}/mo`;
            }
            return `${symbol}${(priceInCents / 100).toFixed(2)}/mo`;
        }
    </script>
</body>
</html>