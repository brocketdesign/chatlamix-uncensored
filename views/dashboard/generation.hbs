<!DOCTYPE html>
<html lang="{{lang}}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    {{#if lang}}
    <meta http-equiv="content-language" content="{{lang}}">
    {{/if}}
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1a1a1a">
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" href="/img/logo.webp" type="image/webp">
    <title>{{#if seoTitle}}{{seoTitle}}{{else}}AI Generation Dashboard{{/if}}</title>
    
    <!-- Core CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <link href="/css/dashboard-generation.css" rel="stylesheet">
    <link href="/css/civitai-model-search.css" rel="stylesheet">
</head>
<body>
    <!-- ====================================================================
         UNIFIED GENERATION DASHBOARD
         Mobile-first, chat-style interface for image and video generation
         ==================================================================== -->
    <div class="gen-dashboard">
        
        <!-- ================================================================
             TOP CONTROL BAR - Fixed
             ================================================================ -->
        <header class="gen-top-bar">
            <div class="gen-top-bar-content">
                <!-- Logo Button - Links to Dashboard -->
                <a href="/dashboard" class="gen-logo-btn" title="Go to Dashboard">
                    <i class="bi bi-chat-heart-fill"></i>
                </a>
                
                <!-- Mode Selector (Image / Video) -->
                <div class="gen-mode-selector">
                    <button class="gen-mode-btn active" data-mode="image" title="{{#if translations.generation}}{{translations.generation.image}}{{else}}Image{{/if}}">
                        <i class="bi bi-images"></i>
                    </button>
                    <button class="gen-mode-btn" data-mode="video" title="{{#if translations.generation}}{{translations.generation.video}}{{else}}Video{{/if}}">
                        <i class="bi bi-film"></i>{{#ifNotEquals user.subscriptionStatus "active"}}<i class="bi bi-gem" style="font-size:0.6em;color:#a78bfa;margin-left:2px;"></i>{{/ifNotEquals}}
                    </button>
                </div>
                
                <!-- Model Selector Button -->
                <button class="gen-model-selector" type="button">
                    <div class="model-icon">
                        <i class="bi bi-cpu"></i>
                    </div>
                    <span class="model-name">Select Model</span>
                    <i class="bi bi-chevron-down model-chevron"></i>
                </button>
            </div>
        </header>
        
        <!-- ================================================================
             MAIN CONTENT AREA - Scrollable Feed
             ================================================================ -->
        <main class="gen-main-content">
            <div class="gen-content-inner">
                <!-- Empty State -->
                <div class="gen-empty-state">
                    <div class="empty-icon">
                        <i class="bi bi-images"></i>
                    </div>
                    <h3>{{#if translations.generation}}{{translations.generation.readyToCreate}}{{else}}Ready to create{{/if}}</h3>
                    <p>{{#if translations.generation}}{{translations.generation.enterPromptHint}}{{else}}Enter a prompt below to generate your first creation{{/if}}</p>
                </div>
                
                <!-- Results will be dynamically inserted here -->
            </div>
        </main>
        
        <!-- ================================================================
             BOTTOM PROMPT BAR - Fixed, Chat Input Style
             ================================================================ -->
        <footer class="gen-bottom-bar">
            <div class="gen-bottom-bar-content">
                <!-- Cost Display -->
                <div class="gen-cost-display">
                    <span class="cost-label">{{#if translations.generation}}{{translations.generation.generationCost}}{{else}}Generation Cost{{/if}}</span>
                    <span class="cost-value">
                        <i class="bi bi-coin"></i>
                        <span id="costAmount">{{imageCostPerUnit}}</span> points
                    </span>
                </div>
                
                <!-- Tool Icons Row -->
                <div class="gen-tools-row">
                    <!-- Image Upload (for img2img / i2v) -->
                    <button class="gen-tool-btn" data-tool="upload-base" title="Upload base image">
                        <i class="bi bi-image"></i>
                        <span>{{#if translations.generation}}{{translations.generation.baseImage}}{{else}}Base Image{{/if}}</span>
                    </button>
                    
                    <!-- Face Upload (for face merge) -->
                    <button class="gen-tool-btn" data-tool="upload-face" title="Upload face image">
                        <i class="bi bi-person-bounding-box"></i>
                        <span>{{#if translations.generation}}{{translations.generation.face}}{{else}}Face{{/if}}</span>
                    </button>
                    
                    <!-- Aspect Ratio (Image mode) -->
                    <button class="gen-tool-btn" data-tool="aspect-ratio" title="Aspect ratio">
                        <i class="bi bi-aspect-ratio"></i>
                        <span>1:1</span>
                    </button>
                    
                    <!-- Image Count (Image mode) -->
                    <button class="gen-tool-btn" data-tool="image-count" title="Number of images">
                        <i class="bi bi-grid-3x3"></i>
                        <span>1x</span>
                    </button>
                    
                    <!-- Duration (Video mode) -->
                    <button class="gen-tool-btn gen-hidden" data-tool="duration" title="Video duration">
                        <i class="bi bi-clock"></i>
                        <span>5s</span>
                    </button>
                    
                    <!-- Video Upload (for video face merge) -->
                    <button class="gen-tool-btn gen-hidden" data-tool="upload-video" title="Upload video">
                        <i class="bi bi-camera-video"></i>
                        <span>{{#if translations.generation}}{{translations.generation.sourceVideo}}{{else}}Video{{/if}}</span>
                    </button>
                    
                    <!-- Advanced Settings -->
                    <button class="gen-tool-btn" data-tool="settings" title="Settings">
                        <i class="bi bi-sliders"></i>
                    </button>
                </div>
                
                <!-- Prompt Input Area -->
                <div class="gen-prompt-area">
                    <textarea class="gen-prompt-input" 
                              placeholder="{{#if translations.generation}}{{translations.generation.promptPlaceholder}}{{else}}Describe what you want to create...{{/if}}"
                              rows="1"></textarea>
                    <button class="gen-submit-btn" type="button" disabled>
                        <i class="bi bi-arrow-up"></i>
                    </button>
                </div>
            </div>
        </footer>
        
        <!-- ================================================================
             OVERLAYS
             ================================================================ -->
        
        <!-- Overlay Backdrop -->
        <div class="gen-overlay-backdrop"></div>
        
        <!-- Model Selection Bottom Sheet -->
        <div class="gen-bottom-sheet" id="modelSheet">
            <div class="gen-bottom-sheet-handle"></div>
            <div class="gen-bottom-sheet-header">
                <h3>{{#if translations.generation}}{{translations.generation.selectModel}}{{else}}Select Model{{/if}}</h3>
                <p>{{#if translations.generation}}{{translations.generation.selectModelDesc}}{{else}}Choose an AI model for generation{{/if}}</p>
            </div>
            <div class="gen-bottom-sheet-body">
                <!-- Models will be rendered here dynamically -->
            </div>
        </div>
        
        <!-- Settings Bottom Sheet -->
        <div class="gen-bottom-sheet" id="settingsSheet">
            <div class="gen-bottom-sheet-handle"></div>
            <div class="gen-bottom-sheet-header">
                <h3>{{#if translations.generation}}{{translations.generation.settings}}{{else}}Settings{{/if}}</h3>
                <p>{{#if translations.generation}}{{translations.generation.settingsDesc}}{{else}}Configure generation parameters{{/if}}</p>
            </div>
            <div class="gen-bottom-sheet-body">
                <!-- Settings will be rendered here dynamically -->
            </div>
        </div>
        
        <!-- Full Screen Preview Overlay -->
        <div class="gen-preview-overlay">
            <div class="gen-preview-header">
                <button class="gen-preview-close" type="button">
                    <i class="bi bi-x-lg"></i>
                </button>
                <div></div>
            </div>
            <div class="gen-preview-content">
                <!-- Preview media will be inserted here -->
            </div>
            <div class="gen-preview-footer">
                <!-- Footer will be dynamically populated -->
            </div>
        </div>
    </div>
    
    <!-- Create Character Modal -->
    <div class="modal fade" id="createCharacterModal" tabindex="-1" aria-labelledby="createCharacterModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content" style="background: #1a1a1a; border: 1px solid rgba(255,255,255,0.1);">
                <div class="modal-header border-0">
                    <h5 class="modal-title text-white" id="createCharacterModalLabel">
                        <i class="bi bi-person-plus me-2"></i>Create Character
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <img id="characterPreviewImage" src="" alt="Character Preview" 
                             style="max-height: 200px; border-radius: 12px; object-fit: cover;">
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-white">Prompt Used</label>
                        <p id="characterPromptPreview" class="text-muted small" style="max-height: 80px; overflow: auto;"></p>
                    </div>
                    <div class="mb-3">
                        <label for="characterNameInput" class="form-label text-white">Character Name (optional)</label>
                        <input type="text" class="form-control bg-dark text-white border-secondary" id="characterNameInput" 
                               placeholder="Leave empty to auto-generate">
                    </div>
                    <div class="mb-3">
                        <label for="characterPersonalityInput" class="form-label text-white">Personality Description (optional)</label>
                        <textarea class="form-control bg-dark text-white border-secondary" id="characterPersonalityInput" rows="2"
                                  placeholder="Describe the character's personality..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="characterLanguageSelect" class="form-label text-white">Language</label>
                        <select class="form-select bg-dark text-white border-secondary" id="characterLanguageSelect">
                            <option value="english">English</option>
                            <option value="japanese">Japanese</option>
                        </select>
                    </div>
                    <div class="mb-3" id="characterImageModelSection" style="display: none;">
                        <label for="characterImageModelSelect" class="form-label text-white">
                            <i class="bi bi-palette me-1"></i>Text-to-Image Model
                        </label>
                        <select class="form-select bg-dark text-white border-secondary" id="characterImageModelSelect">
                            <!-- Options will be populated dynamically -->
                        </select>
                        <small class="form-text text-muted d-block mt-1">
                            Select a model for generating images in character chat
                        </small>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="characterNsfwCheck">
                        <label class="form-check-label text-white" for="characterNsfwCheck">
                            Mark as NSFW
                        </label>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="useImageAsBaseFaceCheck">
                        <label class="form-check-label text-white" for="useImageAsBaseFaceCheck">
                            Use this image as base face for generation
                        </label>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="confirmCreateCharacterBtn" onclick="genDashboard.confirmCreateCharacter()">
                        <i class="bi bi-person-plus me-1"></i>Create Character
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Create Post Modal -->
    <div class="modal fade" id="createPostModal" tabindex="-1" aria-labelledby="createPostModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content" style="background: #1a1a1a; border: 1px solid rgba(255,255,255,0.1);">
                <div class="modal-header border-0">
                    <h5 class="modal-title text-white" id="createPostModalLabel">
                        <i class="bi bi-file-earmark-plus me-2"></i>Create Draft Post
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="post-media-preview mb-3 text-center">
                        <!-- Media will be inserted here -->
                    </div>
                    <div class="mb-3">
                        <label for="postCaption" class="form-label text-white">Caption</label>
                        <textarea class="form-control bg-dark text-white border-secondary" id="postCaption" rows="5" 
                                  placeholder="Enter a caption for your post..."></textarea>
                        <small class="text-muted">A caption will be auto-generated if left empty</small>
                    </div>
                    <div class="row g-2 mb-3">
                        <div class="col-md-6">
                            <label class="form-label text-white small">Style</label>
                            <select class="form-select form-select-sm bg-dark text-white border-secondary" id="postCaptionStyle">
                                <option value="engaging" selected>Engaging</option>
                                <option value="casual">Casual</option>
                                <option value="professional">Professional</option>
                                <option value="funny">Funny</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-white small">Language</label>
                            <select class="form-select form-select-sm bg-dark text-white border-secondary" id="postCaptionLanguage">
                                <option value="english">üá¨üáß English</option>
                                <option value="japanese">üáØüáµ Êó•Êú¨Ë™û</option>
                                <option value="french">üá´üá∑ Fran√ßais</option>
                                <option value="portuguese">üáßüá∑ Portugu√™s</option>
                                <option value="spanish">üá™üá∏ Espa√±ol</option>
                                <option value="chinese">üá®üá≥ ‰∏≠Êñá</option>
                                <option value="korean">üá∞üá∑ ÌïúÍµ≠Ïñ¥</option>
                                <option value="thai">üáπüá≠ ‡πÑ‡∏ó‡∏¢</option>
                                <option value="german">üá©üá™ Deutsch</option>
                                <option value="italian">üáÆüáπ Italiano</option>
                                <option value="russian">üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
                                <option value="hindi">üáÆüá≥ ‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
                            </select>
                        </div>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-outline-info btn-sm" id="generatePostCaptionBtn" onclick="genDashboard.generateDraftCaption()">
                            <i class="bi bi-magic me-1"></i>Generate Caption with AI
                        </button>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmCreatePostBtn" onclick="genDashboard.confirmCreatePost()">
                        <i class="bi bi-check me-1"></i>Save as Draft
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Reset modal when hidden
        document.getElementById('createPostModal')?.addEventListener('hidden.bs.modal', function() {
            document.getElementById('postCaption').value = '';
            document.getElementById('postCaption').disabled = false;
            document.getElementById('generatePostCaptionBtn').disabled = false;
            const btn = document.getElementById('confirmCreatePostBtn');
            btn.textContent = '';
            btn.innerHTML = '<i class="bi bi-check me-1"></i>Save as Draft';
            btn.disabled = false;
            btn.onclick = () => genDashboard.confirmCreatePost();
            btn.classList.remove('btn-success');
            btn.classList.add('btn-primary');
        });
    </script>
    
    <!-- Hidden File Inputs -->
    <input type="file" id="baseImageInput" accept="image/*" style="display: none;">
    <input type="file" id="faceImageInput" accept="image/*" style="display: none;">
    <input type="file" id="targetImageInput" accept="image/*" style="display: none;">
    <input type="file" id="baseVideoInput" accept="video/*" style="display: none;">
    
    <!-- Civitai Model Search Modal -->
    <div class="modal fade" id="civitaiSearchModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content" style="background: #1a1a1a; border: 1px solid rgba(255,255,255,0.1);">
                <div class="modal-header border-0">
                    <h5 class="modal-title text-white">
                        <i class="bi bi-search me-2"></i>Search Custom Models
                    </h5>
                    <button type="button" class="btn-close btn-close-white" id="closeImageModelSearchModal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <div class="input-group">
                            <input type="text" 
                                class="form-control bg-dark text-white border-secondary" 
                                id="civitaiModalSearch" 
                                placeholder="Search for Stable Diffusion models..."
                                autocomplete="off">
                            <button class="btn btn-primary" type="button" id="civitaiModalSearchBtn">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                        <small class="text-muted">Search for text-to-image models from Civitai</small>
                    </div>
                    
                    <!-- Search Results -->
                    <div id="civitaiSearchResults">
                        <div class="text-center text-muted py-4" id="civitaiSearchPlaceholder">
                            <i class="bi bi-box-seam fs-1 d-block mb-2"></i>
                            <p>Enter a search term to find custom models</p>
                        </div>
                        <div class="text-center py-4 d-none" id="civitaiSearchLoading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 text-muted">Searching for models...</p>
                        </div>
                        <div id="civitaiSearchResultsList"></div>
                        <div class="text-center py-4 d-none" id="civitaiNoResults">
                            <i class="bi bi-emoji-frown fs-1 d-block mb-2 text-muted"></i>
                            <p class="text-muted">No models found</p>
                            <small class="text-muted">Try a different search term</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Plan Upgrade Modal -->
    <div class="modal fade" id="planUpgradeModal" tabindex="-1" aria-labelledby="planUpgradeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable mx-0">
            <div class="modal-content mx-auto">
                <div class="modal-header">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    <h5 class="modal-title" id="planUpgradeModalLabel">{{#if translations.plan_page}}{{translations.plan_page.premium}}{{else}}Premium{{/if}}</h5>
                </div>
                <div class="modal-body m-0 p-0 position-relative">
                    <div id="plan-container"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Configuration Script -->
    <script>
        // Pass server-side configuration to JavaScript
        window.GEN_DASHBOARD_CONFIG = {
            userPoints: {{userPoints}},
            imageCostPerUnit: {{imageCostPerUnit}},
            videoCostPerUnit: {{videoCostPerUnit}},
            faceMergeCost: {{faceMergeCost}},
            imageModels: {{{json imageModels}}},
            videoModels: {{{json videoModels}}}
        };
        
        // User data for custom model search
        window.user = {{{json user}}};
        window.translations = {{{json translations}}};
    </script>
    
    <!-- Core Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="/js/civitai-model-search.js"></script>
    <script>
        // Plan page loader for premium gating
        var _planLoading = false;
        function loadPlanPage() {
            if (!window.user) {
                console.log('User is not logged in, cannot load plan page.');
                return;
            }
            if (_planLoading) return;
            _planLoading = true;

            var planModalEl = document.getElementById('planUpgradeModal');
            if (!planModalEl) { _planLoading = false; return; }

            var planModal = new bootstrap.Modal(planModalEl);
            $('#plan-container').html('<div class="position-absolute d-flex justify-content-center align-items-center" style="inset:0;"><div class="spinner-border" role="status"></div></div>');
            planModal.show();

            $.ajax({
                url: '/my-plan',
                method: 'GET',
                xhrFields: { withCredentials: true },
                success: function(data) {
                    $('#plan-container').html(data);
                    var script = document.createElement('script');
                    script.src = '/js/plan.js';
                    script.onload = function() { _planLoading = false; };
                    script.onerror = function() { _planLoading = false; };
                    document.body.appendChild(script);
                },
                error: function() {
                    console.error('Failed to load plan page');
                    _planLoading = false;
                }
            });
        }
    </script>
    <script src="/js/dashboard-generation.js"></script>
    <style>
        .site-footer{ display: none !important; }
    </style>
    {{> dashboard-footer}}
</body>
</html>
