<!-- User Points Modal -->
<div class="modal fade" id="userPointsModal" tabindex="-1" aria-labelledby="userPointsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content mx-auto">
            <div class="modal-header">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                <h5 class="modal-title" id="userPointsModalLabel">{{userPointsTranslations.points.title}}</h5>
            </div>
            <div class="modal-body p-0">
                <!-- Current Points Balance Section -->
                <div class="points-container mx-3">
                    <div class="points-balance text-center">
                        <div class="d-flex align-items-center justify-content-center mb-2">
                            <i class="bi bi-coin points-icon me-2" style="font-size: 1.5rem;"></i>
                            <h2 class="user-points-balance mb-0" style="font-size: 2.5rem; font-weight: bold;">{{user.points}}</h2>
                        </div>
                        <div class="points-label" style="opacity: 0.9;">{{userPointsTranslations.points.balance}}</div>
                    </div>
                    
                    <!-- Daily Bonus Section -->
                    <div class="daily-bonus">
                        <div class="daily-bonus-header">
                            <div>
                                <strong>{{userPointsTranslations.points.daily_bonus}}</strong>
                                <div class="streak-counter mt-1">0 {{userPointsTranslations.points.days}}</div>
                            </div>
                            <button class="bonus-btn">{{userPointsTranslations.points.claim_bonus}}</button>
                        </div>
                    </div>
                </div>
                
                <!-- First Login Bonus Section (for subscribers) -->
                <div class="first-login-bonus is-subscriber mx-3 mt-3" style="display:none;">
                    <div class="card border-warning">
                        <div class="card-body text-center">
                        <i class="bi bi-crown-fill text-warning fs-1"></i>
                        <h5 class="card-title mt-2">{{userPointsTranslations.subscriber_bonus.title}}</h5>
                        <p class="card-text">{{userPointsTranslations.subscriber_bonus.description}}</p>
                        <button class="btn btn-warning first-login-bonus-btn">
                            <i class="bi bi-crown me-2"></i>{{userPointsTranslations.subscriber_bonus.claim_button}}
                        </button>
                        </div>
                    </div>
                </div>

                <!-- Admin Debug Section -->
                {{#if isAdmin}}
                <div class="bg-dark bg-opacity-10 border-top border-warning p-3 m-3" style="border-radius: 1rem;">
                    <div class="d-flex align-items-center mb-3">
                        <i class="bi bi-tools me-2 text-warning"></i>
                        <h6 class="mb-0 text-warning">{{userPointsTranslations.points.admin.manage_points}} (Debug)</h6>
                    </div>
                    <div class="row g-2">
                        <div class="col-md-3">
                            <label class="form-label small">{{userPointsTranslations.points.admin.amount}}</label>
                            <input type="number" class="form-control form-control-sm" id="adminPointsAmount" placeholder="0" min="0" step="1">
                        </div>
                        <div class="col-md-5">
                            <label class="form-label small">{{userPointsTranslations.points.admin.reason}}</label>
                            <input type="text" class="form-control form-control-sm" id="adminPointsReason" placeholder="Admin adjustment" maxlength="100">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small">&nbsp;</label>
                            <div class="d-flex gap-1">
                                <button type="button" class="btn btn-success btn-sm flex-fill admin-add-points" title="Add points to user">
                                    <i class="bi bi-plus-circle"></i> Add
                                </button>
                                <button type="button" class="btn btn-danger btn-sm flex-fill admin-remove-points" title="Remove points from user">
                                    <i class="bi bi-dash-circle"></i> Remove
                                </button>
                                <button type="button" class="btn btn-warning btn-sm flex-fill admin-set-points" title="Set exact points amount">
                                    <i class="bi bi-pencil"></i> Set
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">
                            <i class="bi bi-info-circle me-1"></i>
                            Debug tools for user: <strong>{{user.nickname}}</strong> ({{user._id}})<br>
                            <i class="bi bi-exclamation-triangle me-1"></i>
                            <em>Add/Remove: Enter amount to add or subtract. Set: Enter exact total amount.</em>
                        </small>
                    </div>
                </div>
                {{/if}}

                <!-- Content Tabs -->
                <div class="container-fluid p-3">
                    <div class="d-flex overflow-auto">
                        <ul class="nav nav-tabs border-0 flex-nowrap" id="pointsTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active fw-semibold" id="buy-points-tab" data-bs-toggle="tab" data-bs-target="#buy-points-pane" type="button" role="tab">
                                    <i class="bi bi-bag-plus me-2"></i>{{buyPointsTranslations.buy_points.title}}
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link fw-semibold" id="history-tab" data-bs-toggle="tab" data-bs-target="#history-pane" type="button" role="tab">
                                    <i class="bi bi-clock-history me-2"></i>{{userPointsTranslations.points.history}}
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link fw-semibold" id="leaderboard-tab" data-bs-toggle="tab" data-bs-target="#leaderboard-pane" type="button" role="tab">
                                    <i class="bi bi-trophy me-2"></i>{{userPointsTranslations.points.leaderboard}}
                                </button>
                            </li>
                        </ul>
                    </div>
                    </ul>

                    <div class="tab-content mt-3" id="pointsTabContent">
                        <!-- Points History Tab -->
                        <div class="tab-pane fade " id="history-pane" role="tabpanel">
                            <div class="points-history rounded shadow-sm" style="background: var(--bg-tertiary);">
                                <div class="points-history-header d-flex justify-content-between align-items-center">
                                    <span>{{userPointsTranslations.points.history}}</span>
                                    <button class="btn btn-sm btn-outline-primary refresh-points">
                                        <i class="bi bi-arrow-clockwise me-1"></i>{{translations.refresh}}
                                    </button>
                                </div>
                                <div class="points-history-list" style="max-height: 400px; overflow-y: auto;">
                                    <div class="text-center p-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <div class="mt-2 text-muted">Loading history...</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Buy Points Tab -->
                        <div class="tab-pane fade show active" id="buy-points-pane" role="tabpanel">
                            <div class="buy-points-container rounded shadow-sm px-1">
                                
                                <!-- Point Packages -->
                                <div id="buyPointsPackagesContainer" class="row g-3 mb-4">
                                    <div class="text-center p-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <div class="mt-2 text-muted">{{buyPointsTranslations.buy_points.loading}}</div>
                                    </div>
                                </div>

                                <!-- Purchase History -->
                                <div class="mt-5 pt-4 border-top">
                                    <h6 class="mb-3">
                                        <i class="bi bi-receipt me-2"></i>{{buyPointsTranslations.buy_points.purchase_history}}
                                    </h6>
                                    <div id="purchaseHistoryContainer">
                                        <div class="text-center p-4">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- FAQ Section -->
                                <div class="mt-5 pt-4 border-top">
                                    <h6 class="mb-3">
                                        <i class="bi bi-question-circle me-2"></i>{{buyPointsTranslations.buy_points.faq_title}}
                                    </h6>
                                    <div class="accordion accordion-flush" id="buyPointsFAQ">
                                        <div class="accordion-item">
                                            <h2 class="accordion-header">
                                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faqOne">
                                                    {{buyPointsTranslations.buy_points.faq_q1}}
                                                </button>
                                            </h2>
                                            <div id="faqOne" class="accordion-collapse collapse" data-bs-parent="#buyPointsFAQ">
                                                <div class="accordion-body">
                                                    {{buyPointsTranslations.buy_points.faq_a1}}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="accordion-item">
                                            <h2 class="accordion-header">
                                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faqTwo">
                                                    {{buyPointsTranslations.buy_points.faq_q2}}
                                                </button>
                                            </h2>
                                            <div id="faqTwo" class="accordion-collapse collapse" data-bs-parent="#buyPointsFAQ">
                                                <div class="accordion-body">
                                                    {{buyPointsTranslations.buy_points.faq_a2}}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="accordion-item">
                                            <h2 class="accordion-header">
                                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faqThree">
                                                    {{buyPointsTranslations.buy_points.faq_q3}}
                                                </button>
                                            </h2>
                                            <div id="faqThree" class="accordion-collapse collapse" data-bs-parent="#buyPointsFAQ">
                                                <div class="accordion-body">
                                                    {{buyPointsTranslations.buy_points.faq_a3}}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="accordion-item">
                                            <h2 class="accordion-header">
                                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faqFour">
                                                    {{buyPointsTranslations.buy_points.faq_q4}}
                                                </button>
                                            </h2>
                                            <div id="faqFour" class="accordion-collapse collapse" data-bs-parent="#buyPointsFAQ">
                                                <div class="accordion-body">
                                                    {{buyPointsTranslations.buy_points.faq_a4}}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Leaderboard Tab -->
                        <div class="tab-pane fade" id="leaderboard-pane" role="tabpanel">
                            <div class="leaderboard rounded shadow-sm" style="background: var(--bg-tertiary);">
                                <div class="points-history-header">
                                    <i class="bi bi-trophy-fill me-2 text-warning"></i>{{userPointsTranslations.points.leaderboard}}
                                </div>
                                <div class="leaderboard-list" style="max-height: 400px; overflow-y: auto;">
                                    <div class="text-center p-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <div class="mt-2 text-muted">Loading leaderboard...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="background: var(--bg-tertiary);">
                <div class="d-flex justify-content-between align-items-center w-100">
                    <small class="text-muted">
                        <i class="bi bi-info-circle me-1"></i>
                        {{userPointsTranslations.footer_info}}
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- End User Points Modal -->

<!-- Reconnect Prompt Modal -->
<div class="modal fade" id="reconnectModal" tabindex="-1" aria-labelledby="reconnectModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered mx-0">
        <div class="modal-content mx-auto">
            <div class="modal-header">
                <h5 class="modal-title" id="reconnectModalLabel">
                    <i class="bi bi-wifi-off text-warning me-2"></i>{{translations.reconnect.title}}
                </h5>
            </div>
            <div class="modal-body text-center">
                <p class="mb-3">{{translations.reconnect.message}}</p>
                <div id="reconnectStatus" class="mb-3" style="display: none;">
                    <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <span id="reconnectStatusText">{{translations.reconnect.attempting}}</span>
                </div>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-primary" id="retryConnectionBtn">
                    <i class="bi bi-arrow-clockwise me-2"></i>{{translations.reconnect.retry}}
                </button>
                <button type="button" class="btn btn-secondary" id="refreshPageBtn">
                    <i class="bi bi-arrow-counterclockwise me-2"></i>{{translations.reconnect.refresh}}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Share Modal -->
<div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="openShareModal" aria-hidden="true">
    <div class="modal-dialog mx-0">
        <div class="modal-content mx-auto">
            <div class="modal-header">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                <h5 class="modal-title" id="shareModalLabel">Share</h5>
            </div>
            <div class="modal-body d-flex flex-column align-items-center">
                <button id="twitterShareButton" class="btn btn-outline-primary mb-2 col-lg-8 col-12">
                    <i class="bi bi-twitter me-2"></i>Twitter
                </button>
                <button id="facebookShareButton" class="btn btn-outline-primary mb-2  col-lg-8 col-12">
                    <i class="bi bi-facebook me-2"></i>Facebook
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Authenticate Modal -->
<div class="modal fade" id="loginModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog mx-0">
        <div class="modal-content mx-auto ">
            <div class="modal-header">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0 m-0" id="login-container" style="border-radius: 9%; background: var(--bg-secondary);"></div>
        </div>
    </div>
</div>

<!-- Settings Modal -->
<div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-xl mx-0">
        <div class="modal-content mx-auto">
            <div class="modal-header">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                <h5 class="modal-title" id="settingsModalLabel">{{translations.avatar.settings}}</h5>
            </div>
            <div class="modal-body position-relative p-0" style="padding: 0 !important;">
                <div id="settings-container"></div>
            </div>
        </div>
    </div>
</div>

<!-- SNS Post Modal -->
<div class="modal fade" id="snsPostModal" tabindex="-1" aria-labelledby="snsPostModalLabel" aria-hidden="true" data-bs-backdrop="false" style="z-index: 1065 !important;">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg mx-0">
        <div class="modal-content mx-auto">
            <div class="modal-header">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                <h5 class="modal-title" id="snsPostModalLabel">{{translations.sns.share_to_social}}</h5>
            </div>
            <div class="modal-body">
                <!-- Image Preview -->
                <div class="sns-post-image-preview mb-3 text-center">
                    <img id="snsPostImage" src="" alt="Image to share" class="img-fluid rounded" style="max-height: 300px; object-fit: contain;">
                </div>

                <!-- Platform Selection -->
                <div class="sns-platform-selection mb-3">
                    <label class="form-label">
                        <i class="bi bi-broadcast me-1"></i>{{translations.sns.select_platforms}}
                    </label>
                    <div class="d-flex flex-wrap gap-2" id="snsPlatformCheckboxes">
                        <!-- Platforms will be populated by JS -->
                        <div class="text-muted small">{{translations.sns.loading_connections}}</div>
                    </div>
                </div>

                <!-- Caption Input -->
                <div class="sns-caption-section mb-3">
                    <label for="snsPostCaption" class="form-label d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-chat-quote me-1"></i>{{translations.sns.caption}}</span>
                        <button type="button" class="btn btn-sm btn-outline-primary" id="generateCaptionBtn">
                            <i class="bi bi-magic me-1"></i>{{translations.sns.generate_caption}}
                        </button>
                    </label>
                    <textarea class="form-control" id="snsPostCaption" rows="8" placeholder="{{translations.sns.caption_placeholder}}" maxlength="2200"></textarea>
                    <div class="form-text d-flex justify-content-between">
                        <span id="captionGeneratingStatus" class="text-primary" style="display: none;">
                            <span class="spinner-border spinner-border-sm me-1"></span>{{translations.sns.generating}}
                        </span>
                        <span class="caption-char-count"><span id="captionCharCount">0</span>/2200</span>
                    </div>
                </div>

                <!-- Caption Style and Language Options -->
                <div class="sns-caption-options mb-3">
                    <div class="row g-2">
                        <div class="col-md-6">
                            <label class="form-label small">{{translations.sns.caption_style}}</label>
                            <select class="form-select form-select-sm" id="captionStyleSelect">
                                <option value="engaging" selected>{{translations.sns.style_engaging}}</option>
                                <option value="casual">{{translations.sns.style_casual}}</option>
                                <option value="professional">{{translations.sns.style_professional}}</option>
                                <option value="funny">{{translations.sns.style_funny}}</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small">Language</label>
                            <select class="form-select form-select-sm" id="captionLanguageSelect">
                                <option value="english">üá¨üáß English</option>
                                <option value="japanese">üáØüáµ Êó•Êú¨Ë™û</option>
                                <option value="french">üá´üá∑ Fran√ßais</option>
                                <option value="portuguese">üáßüá∑ Portugu√™s</option>
                                <option value="spanish">üá™üá∏ Espa√±ol</option>
                                <option value="chinese">üá®üá≥ ‰∏≠Êñá</option>
                                <option value="korean">üá∞üá∑ ÌïúÍµ≠Ïñ¥</option>
                                <option value="thai">üáπüá≠ ‡πÑ‡∏ó‡∏¢</option>
                                <option value="german">üá©üá™ Deutsch</option>
                                <option value="italian">üáÆüáπ Italiano</option>
                                <option value="russian">üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
                                <option value="hindi">üáÆüá≥ ‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- No Connections Warning -->
                <div class="alert alert-warning" id="noConnectionsWarning" style="display: none;">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    {{translations.sns.no_connections_warning}}
                    <button type="button" class="btn btn-sm btn-warning ms-2" onclick="openSettingsConnectionsTab()">
                        {{translations.sns.connect_accounts}}
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    {{translations.cancel}}
                </button>
                <button type="button" class="btn btn-primary" id="publishSnsPostBtn" disabled>
                    <i class="bi bi-send me-1"></i>{{translations.sns.publish}}
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Character Creation Modal -->
<div class="modal fade" id="characterCreationModal" tabindex="-1" aria-labelledby="characterCreationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl mx-0 modal-dialog-scrollable">
        <div class="modal-content mx-auto">
            <div class="modal-header">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                <h5 class="modal-title" id="characterCreationModalLabel">{{translations.newCharacter.characterCreationForm}}</h5>
            </div>
            <div class="modal-body p-0 position-relative">
                <div id="character-creation-container" class="character-creation-sidebar-layout">
                    <!-- Sidebar layout will be injected here -->
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Character Modal -->
<div class="modal fade" id="characterModal" tabindex="-1" aria-labelledby="characterModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable mx-0">
        <div class="modal-content mx-auto">
            <div class="modal-header">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                <h5 class="modal-title" id="characterModalLabel">{{translations.character.title}}</h5>
            </div>
            <div class="modal-body position-relative px-1">
                <div id="character-modal-container"></div>
            </div>
        </div>
    </div>
</div>
<!-- Plan Upgrade Modal #plan-container-->
<div class="modal fade" id="planUpgradeModal" tabindex="-1" aria-labelledby="planUpgradeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable mx-0">
        <div class="modal-content mx-auto">
            <div class="modal-header">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                <h5 class="modal-title" id="planUpgradeModalLabel">{{translations.plan_page.premium}}</h5>
            </div>
            <div class="modal-body m-0 p-0 position-relative">
                <div id="plan-container"></div>
            </div>
        </div>
    </div>
</div>
<!--  Affiliation Modal -->
<div class="modal fade" id="affiliationModal" tabindex="-1" aria-labelledby="affiliationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable mx-0">
        <div class="modal-content mx-auto">
            <div class="modal-header">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                <h5 class="modal-title" id="affiliationModalLabel">{{affiliationTranslations.modal_title}}</h5>
            </div>
            <div class="modal-body m-0 p-0 position-relative">
                <div id="affiliation-container"></div>
            </div>
        </div>
    </div>
</div>
<!-- Subscription Cancellation Feedback Modal -->
<div class="modal fade" id="cancelSubscriptionModal" tabindex="-1" aria-labelledby="cancelSubscriptionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered mx-0">
        <div class="modal-content mx-auto">
            <div class="modal-header">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                <h5 class="modal-title" id="cancelSubscriptionModalLabel">{{translations.cancel_subscription_modal_title}}</h5>
            </div>
            <div class="modal-body">
                <p>{{translations.cancel_subscription_warning}}</p>
                <form id="cancelFeedbackForm">
                    <div class="mb-3">
                        <label for="cancellationReason" class="form-label">{{translations.why_cancel_label}}</label>
                        <textarea class="form-control" id="cancellationReason" name="cancellationReason" rows="8" placeholder="{{translations.why_cancel_placeholder}}"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{translations.do_not_cancel_button}}</button>
                <button type="button" class="btn btn-danger" id="confirmCancelSubscriptionButton">{{translations.continue_cancellation_button}}</button>
            </div>
        </div>
    </div>
</div>

<!-- Character Update Modal -->
<div class="modal fade character-update-modal" id="characterUpdateModal" tabindex="-1" aria-labelledby="characterUpdateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable mx-0">
        <div class="modal-content mx-auto">
            <div class="modal-header p-0">
                <button type="button" class="btn-close position-absolute top-0 end-0 m-3" data-bs-dismiss="modal" aria-label="Close" style="z-index: 10;"></button>
            </div>
            <div class="modal-body">
                <div id="character-update-container">
                    <!-- Character update form will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" id="clearCharacterForm">
                    <i class="bi bi-eraser me-2"></i>{{translations.characterUpdate.clearForm}}
                </button>
                <button type="button" class="btn btn-outline-primary" id="resetCharacterForm">
                    <i class="bi bi-arrow-counterclockwise me-2"></i>{{translations.characterUpdate.resetForm}}
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-lg me-2"></i>{{translations.characterUpdate.cancel}}
                </button>
                <button type="button" class="btn custom-gradient-bg text-white" id="saveCharacterUpdate">
                    <i class="bi bi-check-lg me-2"></i>{{translations.characterUpdate.saveChanges}}
                </button>
            </div>
        </div>
    </div>
</div>


<!-- Chat History Modal with High Z-Index -->
<div class="modal fade" id="chatHistoryModal" tabindex="-1" aria-labelledby="chatHistoryModalLabel" aria-hidden="true" 
     style="z-index: 1062 !important; height: auto; min-height: 400px;" data-bs-backdrop="true" data-bs-keyboard="true">
    <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable" style="z-index: 1061 !important;">
        <div class="modal-content chat-history-modal border-0 shadow-lg mx-auto pt-5" style="z-index: 1062 !important; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border-radius: 20px; overflow: hidden;">
            <div class="modal-header border-0 pb-2 pt-4 px-4">
                <div class="d-flex align-items-center w-100">
                    <button type="button" class="btn-close btn-close-white me-3" data-bs-dismiss="modal" aria-label="Close" style="z-index: 10;"></button>
                    <div class="chat-history-modal-icon me-3" style="width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; border-radius: 12px; background: rgba(181, 138, 254, 0.25);">
                        <i class="bi bi-clock-history fs-4" style="color: #b58afe;"></i>
                    </div>
                    <div class="flex-grow-1 text-end">
                        <h5 class="modal-title mb-0 fw-semibold" id="chatHistoryModalLabel" style="color: #b58afe; letter-spacing: 0.01em;">{{translations.chatHistoryTitle}}</h5>
                        <small style="color: rgba(255, 255, 255, 0.7);">{{translations.chatHistoryDescription}}</small>
                    </div>
                </div>
            </div>
            <div class="modal-body pt-5 px-3">
                <div id="chat-history-list" class="chat-history-container">
                    <!-- Chat history items will be populated here -->
                    {{#if chatHistory}}
                        {{#each chatHistory}}
                        <div class="chat-history-item d-flex flex-column p-3 mb-3 shadow-sm" style="background: rgba(255,255,255,0.08); border-radius: 12px; border: 1px solid rgba(255,255,255,0.12);">
                            <div class="d-flex align-items-center mb-2">
                                <div class="me-2" style="width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:8px;background:rgba(181,138,254,0.18);">
                                    <i class="bi bi-chat-dots" style="color:#b58afe;font-size:1.3rem;"></i>
                                </div>
                                <span class="fw-semibold" style="color:#fff;">{{this.title}}</span>
                            </div>
                            <div class="mb-1" style="color:#fff;">{{this.date}}</div>
                            <div class="text-muted" style="color:rgba(255,255,255,0.6);font-size:0.95rem;">{{this.time}}</div>
                        </div>
                        {{/each}}
                    {{else}}
                        <div class="chat-history-empty text-center py-4" style="color:rgba(255,255,255,0.6);">
                            <i class="bi bi-inbox me-2" style="font-size:1.5rem;color:#b58afe;"></i>
                            {{translations.chatHistoryEmpty}}
                        </div>
                    {{/if}}
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Character Info Modal (Read-only) - Native App Style -->
<div class="modal fade character-info-modal" id="characterInfoModal" tabindex="-1" aria-labelledby="characterInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable mx-auto" style="max-width: 420px;">
        <div class="modal-content character-info-native">
            <div class="modal-header border-0 pb-0">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body pt-0">
                <div id="character-info-container">
                    <!-- Loading state -->
                    <div class="text-center p-4" id="characterInfoLoading">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div class="mt-2 text-muted">{{translations.loading}}</div>
                    </div>
                    
                    <!-- Character info content - Native App Style -->
                    <div id="characterInfoContent" style="display: none;">
                        <!-- Character Header with Avatar -->
                        <div class="char-info-header text-center mb-4">
                            <div class="char-info-avatar-wrapper mx-auto mb-3">
                                <img id="charInfoImage" src="" alt="Character" class="char-info-avatar" style="display: none;">
                                <div id="charInfoImagePlaceholder" class="char-info-avatar-placeholder d-flex align-items-center justify-content-center">
                                    <i class="bi bi-person fs-1"></i>
                                </div>
                            </div>
                            <h4 id="charInfoName" class="char-info-name mb-2">-</h4>
                            <div class="char-info-stats d-flex justify-content-center gap-4">
                                <div class="char-info-stat">
                                    <i class="bi bi-chat-dots"></i>
                                    <span id="charInfoMessages">0</span>
                                </div>
                                <div class="char-info-stat">
                                    <i class="bi bi-image"></i>
                                    <span id="charInfoImages">0</span>
                                </div>
                                <div class="char-info-stat">
                                    <i class="bi bi-camera-video"></i>
                                    <span id="charInfoVideos">0</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Character Details Grid - Native App Style -->
                        <div class="char-info-details-grid">
                            <!-- Personality -->
                            <div class="char-info-detail-card">
                                <span class="char-info-label">{{translations.newCharacter.personality_title}}</span>
                                <span class="char-info-value" id="charInfoPersonality">-</span>
                                <button type="button" class="char-info-edit-btn" data-field="personality"><i class="bi bi-pencil"></i></button>
                            </div>
                            
                            <!-- Relationship -->
                            <div class="char-info-detail-card">
                                <span class="char-info-label">{{translations.newCharacter.relationship_title}}</span>
                                <span class="char-info-value" id="charInfoRelationship">-</span>
                                <button type="button" class="char-info-edit-btn" data-field="relationship"><i class="bi bi-pencil"></i></button>
                            </div>
                            
                            <!-- Occupation -->
                            <div class="char-info-detail-card">
                                <span class="char-info-label">{{translations.newCharacter.occupation_title}}</span>
                                <span class="char-info-value" id="charInfoOccupation">-</span>
                                <button type="button" class="char-info-edit-btn" data-field="occupation"><i class="bi bi-pencil"></i></button>
                            </div>
                            
                            <!-- Preferences -->
                            <div class="char-info-detail-card">
                                <span class="char-info-label">{{translations.newCharacter.kinks_title}}</span>
                                <span class="char-info-value" id="charInfoPreferences">-</span>
                                <button type="button" class="char-info-edit-btn" data-field="preferences"><i class="bi bi-pencil"></i></button>
                            </div>
                        </div>
                        
                        <!-- Custom Instructions Section -->
                        <div class="char-info-purpose-section" id="charInfoCustomInstructionsSection" style="display: none;">
                            <span class="char-info-label">
                                {{#if translations.newCharacter.custom_instructions_title}}
                                    {{translations.newCharacter.custom_instructions_title}}
                                {{else}}
                                    Custom Instructions
                                {{/if}}
                            </span>
                            <p class="char-info-purpose-text" id="charInfoCustomInstructions">-</p>
                            <button type="button" class="char-info-edit-btn" data-field="customInstructions"><i class="bi bi-pencil"></i></button>
                        </div>
                        
                        <!-- Add Custom Instructions Button (shown when no custom instructions exist) -->
                        <div class="char-info-add-instructions mt-3" id="charInfoAddInstructionsBtn">
                            <button type="button" class="btn btn-outline-primary btn-sm w-100" id="addCustomInstructionsBtn">
                                <i class="bi bi-plus-circle me-2"></i>
                                {{#if translations.newCharacter.add_custom_instructions}}
                                    {{translations.newCharacter.add_custom_instructions}}
                                {{else}}
                                    Add Custom Instructions
                                {{/if}}
                            </button>
                        </div>
                        
                        <!-- Chat Purpose Section -->
                        <div class="char-info-purpose-section" id="charInfoPurposeSection" style="display: none;">
                            <span class="char-info-label">{{translations.newCharacter.chat_purpose_label}}</span>
                            <p class="char-info-purpose-text" id="charInfoPurpose">-</p>
                        </div>
                        
                        <!-- Reset Customizations Button -->
                        <div class="char-info-reset mt-3" id="charInfoResetBtn" style="display: none;">
                            <button type="button" class="btn btn-outline-warning btn-sm w-100">
                                <i class="bi bi-arrow-counterclockwise me-2"></i>
                                {{#if translations.newCharacter.reset_customizations}}
                                    {{translations.newCharacter.reset_customizations}}
                                {{else}}
                                    Reset to Character Defaults
                                {{/if}}
                            </button>
                        </div>
                        
                        <!-- View Character Link -->
                        <div class="char-info-actions mt-4">
                            <a href="#" id="charInfoLink" target="_blank" class="btn btn-outline-secondary btn-sm w-100">
                                <i class="bi bi-box-arrow-up-right me-2"></i>{{translations.characterUpdate.viewCharacter}}
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Character Intro Modal -->
<div class="modal fade" id="characterIntroModal" tabindex="-1" aria-labelledby="characterIntroModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable mx-0">
        <div class="modal-content mx-auto">
            <div class="modal-header">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                <h5 class="modal-title" id="characterIntroModalLabel">{{translations.characterIntro.title}}</h5>
            </div>
            <div class="modal-body position-relative">
                <div id="character-intro-container" class="px-2 overflow-hidden">
                    <!-- Loading state -->
                    <div class="text-center p-4" id="characterIntroLoading">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div class="mt-2 text-muted">{{translations.characterIntro.loading}}</div>
                    </div>
                    
                    <!-- Character intro content -->
                    <div id="characterIntroContent" style="display: none;">
                        <!-- Character Header -->
                        <div class="d-flex align-items-center mb-3">
                            <img id="charIntroImage" src="" alt="Character" class="rounded-circle me-3 col-3" style="width: 50px; height: 50px; object-fit: cover; display: none;">
                            <div id="charIntroImagePlaceholder" class="bg-light rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 80px; height: 80px;">
                                <i class="bi bi-person fs-1 text-muted"></i>
                            </div>
                            <div>
                                <h4 id="charIntroName" class="mb-1">-</h4>
                                <div class="text-muted">
                                    <i class="bi bi-image me-1"></i><span id="charIntroImages">0</span> ‚Ä¢ 
                                    <i class="bi bi-camera-video me-1"></i><span id="charIntroVideos">0</span> ‚Ä¢ 
                                    <span id="charIntroGender">-</span> ‚Ä¢ 
                                    <i class="bi bi-calendar me-1"></i><span id="charIntroCreatedAt">-</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Basic Information -->
                        <div class="mb-3">
                            <p id="charIntroShortIntro" class="mb-2" style="font-size: 13px;">-</p>
                            <div id="charIntroTags" class="tags-container"></div>
                            
                            <!-- Unlock All & Start Chat Buttons -->
                            <div class="d-flex justify-content-center gap-2 mt-3">
                                <button type="button" class="btn btn-dark is-free-user btn-sm w-100" onclick="loadPlanPage('character_intro_modal')" data-tracking-source="character_intro_modal">{{translations.unlockAll}}</button>
                                <button type="button" class="btn btn-primary btn-sm w-100 track-chat-start-character-intro" data-tracking-source="character_intro_modal" onclick="startChatting(event)">{{translations.startChatting}}</button>
                            </div>
                        </div>
                        
                        <!-- Gallery -->
                        <div id="character-intro-gallery" class="row">
                            <!-- Gallery will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer position-fixed bottom-0 start-50 translate-middle-x w-100 bg-transparent border-top" style="z-index: 1050;">
                <div class="d-flex justify-content-center w-100">
                    <button type="button" class="btn btn-dark me-2 is-free-user" onclick="loadPlanPage('character_intro_modal')" data-tracking-source="character_intro_modal">{{translations.unlockAll}}</button>
                    <button type="button" class="btn btn-primary track-chat-start-character-intro" data-tracking-source="character_intro_modal" onclick="startChatting(event)">{{translations.startChatting}}</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Daily Rewards Calendar Modal -->
<div class="modal fade" id="dailyRewardsModal" tabindex="-1" aria-labelledby="dailyRewardsModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content mx-auto">
            <div class="modal-header daily-rewards-header">
                <div class="d-flex align-items-center justify-content-between w-100">
                    <button type="button" class="btn-close btn-close-rigth btn-close-dark" data-bs-dismiss="modal" aria-label="Close"></button>
                    <h4 class="modal-title mb-0" id="dailyRewardsModalLabel">
                        {{#if userPointsTranslations.points.daily_rewards_streak}}
                            {{userPointsTranslations.points.daily_rewards_streak}}
                        {{else}}
                            30-Day Streak Challenge
                        {{/if}}
                    </h4>
                </div>
            </div>
            <div class="modal-body">
                <!-- Current Streak Display -->
                <div class="current-streak-banner">
                    <div class="container-fluid p-4">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <div class="streak-info">
                                    <div class="streak-flame">
                                        <i class="bi bi-fire text-warning fs-1"></i>
                                        <span class="streak-count">0</span>
                                    </div>
                                    <div class="streak-text">
                                        <h5 class="mb-1">
                                            {{#if userPointsTranslations.points.current_streak}}
                                                {{userPointsTranslations.points.current_streak}}
                                            {{else}}
                                                Current Streak
                                            {{/if}}
                                        </h5>
                                        <p class="mb-0 text-muted">
                                            {{#if userPointsTranslations.points.keep_streak_going}}
                                                {{userPointsTranslations.points.keep_streak_going}}
                                            {{else}}
                                                Keep your daily login streak going to reach 30 days!
                                            {{/if}}
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 text-md-end">
                                <div class="next-reward">
                                    <small class="text-muted d-block">
                                        {{#if userPointsTranslations.points.next_reward}}
                                            {{userPointsTranslations.points.next_reward}}
                                        {{else}}
                                            Next Reward
                                        {{/if}}
                                    </small>
                                    <div class="next-reward-preview">
                                        <i class="bi bi-star-fill text-warning me-1"></i>
                                        <span class="reward-amount">15</span>
                                        {{#if userPointsTranslations.points.title}}
                                            {{userPointsTranslations.points.title}}
                                        {{else}}
                                            points
                                        {{/if}}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Streak Progress Grid -->
                <div class="streak-container">
                    <div class="streak-header mb-4">
                        <h5 class="text-center mb-3">
                            <i class="bi bi-trophy me-2 text-primary"></i>
                            {{#if userPointsTranslations.points.streak_progress}}
                                {{userPointsTranslations.points.streak_progress}}
                            {{else}}
                                30-Day Streak Progress
                            {{/if}}
                        </h5>
                        <p class="text-center text-muted small">
                            {{#if userPointsTranslations.points.streak_description}}
                                {{userPointsTranslations.points.streak_description}}
                            {{else}}
                                Complete daily logins to progress through the streak. Weekly milestones unlock bonus rewards!
                            {{/if}}
                        </p>
                    </div>
                    
                    <div class="streak-grid" id="rewardsCalendarGrid">
                        <!-- Grid will be populated by JavaScript -->
                        <div class="text-center p-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <div class="mt-2 text-muted">
                                {{#if userPointsTranslations.points.loading_streak}}
                                    {{userPointsTranslations.points.loading_streak}}
                                {{else}}
                                    Loading streak progress...
                                {{/if}}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Today's Reward Section -->
                <div class="todays-reward-section bg-light border-top" id="todaysRewardSection" style="display: none;">
                    <div class="container-fluid p-4">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <div class="todays-reward-info">
                                    <h6 class="mb-2">
                                        <i class="bi bi-calendar-check text-success me-2"></i>
                                        {{#if userPointsTranslations.points.todays_reward}}
                                            {{userPointsTranslations.points.todays_reward}}
                                        {{else}}
                                            Today's Streak Reward
                                        {{/if}}
                                    </h6>
                                    <div class="reward-details">
                                        <span class="reward-points fs-5 fw-bold text-success">+<span id="todaysRewardAmount">10</span></span>
                                        <span class="text-muted ms-2">
                                            {{#if userPointsTranslations.points.title}}
                                                {{userPointsTranslations.points.title}}
                                            {{else}}
                                                points
                                            {{/if}}
                                        </span>
                                        <div class="reward-bonus-text text-muted small" id="todaysRewardBonus"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 text-md-end">
                                <button class="btn btn-success btn-lg claim-todays-reward" id="claimTodaysReward">
                                    <i class="bi bi-gift me-2"></i>
                                    {{#if userPointsTranslations.points.claim_reward}}
                                        {{userPointsTranslations.points.claim_reward}}
                                    {{else}}
                                        Claim Reward
                                    {{/if}}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="background: var(--bg-tertiary);">
                <div class="d-flex justify-content-between align-items-center w-100">
                    <small class="text-muted">
                        <i class="bi bi-info-circle me-1"></i>
                        {{#if userPointsTranslations.points.streak_reset_info}}
                            {{userPointsTranslations.points.streak_reset_info}}
                        {{else}}
                            Missing a day will reset your streak. Reach 30 days for the ultimate reward!
                        {{/if}}
                    </small>
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        {{#if userPointsTranslations.points.close}}
                            {{userPointsTranslations.points.close}}
                        {{else}}
                            Close
                        {{/if}}
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- End Daily Rewards Calendar Modal -->

<!-- User Analytics Modal -->
<div class="modal fade" id="analyticsModal" tabindex="-1" aria-labelledby="analyticsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content mx-auto">
            <div class="modal-header bg-gradient text-white" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                <h5 class="modal-title d-flex align-items-center" id="analyticsModalLabel">
                    <i class="bi bi-trophy-fill me-2"></i>
                    {{#if userAnalyticsTranslations.image_leaderboard_title}}
                        {{userAnalyticsTranslations.image_leaderboard_title}}
                    {{else}}
                        Image Generation Leaderboard
                    {{/if}}
                </h5>
                <button type="button" class="btn-close btn-close-dark" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <!-- Analytics Summary Cards -->
                <div class="analytics-summary bg-light p-4">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <div class="card analytics-widget border-0 shadow-sm">
                                <div class="card-body text-center">
                                    <i class="bi bi-image text-primary fs-1 mb-2"></i>
                                    <h4 class="mb-1 total-images-generated">0</h4>
                                    <small class="text-muted">
                                        {{#if userAnalyticsTranslations.your_images}}
                                            {{userAnalyticsTranslations.your_images}}
                                        {{else}}
                                            Your Images
                                        {{/if}}
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card analytics-widget border-0 shadow-sm">
                                <div class="card-body text-center">
                                    <i class="bi bi-calendar-month text-success fs-1 mb-2"></i>
                                    <h4 class="mb-1 images-this-month">0</h4>
                                    <small class="text-muted">
                                        {{#if userAnalyticsTranslations.this_month}}
                                            {{userAnalyticsTranslations.this_month}}
                                        {{else}}
                                            This Month
                                        {{/if}}
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card analytics-widget border-0 shadow-sm">
                                <div class="card-body text-center">
                                    <i class="bi bi-calendar-week text-info fs-1 mb-2"></i>
                                    <h4 class="mb-1 images-this-week">0</h4>
                                    <small class="text-muted">
                                        {{#if userAnalyticsTranslations.this_week}}
                                            {{userAnalyticsTranslations.this_week}}
                                        {{else}}
                                            This Week
                                        {{/if}}
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card analytics-widget border-0 shadow-sm">
                                <div class="card-body text-center">
                                    <i class="bi bi-chat-dots text-warning fs-1 mb-2"></i>
                                    <h4 class="mb-1 favorite-chat">-</h4>
                                    <small class="text-muted">
                                        {{#if userAnalyticsTranslations.favorite_chat}}
                                            {{userAnalyticsTranslations.favorite_chat}}
                                        {{else}}
                                            Favorite Chat
                                        {{/if}}
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Image Generation Leaderboard -->
                <div class="container-fluid p-3">
                    <div class="bg-white rounded shadow-sm">
                        <div class="leaderboard-header d-flex justify-content-between align-items-center p-3 border-bottom">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-trophy-fill me-2 text-warning fs-4"></i>
                                <h6 class="mb-0">
                                    {{#if userAnalyticsTranslations.top_image_creators}}
                                        {{userAnalyticsTranslations.top_image_creators}}
                                    {{else}}
                                        Top Image Creators
                                    {{/if}}
                                </h6>
                            </div>
                            <button class="btn btn-sm btn-outline-primary refresh-analytics">
                                <i class="bi bi-arrow-clockwise me-1"></i>
                                {{#if translations.refresh}}
                                    {{translations.refresh}}
                                {{else}}
                                    Refresh
                                {{/if}}
                            </button>
                        </div>
                        <div class="analytics-leaderboard-list" style="max-height: 500px; overflow-y: auto;">
                            <div class="text-center p-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <div class="mt-2 text-muted">Loading leaderboard...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="background: var(--bg-tertiary);">
                <div class="d-flex justify-content-between align-items-center w-100">
                    <small class="text-muted">
                        <i class="bi bi-info-circle me-1"></i>
                        {{#if userAnalyticsTranslations.leaderboard_footer_info}}
                            {{userAnalyticsTranslations.leaderboard_footer_info}}
                        {{else}}
                            Rankings based on total images generated
                        {{/if}}
                    </small>
                    <div class="d-flex gap-2">
                        {{#if isAdmin}}
                        <button class="btn btn-sm btn-outline-secondary debug-all-analytics">
                            <i class="bi bi-bug me-1"></i>Debug
                        </button>
                        {{/if}}
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                            {{#if translations.close}}
                                {{translations.close}}
                            {{else}}
                                Close
                            {{/if}}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- End User Analytics Modal -->

<!-- Combined Leaderboard Modal -->
<div class="modal fade" id="leaderboardModal" tabindex="-1" aria-labelledby="leaderboardModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content mx-auto">
            <div class="modal-header bg-gradient text-white" style="background: linear-gradient(135deg, #6f42c1 0%, #4a148c 100%);">
                <h5 class="modal-title d-flex align-items-center" id="leaderboardModalLabel">
                    <i class="bi bi-trophy-fill me-2"></i>
                    {{#if translations.leaderboards_title}}{{translations.leaderboards_title}}{{else}}Leaderboards{{/if}}
                </h5>
                <button type="button" class="btn-close btn-close-dark" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4 bg-white">
                <!-- Image Generation Leaderboard -->
                <div class="leaderboard-section mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <h6 class="mb-0">
                                <i class="bi bi-image text-primary me-2"></i>
                                {{#if userAnalyticsTranslations.top_image_creators}}{{userAnalyticsTranslations.top_image_creators}}{{else}}Top Image Creators{{/if}}
                            </h6>
                            <small class="text-muted">
                                {{#if translations.most_creative_users}}{{translations.most_creative_users}}{{else}}The most creative users.{{/if}}
                            </small>
                        </div>
                        <button class="btn btn-sm btn-outline-secondary refresh-leaderboards" data-type="image">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>
                    <div class="leaderboard-list" id="image-leaderboard-container">
                        <div class="text-center p-3"><div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div></div>
                    </div>
                </div>

                <hr class="my-4">

                <!-- User Points Leaderboard -->
                <div class="leaderboard-section">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <h6 class="mb-0">
                                <i class="bi bi-star-fill text-warning me-2"></i>
                                {{#if userPointsTranslations.points.top_earners}}{{userPointsTranslations.points.top_earners}}{{else}}Top Point Earners{{/if}}
                            </h6>
                            <small class="text-muted">
                                {{#if translations.most_active_users}}{{translations.most_active_users}}{{else}}The most active users.{{/if}}
                            </small>
                        </div>
                        <button class="btn btn-sm btn-outline-secondary refresh-leaderboards" data-type="points">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>
                    <div class="leaderboard-list" id="points-leaderboard-container">
                        <div class="text-center p-3"><div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="background: var(--bg-tertiary);">
                <small class="text-muted fst-italic">
                    <i class="bi bi-info-circle me-1"></i>
                    {{#if translations.leaderboard_footer_info}}{{translations.leaderboard_footer_info}}{{else}}Rankings are updated periodically.{{/if}}
                </small>
            </div>
        </div>
    </div>
</div>
<!-- End Combined Leaderboard Modal -->

<script>
  $('.modal').on('hidden.bs.modal', function () {
    $('.modal-backdrop').remove();
    $('body').removeClass('modal-open').css('overflow', '');
  });

  // Initialize leaderboard modal events
  $(document).ready(function() {
    // Combined leaderboard modal events
    $('#leaderboardModal').on('show.bs.modal', function() {
      console.log('Leaderboard modal opening...');
      if (window.userAnalyticsManager) {
        window.userAnalyticsManager.loadCombinedLeaderboards();
      }
    });

    // Refresh leaderboards buttons
    $(document).on('click', '.refresh-leaderboards', function(e) {
      e.preventDefault();
      const type = $(this).data('type');
      console.log('Refreshing leaderboard type:', type);
      if (window.userAnalyticsManager) {
        window.userAnalyticsManager.refreshLeaderboards(type);
      }
    });
  });
</script>