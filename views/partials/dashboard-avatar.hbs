{{#if user}}
    {{#if user.isTemporary}}
        <li class="nav-item dropdown clerk-button">
            <a class="btn shadow-0 nav-icon-btn" href="#" onclick="openLoginForm()" title="{{translations.login}}">
                <i class="bi bi-box-arrow-in-right"></i>
            </a>
        </li>
        <li class="nav-item mx-2">
            <!-- Language Dropdown -->
            <div class="dropdown">
                <button data-user-lang="{{user.lang}}" class="btn btn-light dropdown-toggle shadow-0" type="button" id="languageDropdownMenu" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-globe2"></i>
                </button>
                <ul class="dropdown-menu position-absolute dropdown-menu-end" aria-labelledby="languageDropdownMenu">
                    <li><a class="dropdown-item language-select" href="#" data-lang="ja">日本語</a></li>
                    <li><a class="dropdown-item language-select" href="#" data-lang="en">English</a></li>
                    <li><a class="dropdown-item language-select" href="#" data-lang="fr">Français</a></li>
                </ul>
            </div>
        </li>
                
   {{/if}}
{{else}}
        <li class="nav-item dropdown">
        <a class="btn shadow-0 nav-icon-btn" href="/authenticate" title="{{translations.login}}">
            <i class="bi bi-box-arrow-in-right"></i>
        </a>
    </li>
{{/if}}

<!-- Fixed Avatar Button - Outside nav structure -->
{{#if user}}
    {{#unless user.isTemporary}}
        <div id="avatarMenuContainer" 
        class="d-flex align-items-center gap-2 position-fixed" 
        style="top:6px;right:50px;z-index:1059;">
            {{#if user.isAdmin}}
                <div class="d-flex align-items-center gap-2">
                    <span class="badge bg-danger text-white">{{translations.admin}}</span>
                </div>
            {{/if}}
            <!-- Notifications -->
            <div class="d-none dropdown">
                <button class="btn btn-light border-0 shadow-0 p-1 rounded-circle position-relative" 
                        type="button" 
                        id="notificationDropdown" 
                        data-bs-toggle="dropdown" 
                        aria-expanded="false" 
                        data-userid="{{user._id}}"
                        style="width: 35px; height: 35px;">
                    <i class="bi bi-bell"></i>
                    <!-- Unread notification badge (populate via JS) -->
                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none" id="notificationBadge">
                        <span class="visually-hidden">unread notifications</span>
                    </span>
                </button>
                <ul class="dropdown-menu dropdown-menu-end border-0 shadow" 
                    aria-labelledby="notificationDropdown"
                    style="max-height: 400px; overflow-y: auto; min-width: 300px;">
                    <!-- Notifications will be populated here via JavaScript -->
                </ul>
            </div>
            <!-- Show Premium Badge -->
            {{#if (eq user.subscriptionStatus 'active')}}
            {{else}}
                <div class="d-flex align-items-center gap-2">
                    <span class="btn btn-outline-primary btn-gradient-border badge-sm text-white shadow-0 my-1" style="font-size: 0.9rem;" onclick="loadPlanPage()">
                        <i class="bi bi-gem"></i> {{translations.avatar.premium}}
                    </span>
                </div>
            {{/if}}
            <!-- Show current chat level -->
            <div id="chatLevelContainer" class="d-flex align-items-center gap-2 mt-1 onchat-on" onclick="updateCurrentChatLevel()" style="cursor: pointer;">
                <span class="btn btn-dark badge-sm text-white shadow-0 my-1" style="font-size: 0.9rem;">
                </span>
            </div>
            <!-- Points Balance -->
            <div id="userPointsContainer" class="d-flex align-items-center gap-2 mt-1">
                <span class="btn btn-primary-50 badge-sm text-white shadow-0 my-1" style="font-size: 0.9rem;" data-bs-toggle="modal" data-bs-target="#userPointsModal">
                    <i class="bi bi-coin"></i>
                    <span class="user-points-balance">0</span>
                </span>
            </div>
            <!-- Avatar Button with Notification Badge -->
            <div class="position-relative">
                <button id="avatarMenuBtn" 
                    class="p-0 border-0 shadow-0 bg-transparent avatar-bg {{#if (eq user.subscriptionStatus 'active')}} bg-purple {{/if}}" 
                    type="button" 
                    data-bs-toggle="offcanvas" 
                    data-bs-target="#userMenuOffcanvas" 
                    aria-controls="userMenuOffcanvas"
                    style="border-radius: 50%; background-size: cover; background-position: top; background-image: url('{{#if user.profileUrl}}{{user.profileUrl}}{{else}}/img/avatar.png{{/if}}');">
                </button>
                <!-- Notification Badge on Avatar - Red Dot Only -->
                <span id="avatarNotificationBadge" class="avatar-notification-badge d-none"></span>
            </div>
        </div>
    {{/unless}}
{{/if}}

<!-- User Menu Offcanvas -->
{{#if user}}
    {{#unless user.isTemporary}}
    <div class="offcanvas offcanvas-end" tabindex="-1" id="userMenuOffcanvas" aria-labelledby="userMenuOffcanvasLabel" style="visibility: hidden; background: var(--bg-secondary); color: var(--text-primary); border-left: 1px solid var(--glass-border);">
        <div class="offcanvas-header" style="border-bottom: 1px solid var(--glass-border); background: var(--bg-primary);">
            <div class="d-flex align-items-center w-100">
                <div class="avatar-container me-3">
                    <img src="{{#if user.profileUrl}}{{user.profileUrl}}{{else}}/img/avatar.png{{/if}}" 
                         class="rounded-circle" alt="Avatar" loading="lazy" />
                </div>
                <div class="user-info flex-grow-1">
                    <h6 class="mb-0" style="color: var(--text-primary);">{{user.username}}</h6>
                    {{#if (eq user.subscriptionStatus 'active')}}
                        <small class="text-muted">
                            <i class="bi bi-gem text-warning"></i> {{translations.avatar.premium}}
                        </small>
                    {{/if}}
                </div>
                <button type="button" class="btn-close btn-close-right" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
        </div>
        <div class="offcanvas-body px-3">
            <div class="list-group list-group-flush mb-4">

                {{#if (eq user.subscriptionStatus 'active')}}
                {{else}}
                    <a class="list-group-item list-group-item-action text-white border-0 menu-item" style="background: linear-gradient(to bottom right, rgb(129, 81, 214) 21.85%, #cdb3fb 100%, #6e20f4);" href="#" onclick="loadPlanPage()">
                        <i class="bi bi-gem me-3"></i>{{translations.avatar.premium}}
                    </a>
                {{/if}}

                <a class="list-group-item list-group-item-action border-0 menu-item" href="/user/{{user._id}}">
                    <i class="bi bi-person-circle me-3"></i>{{translations.avatar.profile}}
                </a>
                
                <a class="list-group-item list-group-item-action border-0 menu-item" href="#" data-bs-toggle="modal" data-bs-target="#userPointsModal">
                    <i class="bi bi-coin me-3"></i>
                    {{userPointsTranslations.points.title}}: <span class="user-points-balance ms-1">0</span>
                </a>
                
                <!-- Notifications Menu Item -->
                <a class="list-group-item list-group-item-action border-0 menu-item position-relative" href="#" id="notificationsMenuItem">
                    <i class="bi bi-bell me-3"></i>{{translations.avatar.notifications}}
                    <span id="menuNotificationBadge" class="menu-notification-badge d-none">0</span>
                </a>
                
                <!-- History Menu Item -->
                <a class="list-group-item list-group-item-action border-0 menu-item" href="/history">
                    <i class="bi bi-clock-history me-3"></i>History
                </a>
                
                <!-- Connections Menu Item -->
                <a class="list-group-item list-group-item-action border-0 menu-item" href="#" id="connectionsMenuItem">
                    <i class="bi bi-share me-3"></i>{{translations.avatar.connections}}
                </a>
                
                <div class="d-none">
                    <a class="list-group-item list-group-item-action border-0 menu-item" href="/chat/list/{{user._id}}">
                        <i class="bi bi-people me-3"></i>{{translations.avatar.characters}}
                    </a>
                </div>
                
                <a class="list-group-item list-group-item-action border-0 menu-item" href="#" onclick="loadCharacterCreationPage()">
                    <i class="bi bi-plus-circle me-3"></i>{{translations.avatar.createCharacter}}
                </a>

                <a class="list-group-item list-group-item-action border-0 menu-item" href="/affiliation">
                    <i class="bi bi-link me-3"></i>{{translations.avatar.affiliation}}
                </a>
                
                <a class="d-none list-group-item list-group-item-action border-0 menu-item" href="/subscriptions">
                    <i class="bi bi-heart me-3"></i>{{translations.avatar.mySubscriptions}}
                </a>
                
                {{!-- Creator Section - Hidden (Coming Soon) --}}
                
                <hr class="my-2">
                <div class="px-3 py-2">
                    <small class="text-muted fw-bold">DASHBOARDS</small>
                </div>
                
                <a class="list-group-item list-group-item-action border-0 menu-item" href="/dashboard/generation">
                    <i class="bi bi-card-image me-3"></i>{{translations.avatar.generationDashboard}}
                </a>
                
                <a class="list-group-item list-group-item-action border-0 menu-item" href="/dashboard/posts">
                    <i class="bi bi-images me-3"></i>{{translations.avatar.myPosts}}
                </a>
                
                <a class="list-group-item list-group-item-action border-0 menu-item" href="/dashboard/schedules">
                    <i class="bi bi-calendar-event me-3"></i>{{translations.avatar.mySchedules}}
                </a>
                
                <a class="d-none list-group-item list-group-item-action border-0 menu-item" href="/dashboard/templates">
                    <i class="bi bi-file-text me-3"></i>{{translations.avatar.promptTemplates}}
                </a>

                {{!-- Creator Dashboard Section - Hidden (Coming Soon) --}}

                {{#if isAdmin}}
                    <hr class="my-2">
                    <div class="px-3 py-2">
                        <small class="text-muted fw-bold">ADMIN</small>
                    </div>
                    
                    <a class="list-group-item list-group-item-action border-0 menu-item" href="/admin/users">
                        <i class="bi bi-people me-3"></i>{{translations.admin.users}}
                    </a>

                    <a class="list-group-item list-group-item-action border-0 menu-item" href="/admin/users/analytics">
                        <i class="bi bi-bar-chart me-3"></i>{{translations.admin.user_analytics}}
                    </a>

                    <a class="list-group-item list-group-item-action border-0 menu-item" href="/admin/upsell-analytics">
                        <i class="bi bi-fire me-3"></i>{{#if translations.admin.upsell_analytics}}{{translations.admin.upsell_analytics}}{{else}}Upsell Analytics{{/if}}
                    </a>
                    
                    <a class="list-group-item list-group-item-action border-0 menu-item" href="#" data-bs-toggle="modal" data-bs-target="#analyticsModal">
                        <i class="bi bi-bar-chart me-3"></i>{{translations.image_leaderboard_title}}
                    </a>
                    
                    <a class="list-group-item list-group-item-action border-0 menu-item" href="/admin/prompts">
                        <i class="bi bi-pencil me-3"></i>{{translations.admin.prompts}}
                    </a>
                    
                    <a class="list-group-item list-group-item-action border-0 menu-item" href="/admin/system-prompts">
                        <i class="bi bi-pencil me-3"></i>{{translations.admin.system_prompts}}
                    </a>
                    
                    <a class="list-group-item list-group-item-action border-0 menu-item" href="/admin/gifts">
                        <i class="bi bi-gift me-3"></i>{{translations.admin.gifts}}
                    </a>
                    
                    <a class="list-group-item list-group-item-action border-0 menu-item" href="/admin/models">
                        <i class="bi bi-person-badge me-3"></i>{{translations.admin.models}}
                    </a>
                    
                    <a class="list-group-item list-group-item-action border-0 menu-item" href="/admin/civitai">
                        <i class="bi bi-clock me-3"></i>{{translations.admin_model_chats.title}}
                    </a>
                    
                    <hr class="my-2">
                    <div class="px-3 py-2">
                        <small class="text-muted fw-bold">TEST</small>
                    </div>
                    
                    <a class="list-group-item list-group-item-action border-0 menu-item" href="/admin/chat-model-test">
                        <i class="bi bi-flask me-3"></i>{{translations.admin_model_test.title}}
                    </a>
                    
                    <hr class="my-2">
                    
                    <a class="list-group-item list-group-item-action border-0 menu-item" href="/admin/notifications">
                        <i class="bi bi-bell me-3"></i>{{translations.admin.notifications}}
                    </a>
                {{/if}}
                
                <hr class="my-2">
                
                <a class="list-group-item list-group-item-action border-0 menu-item" href="#" onclick="openUserProfile()">
                    <i class="bi bi-pencil-square me-3"></i>{{translations.avatar.editProfile}}
                </a>
                
                <a class="list-group-item list-group-item-action border-0 menu-item" href="#" onclick="loadSettingsPage()">
                    <i class="bi bi-gear me-3"></i>{{translations.avatar.settings}}
                </a>
                
                <a class="list-group-item list-group-item-action border-0 text-danger logout menu-item" href="#">
                    <i class="bi bi-box-arrow-right me-3"></i>{{translations.avatar.logout}}
                </a>
            </div>
        </div>
    </div>
    {{/unless}}
{{/if}}

<!-- User Notifications Modal -->
<div class="modal fade" id="userNotificationsModal" tabindex="-1" aria-labelledby="userNotificationsModalLabel" aria-hidden="true" data-bs-backdrop="false" data-bs-keyboard="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content notifications-modal-content">
            <div class="notifications-modal-header">
                <div class="d-flex align-items-center gap-2">
                    <i class="bi bi-bell-fill"></i>
                    <span>{{translations.avatar.notifications}}</span>
                </div>
                <button type="button" class="notifications-close-btn" data-bs-dismiss="modal" aria-label="Close">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="notifications-modal-body">
                <div id="notificationsLoading" class="notifications-loading">
                    <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                </div>
                <div id="notificationsList" class="notifications-list d-none"></div>
                <div id="noNotifications" class="notifications-empty d-none">
                    <i class="bi bi-bell-slash"></i>
                    <p>{{translations.notifications.empty}}</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- User Connections Modal -->
<div class="modal fade" id="userConnectionsModal" tabindex="-1" aria-labelledby="userConnectionsModalLabel" aria-hidden="true" data-bs-backdrop="false" data-bs-keyboard="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content connections-modal-content">
            <div class="connections-modal-header">
                <div class="d-flex align-items-center gap-2">
                    <i class="bi bi-share-fill"></i>
                    <span>{{translations.avatar.connections}}</span>
                </div>
                <button type="button" class="connections-close-btn" data-bs-dismiss="modal" aria-label="Close">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="connections-modal-body">
                <!-- SNS Connections Section -->
                <div class="connections-section">
                    <div class="connections-section-header mb-3">
                        <h6 class="connections-section-title mb-1">
                            <i class="bi bi-link-45deg me-2"></i>
                            {{translations.sns.connected_accounts}}
                        </h6>
                        <p class="connections-section-subtitle text-muted mb-0 small">
                            {{translations.sns.connections_description}}
                        </p>
                    </div>

                    <!-- Account Limit Info -->
                    <div class="account-limit-info mb-3 p-2 rounded" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(130, 64, 255, 0.2);">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="small">
                                <i class="bi bi-info-circle me-1"></i>
                                <span id="modalConnectionLimitText">{{translations.sns.loading}}</span>
                            </div>
                            <span class="badge bg-primary" id="modalConnectionCountBadge">0/1</span>
                        </div>
                    </div>

                    <!-- Connected Accounts List -->
                    <div id="modalConnectedAccountsList" class="connected-accounts-list mb-3">
                        <div class="text-center p-3">
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <div class="mt-2 text-muted small">{{translations.sns.loading_connections}}</div>
                        </div>
                    </div>

                    <!-- Connect New Account Section -->
                    <div class="connect-new-section">
                        <h6 class="mb-2 small">
                            <i class="bi bi-plus-circle me-2"></i>{{translations.sns.connect_new_account}}
                        </h6>
                        
                        <!-- Platform Options -->
                        <div class="platform-options d-flex flex-wrap gap-2">
                            <!-- Instagram -->
                            <button type="button" class="btn btn-outline-secondary btn-sm platform-connect-btn-modal d-flex align-items-center gap-2" 
                                    data-platform="instagram" id="modalConnectInstagramBtn">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                                </svg>
                                <span>Instagram</span>
                            </button>

                            <!-- X (Twitter) -->
                            <button type="button" class="btn btn-outline-secondary btn-sm platform-connect-btn-modal d-flex align-items-center gap-2" 
                                    data-platform="twitter" id="modalConnectTwitterBtn">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                                </svg>
                                <span>X (Twitter)</span>
                            </button>
                        </div>

                        <!-- Premium Upsell -->
                        <div class="premium-upsell mt-2 p-2 rounded is-free-user" id="modalConnectionPremiumUpsell" style="display: none; background: linear-gradient(135deg, rgba(255, 193, 7, 0.1), rgba(255, 152, 0, 0.1)); border: 1px solid rgba(255, 193, 7, 0.3);">
                            <div class="d-flex align-items-center gap-2">
                                <i class="bi bi-crown-fill text-warning"></i>
                                <div class="flex-grow-1">
                                    <strong class="small">{{translations.sns.premium_accounts}}</strong>
                                    <p class="mb-0 small text-muted">{{translations.sns.premium_description}}</p>
                                </div>
                                <button type="button" class="btn btn-warning btn-sm" onclick="loadPlanPage()">
                                    {{translations.sns.upgrade}}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Posts Section -->
                <div class="connections-section mt-3">
                    <div class="connections-section-header mb-3">
                        <h6 class="connections-section-title mb-1">
                            <i class="bi bi-clock-history me-2"></i>
                            {{translations.sns.recent_posts}}
                        </h6>
                        <p class="connections-section-subtitle text-muted mb-0 small">
                            {{translations.sns.recent_posts_description}}
                        </p>
                    </div>

                    <div id="modalRecentPostsList" class="recent-posts-list" style="max-height: 200px; overflow-y: auto;">
                        <div class="text-center p-3 text-muted">
                            <i class="bi bi-inbox fs-4 mb-2"></i>
                            <p class="mb-0 small">{{translations.sns.no_posts_yet}}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<link rel="stylesheet" href="/css/dashboard-avatar.css">

<script>
// Global function to open User Connections Modal
window.openUserConnectionsModal = function() {
    const connectionsModal = document.getElementById('userConnectionsModal');
    if (connectionsModal) {
        const modal = new bootstrap.Modal(connectionsModal, {
            backdrop: false,
            keyboard: true
        });
        modal.show();
    } else {
        console.error('User Connections Modal not found');
    }
};

document.addEventListener('DOMContentLoaded', function() {
    const avatarMenuContainer = document.getElementById('avatarMenuContainer');
    const avatarBtn = document.getElementById('avatarMenuBtn');
    const userPointsContainer = document.getElementById('userPointsContainer');
    const offcanvasElement = document.getElementById('userMenuOffcanvas');
    const menuItems = document.querySelectorAll('.menu-item');
    const navbarContainer = document.getElementById('navbarNav');
    const footerToolbar = document.getElementById('footer-toolbar');
    const chatInput = document.getElementById('chatInput');

    if (avatarMenuContainer && offcanvasElement) {
        // Remove any existing show class on page load
        offcanvasElement.classList.remove('show');
        offcanvasElement.style.visibility = 'hidden';

        // Enable body scroll when offcanvas is not shown
        document.body.style.overflow = 'auto';
        if(navbarContainer) {
            navbarContainer.style.right = '-50vw';
        }

        
        // Initialize Bootstrap offcanvas without backdrop
        const bsOffcanvas = new bootstrap.Offcanvas(offcanvasElement, {
            backdrop: true,
            keyboard: true,
            scroll: true
        });
        
        // Hide avatar button when offcanvas shows
        offcanvasElement.addEventListener('show.bs.offcanvas', function() {
            if (avatarMenuContainer) {
                avatarMenuContainer.style.opacity = '1';
                avatarMenuContainer.style.visibility = 'visible';
            }
            if(navbarContainer) {
                navbarContainer.style.right = '20px';
            }
            // Manage UI elements based on chat container visibility
            const chatContainerIsVisible = $('#chat-container:visible')[0];
            if (chatContainerIsVisible && chatContainerIsVisible.style.display !== 'none') {
                // If chat container is visible, hide chat input
                if (chatInput) {
                    $(chatInput).fadeOut(200);
                }
            } else {
                // If chat container is not visible, hide footer toolbar
                if (footerToolbar) {
                    $(footerToolbar).fadeOut(200);
                }
            }

        });
        
        // Show avatar button when offcanvas hides
        offcanvasElement.addEventListener('hidden.bs.offcanvas', function() {
            if (avatarMenuContainer) {
                avatarMenuContainer.style.opacity = '1';
                avatarMenuContainer.style.visibility = 'visible';
            }
            if(navbarContainer) {
                navbarContainer.style.right = '-50vw';
            }
            // Manage UI elements based on chat container visibility
            const chatContainerIsVisible = $('#chat-container:visible')[0];
            if (chatContainerIsVisible && chatContainerIsVisible.style.display !== 'none') {
                // If chat container is visible, show chat input
                if (chatInput) {
                    $(chatInput).fadeIn(200);
                }
            } else {
                // If chat container is not visible, show footer toolbar
                if (footerToolbar) {
                    $(footerToolbar).fadeIn(200);
                }
            }

            // Enable body scroll when offcanvas is hidden
            document.body.style.overflow = 'auto';
        });
        
        // Close offcanvas when clicking menu items that have onclick handlers
        menuItems.forEach(item => {
            if (item.getAttribute('onclick')) {
                item.addEventListener('click', function() {
                    setTimeout(() => {
                        bsOffcanvas.hide();
                    }, 100);
                });
            }
        });
        
        // Close offcanvas when clicking links (except modal triggers)
        menuItems.forEach(item => {
            if (item.getAttribute('href') && item.getAttribute('href') !== '#' && !item.getAttribute('data-bs-toggle')) {
                item.addEventListener('click', function() {
                    setTimeout(() => {
                        bsOffcanvas.hide();
                    }, 100);
                });
            }
        });
        
        // Handle notification menu item click - close offcanvas first, then open modal
        const notificationsMenuItem = document.getElementById('notificationsMenuItem');
        const notificationsModal = document.getElementById('userNotificationsModal');
        
        if (notificationsMenuItem && notificationsModal) {
            notificationsMenuItem.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Close offcanvas if open, then open modal
                if (offcanvasElement.classList.contains('show')) {
                    bsOffcanvas.hide();
                    
                    // Wait for offcanvas to fully close, then open modal
                    offcanvasElement.addEventListener('hidden.bs.offcanvas', function openModal() {
                        const modal = new bootstrap.Modal(notificationsModal, {
                            backdrop: false,
                            keyboard: true
                        });
                        modal.show();
                    }, { once: true });
                } else {
                    // Offcanvas already closed, open modal directly
                    const modal = new bootstrap.Modal(notificationsModal, {
                        backdrop: false,
                        keyboard: true
                    });
                    modal.show();
                }
            });
        }
        
        // Handle connections menu item click - close offcanvas first, then open modal
        const connectionsMenuItem = document.getElementById('connectionsMenuItem');
        const connectionsModal = document.getElementById('userConnectionsModal');
        
        if (connectionsMenuItem && connectionsModal) {
            connectionsMenuItem.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Close offcanvas if open, then open modal
                if (offcanvasElement.classList.contains('show')) {
                    bsOffcanvas.hide();
                    
                    // Wait for offcanvas to fully close, then open modal
                    offcanvasElement.addEventListener('hidden.bs.offcanvas', function openConnectionsModal() {
                        const modal = new bootstrap.Modal(connectionsModal, {
                            backdrop: false,
                            keyboard: true
                        });
                        modal.show();
                    }, { once: true });
                } else {
                    // Offcanvas already closed, open modal directly
                    const modal = new bootstrap.Modal(connectionsModal, {
                        backdrop: false,
                        keyboard: true
                    });
                    modal.show();
                }
            });
        }
        
        // Close offcanvas when clicking outside
        document.addEventListener('click', function(e) {
            if (offcanvasElement.classList.contains('show') && 
                !offcanvasElement.contains(e.target) && 
                !avatarBtn.contains(e.target)) {
                bsOffcanvas.hide();
            }
        });
    }

    // Notification System
    initNotificationSystem();
    
    // Connections System
    initConnectionsSystem();
});

// Initialize notification system
function initNotificationSystem() {
    // Load notification count on page load
    loadNotificationCount();
    
    // Refresh count periodically (every 60 seconds)
    setInterval(loadNotificationCount, 60000);
    
    // Load notifications when modal opens
    const notificationsModal = document.getElementById('userNotificationsModal');
    if (notificationsModal) {
        notificationsModal.addEventListener('show.bs.modal', function() {
            // Ensure offcanvas is closed
            const offcanvasEl = document.getElementById('userMenuOffcanvas');
            if (offcanvasEl?.classList.contains('show')) {
                const bsOffcanvas = bootstrap.Offcanvas.getInstance(offcanvasEl);
                if (bsOffcanvas) {
                    bsOffcanvas.hide();
                }
            }
            
            loadUserNotifications();
        });
    }
}

// Load notification count and update badges
async function loadNotificationCount() {
    try {
        const res = await fetch('/notifications/count');
        if (!res.ok) return;
        
        const data = await res.json();
        const count = data.count || 0;
        
        // Update avatar badge - just show red dot, no text
        const avatarBadge = document.getElementById('avatarNotificationBadge');
        if (avatarBadge) {
            if (count > 0) {
                // Remove any text content for dot-only design
                avatarBadge.textContent = '';
                avatarBadge.classList.remove('d-none');
            } else {
                avatarBadge.classList.add('d-none');
            }
        }
        
        // Update menu badge - show count in fixed circular badge
        const menuBadge = document.getElementById('menuNotificationBadge');
        if (menuBadge) {
            if (count > 0) {
                // Show count, but keep it within fixed circular size
                const displayCount = count > 99 ? '99+' : count.toString();
                menuBadge.textContent = displayCount;
                menuBadge.classList.remove('d-none');
            } else {
                menuBadge.classList.add('d-none');
            }
        }
    } catch (err) {
        console.error('Error loading notification count:', err);
    }
}

// Load user notifications for modal
async function loadUserNotifications() {
    const loadingEl = document.getElementById('notificationsLoading');
    const listEl = document.getElementById('notificationsList');
    const emptyEl = document.getElementById('noNotifications');
    
    loadingEl.classList.remove('d-none');
    listEl.classList.add('d-none');
    emptyEl.classList.add('d-none');
    
    try {
        const res = await fetch('/notifications');
        if (!res.ok) throw new Error('Failed to load notifications');
        
        const notifications = await res.json();
        
        loadingEl.classList.add('d-none');
        
        if (!notifications || notifications.length === 0) {
            emptyEl.classList.remove('d-none');
            return;
        }
        
        listEl.innerHTML = notifications.map(notif => `
            <div class="notif-item ${!notif.viewed ? 'notif-unread' : ''}" 
                 data-id="${notif._id}"
                 onclick="handleNotificationClick('${notif._id}', '${notif.data?.link || ''}')">
                <div class="notif-icon notif-icon-${notif.type || 'info'}">
                    <i class="bi ${getNotificationIconClass(notif.type)}"></i>
                </div>
                <div class="notif-content">
                    <div class="notif-title">${escapeHtml(notif.title)}</div>
                    <div class="notif-message">${escapeHtml(notif.message)}</div>
                    <div class="notif-time">${formatNotificationTime(notif.createdAt)}</div>
                </div>
                ${!notif.viewed ? '<div class="notif-dot"></div>' : ''}
                ${notif.data?.link ? '<i class="bi bi-chevron-right notif-arrow"></i>' : ''}
            </div>
        `).join('');
        
        listEl.classList.remove('d-none');
    } catch (err) {
        console.error('Error loading notifications:', err);
        loadingEl.classList.add('d-none');
        emptyEl.classList.remove('d-none');
    }
}

// Handle notification click
async function handleNotificationClick(notificationId, link) {
    try {
        await fetch(`/notifications/viewed/${notificationId}`, { method: 'PUT' });
        loadNotificationCount();
        
        if (link && link !== '' && link !== 'undefined') {
            window.location.href = link;
        } else {
            // Update the visual state
            const item = document.querySelector(`.notif-item[data-id="${notificationId}"]`);
            if (item) {
                item.classList.remove('notif-unread');
                const dot = item.querySelector('.notif-dot');
                if (dot) dot.remove();
            }
        }
    } catch (err) {
        console.error('Error marking notification as viewed:', err);
    }
}

// Get notification icon class based on type
function getNotificationIconClass(type) {
    const icons = {
        info: 'bi-info-circle-fill',
        success: 'bi-check-circle-fill',
        warning: 'bi-exclamation-triangle-fill',
        error: 'bi-x-circle-fill',
        video: 'bi-play-circle-fill',
        image: 'bi-image-fill'
    };
    return icons[type] || icons.info;
}

// Format notification time
function formatNotificationTime(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    const now = new Date();
    const diff = now - date;
    
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);
    
    if (minutes < 1) return 'Just now';
    if (minutes < 60) return `${minutes}m ago`;
    if (hours < 24) return `${hours}h ago`;
    if (days < 7) return `${days}d ago`;
    return date.toLocaleDateString();
}

// Escape HTML to prevent XSS
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// =====================================================
// Connections System
// =====================================================

// Connections state management
const connectionsState = {
    connections: [],
    limits: { current: 0, max: 1, isPremium: false },
    isLoading: false
};

// Initialize connections system
function initConnectionsSystem() {
    // Load connections when modal opens
    const connectionsModal = document.getElementById('userConnectionsModal');
    if (connectionsModal) {
        connectionsModal.addEventListener('show.bs.modal', function() {
            // Ensure offcanvas is closed
            const offcanvasEl = document.getElementById('userMenuOffcanvas');
            if (offcanvasEl?.classList.contains('show')) {
                const bsOffcanvas = bootstrap.Offcanvas.getInstance(offcanvasEl);
                if (bsOffcanvas) {
                    bsOffcanvas.hide();
                }
            }
            
            loadModalConnections();
            loadModalRecentPosts();
        });
    }
    
    // Bind platform connect buttons in modal
    bindModalConnectButtons();
}

// Load connections for modal
async function loadModalConnections() {
    if (connectionsState.isLoading) return;
    
    connectionsState.isLoading = true;
    console.log('[Connections Modal] Loading connections...');
    
    try {
        const response = await fetch('/api/social/status', {
            method: 'GET',
            credentials: 'include'
        });

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();
        
        if (data.success) {
            connectionsState.connections = data.connections || [];
            connectionsState.limits = data.limits || { current: 0, max: 1, isPremium: false };
            
            console.log('[Connections Modal] Loaded connections:', connectionsState.connections.length);
            
            renderModalConnections();
            updateModalLimitInfo();
            updateModalConnectButtons();
        } else {
            throw new Error(data.error || 'Failed to load connections');
        }
    } catch (error) {
        console.error('[Connections Modal] Error loading connections:', error);
        showModalConnectionsError(error.message);
    } finally {
        connectionsState.isLoading = false;
    }
}

// Render connected accounts list in modal
function renderModalConnections() {
    const container = document.getElementById('modalConnectedAccountsList');
    if (!container) return;
    
    if (connectionsState.connections.length === 0) {
        container.innerHTML = `
            <div class="text-center p-3">
                <i class="bi bi-link-45deg fs-4 mb-2 text-muted"></i>
                <p class="mb-0 text-muted small">${window.translations?.sns?.no_connections || 'No connected accounts yet'}</p>
                <p class="small text-muted">${window.translations?.sns?.connect_hint || 'Connect your social media accounts below'}</p>
            </div>
        `;
        return;
    }

    const html = connectionsState.connections.map(conn => {
        const platformIcon = getConnectionPlatformIcon(conn.platform);
        const platformName = getConnectionPlatformName(conn.platform);
        const avatar = conn.profileUrl || '/img/avatar.png';
        
        return `
            <div class="connected-account-item" data-connection-id="${conn.id}" data-platform="${conn.platform}">
                <div class="account-info">
                    <img src="${avatar}" alt="${conn.username}" class="account-avatar" onerror="this.src='/img/avatar.png'">
                    <div class="account-details">
                        <span class="account-username">@${conn.username}</span>
                        <span class="account-platform">
                            ${platformIcon}
                            ${platformName}
                        </span>
                    </div>
                </div>
                <button type="button" class="btn btn-link disconnect-btn" onclick="disconnectModalAccount('${conn.platform}', '${conn.id}')" title="${window.translations?.sns?.disconnect || 'Disconnect'}">
                    <i class="bi bi-x-circle"></i>
                </button>
            </div>
        `;
    }).join('');

    container.innerHTML = html;
}

// Update account limit info in modal
function updateModalLimitInfo() {
    const { current, max, isPremium } = connectionsState.limits;
    
    const countBadge = document.getElementById('modalConnectionCountBadge');
    if (countBadge) {
        countBadge.textContent = `${current}/${max}`;
    }
    
    const limitText = isPremium 
        ? (window.translations?.sns?.premium_limit || `Premium: ${max} accounts`)
        : (window.translations?.sns?.free_limit || `Free: ${max} account`);
    
    const limitTextEl = document.getElementById('modalConnectionLimitText');
    if (limitTextEl) {
        limitTextEl.textContent = limitText;
    }
    
    // Show/hide premium upsell
    const upsellEl = document.getElementById('modalConnectionPremiumUpsell');
    if (upsellEl) {
        if (!isPremium && current >= max) {
            upsellEl.style.display = 'block';
        } else {
            upsellEl.style.display = 'none';
        }
    }
}

// Update connect buttons state in modal
function updateModalConnectButtons() {
    const canConnect = connectionsState.connections.length < connectionsState.limits.max;
    
    document.querySelectorAll('.platform-connect-btn-modal').forEach(btn => {
        const platform = btn.dataset.platform;
        const isConnected = connectionsState.connections.some(c => c.platform === platform);
        
        if (isConnected) {
            btn.classList.add('connected');
            btn.disabled = true;
            btn.innerHTML = `${getConnectionPlatformIcon(platform)} <span>${getConnectionPlatformName(platform)}</span> <i class="bi bi-check-circle ms-1"></i>`;
        } else if (!canConnect) {
            btn.classList.remove('connected');
            btn.disabled = true;
            btn.title = window.translations?.sns?.limit_reached || 'Account limit reached';
        } else {
            btn.classList.remove('connected');
            btn.disabled = false;
            btn.innerHTML = `${getConnectionPlatformIcon(platform)} <span>${getConnectionPlatformName(platform)}</span>`;
        }
    });
}

// Bind connect button handlers in modal
function bindModalConnectButtons() {
    document.addEventListener('click', async function(e) {
        const btn = e.target.closest('.platform-connect-btn-modal:not(.connected):not(:disabled)');
        if (btn) {
            const platform = btn.dataset.platform;
            await connectModalPlatform(platform, btn);
        }
    });
}

// Connect to a platform from modal
async function connectModalPlatform(platform, button) {
    console.log('[Connections Modal] Connecting to:', platform);
    
    const originalHtml = button.innerHTML;
    button.disabled = true;
    button.innerHTML = `
        <span class="spinner-border spinner-border-sm me-1"></span>
        ${window.translations?.sns?.connecting || 'Connecting...'}
    `;
    
    try {
        const response = await fetch(`/api/social/connect/${platform}`, {
            method: 'GET',
            credentials: 'include'
        });

        const data = await response.json();
        
        if (data.success && data.authUrl) {
            // Open OAuth in new window
            const authWindow = window.open(data.authUrl, 'sns_auth', 'width=600,height=700');
            
            // Check for window close
            const checkClosed = setInterval(() => {
                if (authWindow.closed) {
                    clearInterval(checkClosed);
                    button.disabled = false;
                    button.innerHTML = originalHtml;
                    // Reload connections after OAuth
                    setTimeout(() => loadModalConnections(), 1000);
                }
            }, 500);
        } else if (data.needsUpgrade) {
            showNotification(window.translations?.sns?.upgrade_required || 'Upgrade to premium to connect more accounts', 'warning');
            loadPlanPage();
            button.disabled = false;
            button.innerHTML = originalHtml;
        } else {
            throw new Error(data.error || 'Failed to get auth URL');
        }
    } catch (error) {
        console.error('[Connections Modal] Connect error:', error);
        showNotification(error.message || (window.translations?.sns?.connect_error || 'Failed to connect'), 'error');
        button.disabled = false;
        button.innerHTML = originalHtml;
    }
}

// Disconnect from a platform via modal
async function disconnectModalAccount(platform, accountId) {
    const confirmed = await Swal.fire({
        title: window.translations?.sns?.confirm_disconnect || 'Disconnect account?',
        text: window.translations?.sns?.disconnect_warning || 'You will need to reconnect to post again.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: window.translations?.sns?.disconnect || 'Disconnect',
        cancelButtonText: window.translations?.cancel || 'Cancel',
        confirmButtonColor: '#dc3545'
    });

    if (!confirmed.isConfirmed) return;

    console.log('[Connections Modal] Disconnecting:', platform, accountId);
    
    try {
        const response = await fetch(`/api/social/disconnect/${platform}/${accountId}`, {
            method: 'DELETE',
            credentials: 'include'
        });

        const data = await response.json();
        
        if (data.success) {
            showNotification(window.translations?.sns?.disconnected || 'Account disconnected', 'success');
            loadModalConnections();
        } else {
            throw new Error(data.error || 'Failed to disconnect');
        }
    } catch (error) {
        console.error('[Connections Modal] Disconnect error:', error);
        showNotification(error.message || (window.translations?.sns?.disconnect_error || 'Failed to disconnect'), 'error');
    }
}

// Show error in modal connections list
function showModalConnectionsError(message) {
    const container = document.getElementById('modalConnectedAccountsList');
    if (container) {
        container.innerHTML = `
            <div class="alert alert-danger m-0 small">
                <i class="bi bi-exclamation-triangle me-2"></i>
                ${message}
                <button type="button" class="btn btn-sm btn-outline-danger ms-2" onclick="loadModalConnections()">
                    ${window.translations?.sns?.retry || 'Retry'}
                </button>
            </div>
        `;
    }
}

// Load recent posts for modal
async function loadModalRecentPosts() {
    console.log('[Connections Modal] Loading recent posts...');
    
    try {
        const response = await fetch('/api/social/posts?limit=5', {
            method: 'GET',
            credentials: 'include'
        });

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();
        
        if (data.success) {
            console.log('[Connections Modal] Loaded recent posts:', data.posts.length);
            renderModalRecentPosts(data.posts);
        } else {
            throw new Error(data.error || 'Failed to load posts');
        }
    } catch (error) {
        console.error('[Connections Modal] Error loading posts:', error);
    }
}

// Render recent posts list in modal
function renderModalRecentPosts(posts) {
    const container = document.getElementById('modalRecentPostsList');
    if (!container) return;
    
    if (!posts || posts.length === 0) {
        container.innerHTML = `
            <div class="text-center p-3 text-muted">
                <i class="bi bi-inbox fs-4 mb-2"></i>
                <p class="mb-0 small">${window.translations?.sns?.no_posts_yet || 'No posts yet'}</p>
            </div>
        `;
        return;
    }

    const html = posts.map(post => {
        const createdAt = new Date(post.createdAt);
        const timeAgo = formatConnectionTimeAgo(createdAt);
        const platformsList = post.platforms.map(p => {
            const icon = getConnectionPlatformIcon(p.platform);
            return `<span class="platform-badge">${icon}</span>`;
        }).join(' ');
        
        const statusBadge = getConnectionStatusBadge(post.status);
        const hasMedia = post.mediaUrls && post.mediaUrls.length > 0;
        const thumbnail = hasMedia ? post.mediaUrls[0] : null;
        
        return `
            <div class="recent-post-item">
                ${thumbnail ? `
                    <div class="post-thumbnail">
                        <img src="${thumbnail}" alt="Post image" onerror="this.style.display='none'">
                    </div>
                ` : ''}
                <div class="post-details">
                    <div class="post-text">${escapeHtml(post.text.substring(0, 80))}${post.text.length > 80 ? '...' : ''}</div>
                    <div class="post-meta">
                        <span class="post-platforms">${platformsList}</span>
                        <span class="post-time"><i class="bi bi-clock me-1"></i>${timeAgo}</span>
                        ${statusBadge}
                    </div>
                </div>
            </div>
        `;
    }).join('');

    container.innerHTML = html;
}

// Get platform icon SVG for connections
function getConnectionPlatformIcon(platform) {
    const icons = {
        instagram: `<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>`,
        twitter: `<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>`
    };
    return icons[platform] || '<i class="bi bi-globe"></i>';
}

// Get platform display name for connections
function getConnectionPlatformName(platform) {
    const names = {
        instagram: 'Instagram',
        twitter: 'X (Twitter)'
    };
    return names[platform] || platform;
}

// Get status badge HTML for connections
function getConnectionStatusBadge(status) {
    const badges = {
        'published': '<span class="badge bg-success" style="font-size: 10px;">Published</span>',
        'pending': '<span class="badge bg-warning" style="font-size: 10px;">Pending</span>',
        'scheduled': '<span class="badge bg-info" style="font-size: 10px;">Scheduled</span>',
        'failed': '<span class="badge bg-danger" style="font-size: 10px;">Failed</span>'
    };
    return badges[status] || '';
}

// Format time ago for connections
function formatConnectionTimeAgo(date) {
    const seconds = Math.floor((new Date() - date) / 1000);
    
    const intervals = {
        year: 31536000,
        month: 2592000,
        week: 604800,
        day: 86400,
        hour: 3600,
        minute: 60
    };
    
    for (const [unit, secondsInUnit] of Object.entries(intervals)) {
        const interval = Math.floor(seconds / secondsInUnit);
        if (interval >= 1) {
            return `${interval}${unit.charAt(0)} ago`;
        }
    }
    
    return 'Just now';
}
</script>
