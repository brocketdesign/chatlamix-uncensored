<!DOCTYPE html>
<html>
{{> dashboard-header}}
<body class="bg-dark">
    {{> dashboard-nav}}
    <link rel="stylesheet" href="/css/admin-image-test.css">
    <link rel="stylesheet" href="/css/civitai-model-search.css">
    
    <section class="container-fluid py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
                    <div class="flex-grow-1">
                        <h1 class="text-white mb-1">
                            <i class="bi bi-images me-2"></i>Generation Dashboard
                        </h1>
                        <p class="text-muted mb-0">Generate images with AI models and compare results</p>
                    </div>
                    {{#if isAdmin}}
                    <div class="d-flex gap-2 w-100 w-md-auto">
                        <button class="btn btn-outline-info flex-fill flex-md-grow-0" onclick="refreshStats()">
                            <i class="bi bi-arrow-clockwise me-1"></i>Refresh Stats
                        </button>
                        <button class="btn btn-outline-danger flex-fill flex-md-grow-0" onclick="resetAllStats()">
                            <i class="bi bi-trash me-1"></i>Reset Stats
                        </button>
                    </div>
                    {{/if}}
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Left Panel: Generation Controls -->
            <div class="col-lg-4 mb-4">
                <div class="card bg-dark border-secondary h-100">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-sliders me-2"></i>Generation Settings</h5>
                    </div>
                    <div class="card-body">
                        <!-- Generation Mode Selection -->
                        <div class="mb-4">
                            <label class="form-label text-white fw-bold">Generation Mode</label>
                            <div class="segmented-control" role="group">
                                <input type="radio" class="btn-check" name="generationMode" id="mode-txt2img" value="txt2img" checked>
                                <label class="segment-btn" for="mode-txt2img">
                                    <i class="bi bi-card-text"></i>
                                    <span>Text to Image</span>
                                </label>
                                
                                <input type="radio" class="btn-check" name="generationMode" id="mode-img2img" value="img2img">
                                <label class="segment-btn" for="mode-img2img">
                                    <i class="bi bi-image"></i>
                                    <span>Image to Image</span>
                                </label>
                                
                                <input type="radio" class="btn-check" name="generationMode" id="mode-face" value="face">
                                <label class="segment-btn" for="mode-face">
                                    <i class="bi bi-person-bounding-box"></i>
                                    <span>Face Tools</span>
                                </label>
                            </div>
                        </div>

                        <!-- Img2Img Image Upload Section (hidden by default) -->
                        <div class="mb-4" id="img2imgUploadSection" style="display: none;">
                            <label class="form-label text-white fw-bold">Source Image</label>
                            <div class="base-image-upload" id="img2imgUploadArea">
                                <input type="file" id="img2imgInput" accept="image/*" style="display: none;">
                                <div class="upload-placeholder" onclick="document.getElementById('img2imgInput').click()">
                                    <i class="bi bi-cloud-upload display-4 text-muted"></i>
                                    <p class="text-muted mb-0">Click to upload source image</p>
                                    <small class="text-muted">Supports JPG, PNG, WebP</small>
                                </div>
                                <div class="image-preview d-none" id="img2imgPreview">
                                    <img id="img2imgPreviewImg" src="" alt="Preview" class="img-fluid rounded">
                                    <button class="btn btn-sm btn-danger mt-2" onclick="clearImg2ImgUpload()">
                                        <i class="bi bi-x me-1"></i>Clear
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Edit Strength (for img2img) -->
                        <div class="mb-4" id="editStrengthSection" style="display: none;">
                            <label class="form-label text-white fw-bold">Edit Strength</label>
                            <div class="segmented-control" role="group">
                                <input type="radio" class="btn-check" name="editStrength" id="strength-low" value="low">
                                <label class="segment-btn" for="strength-low">
                                    <i class="bi bi-speedometer"></i>
                                    <span>Low</span>
                                    <small class="text-muted" style="font-size: 0.6rem;">30%</small>
                                </label>
                                
                                <input type="radio" class="btn-check" name="editStrength" id="strength-medium" value="medium" checked>
                                <label class="segment-btn" for="strength-medium">
                                    <i class="bi bi-speedometer2"></i>
                                    <span>Medium</span>
                                    <small class="text-muted" style="font-size: 0.6rem;">60%</small>
                                </label>
                                
                                <input type="radio" class="btn-check" name="editStrength" id="strength-high" value="high">
                                <label class="segment-btn" for="strength-high">
                                    <i class="bi bi-lightning-charge"></i>
                                    <span>High</span>
                                    <small class="text-muted" style="font-size: 0.6rem;">85%</small>
                                </label>
                            </div>
                            <div class="form-text text-muted mt-1">
                                <small><i class="bi bi-info-circle me-1"></i>Higher strength = more changes to the original image</small>
                            </div>
                        </div>

                        <!-- Merge Face Images Section (hidden by default) -->
                        <div class="mb-4" id="mergeFaceSection" style="display: none;">
                            <label class="form-label text-white fw-bold">Face to Merge (Source)</label>
                            <div class="base-image-upload mb-3" id="faceImageUploadArea">
                                <input type="file" id="faceImageInput" accept="image/*" style="display: none;">
                                <div class="upload-placeholder" onclick="document.getElementById('faceImageInput').click()">
                                    <i class="bi bi-person-circle display-4 text-muted"></i>
                                    <p class="text-muted mb-0">Click to upload face image</p>
                                    <small class="text-muted">The face to apply</small>
                                </div>
                                <div class="image-preview d-none" id="faceImagePreview">
                                    <img id="faceImagePreviewImg" src="" alt="Face Preview" class="img-fluid rounded">
                                    <button class="btn btn-sm btn-danger mt-2" onclick="clearFaceImageUpload()">
                                        <i class="bi bi-x me-1"></i>Clear
                                    </button>
                                </div>
                            </div>
                            
                            <label class="form-label text-white fw-bold">Target Image</label>
                            <div class="base-image-upload" id="targetImageUploadArea">
                                <input type="file" id="targetImageInput" accept="image/*" style="display: none;">
                                <div class="upload-placeholder" onclick="document.getElementById('targetImageInput').click()">
                                    <i class="bi bi-image display-4 text-muted"></i>
                                    <p class="text-muted mb-0">Click to upload target image</p>
                                    <small class="text-muted">Image where face will be merged</small>
                                </div>
                                <div class="image-preview d-none" id="targetImagePreview">
                                    <img id="targetImagePreviewImg" src="" alt="Target Preview" class="img-fluid rounded">
                                    <button class="btn btn-sm btn-danger mt-2" onclick="clearTargetImageUpload()">
                                        <i class="bi bi-x me-1"></i>Clear
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Model Selection -->
                        <div class="mb-4" id="modelSelectionSection">
                            <label class="form-label text-white fw-bold d-flex justify-content-between align-items-center">
                                <span>Select Models to Test</span>
                                <button type="button" class="btn btn-sm btn-outline-info" onclick="openUserModelSearchModal()" title="Add Custom SD Models" id="addCustomModelBtn">
                                    <i class="bi bi-plus-lg me-1"></i>Add Custom Model
                                </button>
                            </label>
                            
                            <!-- Text-to-Image Models -->
                            <div class="model-selection" id="txt2imgModelsSection">
                                <h6 class="text-info mb-2"><i class="bi bi-card-text me-1"></i>Text to Image Models</h6>
                                {{#each models}}
                                {{#unless this.requiresModel}}
                                {{#if (eq this.category "txt2img")}}
                                <div class="form-check model-checkbox mb-2">
                                    <input class="form-check-input txt2img-model-checkbox" type="checkbox" 
                                           value="{{this.id}}" 
                                           id="model-{{this.id}}" 
                                           data-model-name="{{this.name}}"
                                           data-category="txt2img"
                                           data-supports-img2img="{{this.supportsImg2Img}}">
                                    <label class="form-check-label text-white" for="model-{{this.id}}">
                                        <span class="fw-semibold">{{this.name}}</span>
                                        {{#if this.async}}
                                        <span class="badge bg-info ms-1">Async</span>
                                        {{else}}
                                        <span class="badge bg-success ms-1">Sync</span>
                                        {{/if}}
                                        {{#if this.supportsImg2Img}}
                                        <span class="badge bg-warning ms-1">+Img2Img</span>
                                        {{/if}}
                                        <br>
                                        <small class="text-muted">{{this.description}}</small>
                                    </label>
                                </div>
                                {{/if}}
                                {{/unless}}
                                {{/each}}
                            </div>
                            
                            <!-- Image-to-Image Models -->
                            <div class="model-selection mt-3" id="img2imgModelsSection" style="display: none;">
                                <h6 class="text-success mb-2"><i class="bi bi-image me-1"></i>Image to Image Models</h6>
                                {{#each models}}
                                {{#unless this.requiresModel}}
                                {{#if (or (eq this.category "img2img") this.supportsImg2Img)}}
                                <div class="form-check model-checkbox mb-2">
                                    <input class="form-check-input img2img-model-checkbox" type="checkbox" 
                                           value="{{this.id}}" 
                                           id="img2img-model-{{this.id}}" 
                                           data-model-name="{{this.name}}"
                                           data-category="{{this.category}}"
                                           data-requires-image="{{this.requiresImage}}">
                                    <label class="form-check-label text-white" for="img2img-model-{{this.id}}">
                                        <span class="fw-semibold">{{this.name}}</span>
                                        {{#if this.async}}
                                        <span class="badge bg-info ms-1">Async</span>
                                        {{else}}
                                        <span class="badge bg-success ms-1">Sync</span>
                                        {{/if}}
                                        <br>
                                        <small class="text-muted">{{this.description}}</small>
                                    </label>
                                </div>
                                {{/if}}
                                {{/unless}}
                                {{/each}}
                            </div>
                            
                            <!-- Face Tools Models -->
                            <div class="model-selection mt-3" id="faceModelsSection" style="display: none;">
                                <h6 class="text-warning mb-2"><i class="bi bi-person-bounding-box me-1"></i>Face Tools</h6>
                                {{#each models}}
                                {{#if (eq this.category "face")}}
                                <div class="form-check model-checkbox mb-2">
                                    <input class="form-check-input face-model-checkbox" type="checkbox" 
                                           value="{{this.id}}" 
                                           id="face-model-{{this.id}}" 
                                           data-model-name="{{this.name}}"
                                           data-category="face"
                                           data-requires-two-images="{{this.requiresTwoImages}}">
                                    <label class="form-check-label text-white" for="face-model-{{this.id}}">
                                        <span class="fw-semibold">{{this.name}}</span>
                                        {{#if this.async}}
                                        <span class="badge bg-info ms-1">Async</span>
                                        {{else}}
                                        <span class="badge bg-success ms-1">Sync</span>
                                        {{/if}}
                                        <br>
                                        <small class="text-muted">{{this.description}}</small>
                                    </label>
                                </div>
                                {{/if}}
                                {{/each}}
                            </div>
                            
                            <button class="btn btn-sm btn-outline-light mt-2" onclick="selectAllModels()">
                                <i class="bi bi-check-all me-1"></i>Select All Standard
                            </button>
                        </div>

                        <!-- User Custom SD Models Section -->
                        <div class="mb-4" id="userCustomModelsSection">
                            <label class="form-label text-white fw-bold d-flex justify-content-between align-items-center">
                                <span><i class="bi bi-palette me-1"></i>My Custom Models <span class="badge bg-info" id="userCustomModelsCount">0</span></span>
                            </label>
                            
                            <!-- Premium feature notice for non-subscribers -->
                            <div id="customModelsPremiumNotice" class="premium-notice-card" style="display: none;">
                                <div class="premium-notice-icon">
                                    <i class="bi bi-gem"></i>
                                </div>
                                <div class="premium-notice-content">
                                    <strong>Premium Feature</strong>
                                    <p>Unlock access to search and use the latest image generation models from a library of 10,000+ models. Premium users can add custom models to personalize their character generation experience.</p>
                                    <a href="#" onclick="loadPlanPage()" class="btn-upgrade-premium">
                                        <i class="bi bi-star me-1"></i>Upgrade Now
                                    </a>
                                </div>
                            </div>
                            
                            <div class="model-selection" id="userCustomModelsList" style="max-height: 300px;">
                                <div class="text-center text-muted py-3" id="noUserModelsPlaceholder">
                                    <i class="bi bi-box-seam"></i>
                                    <p class="mb-0 small">No custom models yet. Click "Add Custom Model" above to add your own SD models.</p>
                                </div>
                                <!-- User custom models will be dynamically inserted here -->
                            </div>
                        </div>

                        <!-- SD Model Selection -->
                        {{#if activeSDModels.length}}
                        <div class="mb-4" id="sdModelsSection">
                            <label class="form-label text-white fw-bold">Select SD Models to Test</label>
                            <div class="model-selection" style="max-height: 400px;">
                                <!-- Anime Style Models -->
                                {{#if sdModelsByStyle.anime.length}}
                                <div class="mb-3">
                                    <h6 class="text-info mb-2">
                                        <i class="bi bi-palette me-1"></i>Anime Style
                                    </h6>
                                    {{#each sdModelsByStyle.anime}}
                                    <div class="form-check model-checkbox mb-2">
                                        <input class="form-check-input sd-model-checkbox" type="checkbox" 
                                               value="{{this.modelId}}" 
                                               id="sd-model-{{this.modelId}}" 
                                               data-model="{{this.model}}"
                                               data-model-name="{{this.name}}"
                                               data-model-id="{{this.modelId}}">
                                        <label class="form-check-label text-white" for="sd-model-{{this.modelId}}">
                                            <div class="d-flex align-items-start gap-2">
                                                {{#if this.image}}
                                                <img src="{{this.image}}" 
                                                     alt="{{this.name}}" 
                                                     class="model-thumbnail"
                                                     onerror="this.style.display='none'">
                                                {{/if}}
                                                <div class="flex-grow-1">
                                                    <span class="fw-semibold">{{this.name}}</span>
                                                    <span class="badge bg-warning ms-1">SD</span>
                                                    <br>
                                                    <small class="text-muted">{{this.model}}</small>
                                                </div>
                                            </div>
                                        </label>
                                    </div>
                                    {{/each}}
                                </div>
                                {{/if}}

                                <!-- Photorealistic Style Models -->
                                {{#if sdModelsByStyle.photorealistic.length}}
                                <div class="mb-3">
                                    <h6 class="text-success mb-2">
                                        <i class="bi bi-camera me-1"></i>Photorealistic Style
                                    </h6>
                                    {{#each sdModelsByStyle.photorealistic}}
                                    <div class="form-check model-checkbox mb-2">
                                        <input class="form-check-input sd-model-checkbox" type="checkbox" 
                                               value="{{this.modelId}}" 
                                               id="sd-model-{{this.modelId}}" 
                                               data-model="{{this.model}}"
                                               data-model-name="{{this.name}}"
                                               data-model-id="{{this.modelId}}">
                                        <label class="form-check-label text-white" for="sd-model-{{this.modelId}}">
                                            <div class="d-flex align-items-start gap-2">
                                                {{#if this.image}}
                                                <img src="{{this.image}}" 
                                                     alt="{{this.name}}" 
                                                     class="model-thumbnail"
                                                     onerror="this.style.display='none'">
                                                {{/if}}
                                                <div class="flex-grow-1">
                                                    <span class="fw-semibold">{{this.name}}</span>
                                                    <span class="badge bg-warning ms-1">SD</span>
                                                    <br>
                                                    <small class="text-muted">{{this.model}}</small>
                                                </div>
                                            </div>
                                        </label>
                                    </div>
                                    {{/each}}
                                </div>
                                {{/if}}

                                <!-- Other/Uncategorized Models -->
                                {{#if sdModelsByStyle.other.length}}
                                <div class="mb-3">
                                    <h6 class="text-secondary mb-2">
                                        <i class="bi bi-question-circle me-1"></i>Other
                                    </h6>
                                    {{#each sdModelsByStyle.other}}
                                    <div class="form-check model-checkbox mb-2">
                                        <input class="form-check-input sd-model-checkbox" type="checkbox" 
                                               value="{{this.modelId}}" 
                                               id="sd-model-{{this.modelId}}" 
                                               data-model="{{this.model}}"
                                               data-model-name="{{this.name}}"
                                               data-model-id="{{this.modelId}}">
                                        <label class="form-check-label text-white" for="sd-model-{{this.modelId}}">
                                            <div class="d-flex align-items-start gap-2">
                                                {{#if this.image}}
                                                <img src="{{this.image}}" 
                                                     alt="{{this.name}}" 
                                                     class="model-thumbnail"
                                                     onerror="this.style.display='none'">
                                                {{/if}}
                                                <div class="flex-grow-1">
                                                    <span class="fw-semibold">{{this.name}}</span>
                                                    <span class="badge bg-warning ms-1">SD</span>
                                                    <br>
                                                    <small class="text-muted">{{this.model}}</small>
                                                </div>
                                            </div>
                                        </label>
                                    </div>
                                    {{/each}}
                                </div>
                                {{/if}}
                            </div>
                            <button class="btn btn-sm btn-outline-warning mt-2" onclick="selectAllSDModels()">
                                <i class="bi bi-check-all me-1"></i>Select All SD
                            </button>
                        </div>
                        {{else}}
                        <div class="mb-4" id="noSystemSDModelsAlert">
                            <div class="alert alert-info">
                                <small><i class="bi bi-info-circle me-1"></i>No system SD models available. Use "Add Custom Model" above to add your own models for testing.</small>
                            </div>
                        </div>
                        {{/if}}

                        <!-- Style Preset -->
                        <div class="mb-4" id="stylePresetSection">
                            <label class="form-label text-white fw-bold">Style Preset</label>
                            <div class="segmented-control" role="group">
                                <input type="radio" class="btn-check" name="stylePreset" id="style-none" value="" checked>
                                <label class="segment-btn" for="style-none">
                                    <i class="bi bi-slash-circle"></i>
                                    <span>None</span>
                                </label>
                                
                                <input type="radio" class="btn-check" name="stylePreset" id="style-anime" value="anime">
                                <label class="segment-btn" for="style-anime">
                                    <i class="bi bi-palette"></i>
                                    <span>Anime</span>
                                </label>
                                
                                <input type="radio" class="btn-check" name="stylePreset" id="style-photo" value="photorealistic">
                                <label class="segment-btn" for="style-photo">
                                    <i class="bi bi-camera"></i>
                                    <span>Photorealistic</span>
                                </label>
                            </div>
                        </div>

                        <!-- Size Selection -->
                        <div class="mb-4" id="sizeSelectionSection">
                            <label class="form-label text-white fw-bold">Image Size</label>
                            <select class="form-select bg-secondary text-white border-secondary" id="sizeSelect">
                                {{#each sizeOptions}}
                                <option value="{{this.value}}" {{#if (eq this.value "1024*1024")}}selected{{/if}}>
                                    {{this.label}}
                                </option>
                                {{/each}}
                            </select>
                            <div class="form-text text-warning mt-1">
                                <small><i class="bi bi-info-circle me-1"></i>Seedream 4.5 requires min 1920x1920 (auto-scales smaller sizes)</small>
                            </div>
                        </div>

                        <!-- Number of Images per Model -->
                        <div class="mb-4" id="imagesPerModelSection">
                            <label class="form-label text-white fw-bold">Images per Model</label>
                            <select class="form-select bg-secondary text-white border-secondary" id="imagesPerModel">
                                <option value="1" selected>1 image</option>
                                <option value="2">2 images</option>
                                <option value="3">3 images</option>
                                <option value="4">4 images</option>
                            </select>
                            <div class="form-text text-muted mt-1">
                                <small><i class="bi bi-info-circle me-1"></i>Number of images to generate for each selected model</small>
                            </div>
                        </div>

                        <!-- SD Model Parameters (shown when SD models are selected) -->
                        <div class="mb-4" id="sdParamsSection" style="display: none;">
                            <label class="form-label text-white fw-bold">
                                <i class="bi bi-sliders me-1"></i>SD Model Parameters
                            </label>
                            <div class="row g-2">
                                <div class="col-6">
                                    <label class="form-label text-white small">Steps</label>
                                    <input type="number" class="form-control form-control-sm bg-secondary text-white border-secondary" 
                                           id="sdSteps" 
                                           value="30" 
                                           min="1" 
                                           max="100">
                                </div>
                                <div class="col-6">
                                    <label class="form-label text-white small">Guidance Scale</label>
                                    <input type="number" class="form-control form-control-sm bg-secondary text-white border-secondary" 
                                           id="sdGuidanceScale" 
                                           value="7.5" 
                                           min="1" 
                                           max="30" 
                                           step="0.1">
                                </div>
                                <div class="col-12">
                                    <label class="form-label text-white small">Sampler</label>
                                    <select class="form-select form-select-sm bg-secondary text-white border-secondary" id="sdSampler">
                                        <option value="Euler a" selected>Euler a</option>
                                        <option value="Euler">Euler</option>
                                        <option value="DPM++ 2M Karras">DPM++ 2M Karras</option>
                                        <option value="DPM++ SDE Karras">DPM++ SDE Karras</option>
                                        <option value="DDIM">DDIM</option>
                                        <option value="LMS Karras">LMS Karras</option>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label class="form-label text-white small">Negative Prompt</label>
                                    <textarea class="form-control form-control-sm bg-secondary text-white border-secondary" 
                                              id="sdNegativePrompt" 
                                              rows="8" 
                                              placeholder="Optional negative prompt..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Prompt Input -->
                        <div class="mb-4" id="promptInputSection">
                            <label class="form-label text-white fw-bold">Base Prompt</label>
                            <textarea class="form-control bg-secondary text-white border-secondary" 
                                      id="promptInput" 
                                      rows="10" 
                                      placeholder="Enter your prompt here..."
                                      style="min-height: 200px;"
                                      oninput="updateFinalPromptPreview()">A beautiful Japanese woman with long black hair, elegant kimono, cherry blossoms in background, soft lighting</textarea>
                        </div>

                        <!-- Style Preset Preview (shown when a style is selected) -->
                        <div class="mb-4" id="stylePresetPreview" style="display: none;">
                            <label class="form-label text-white fw-bold d-flex justify-content-between align-items-center">
                                <span><i class="bi bi-magic me-1"></i>Final Prompt (Editable)</span>
                                <button type="button" class="btn btn-sm btn-outline-warning" onclick="resetToPreset()">
                                    <i class="bi bi-arrow-counterclockwise me-1"></i>Reset
                                </button>
                            </label>
                            <div class="style-preset-editor">
                                <div class="mb-2">
                                    <small class="text-info">Prefix:</small>
                                    <input type="text" class="form-control form-control-sm bg-dark text-info border-secondary" 
                                           id="stylePrefixInput" 
                                           oninput="updateFinalPromptFromParts()">
                                </div>
                                <div class="mb-2">
                                    <small class="text-white">Your Prompt:</small>
                                    <div class="form-control form-control-sm bg-secondary text-white border-secondary" 
                                         id="stylePromptDisplay" 
                                         style="min-height: 60px; white-space: pre-wrap;"></div>
                                </div>
                                <div class="mb-2">
                                    <small class="text-success">Suffix:</small>
                                    <input type="text" class="form-control form-control-sm bg-dark text-success border-secondary" 
                                           id="styleSuffixInput" 
                                           oninput="updateFinalPromptFromParts()">
                                </div>
                                <hr class="my-2 border-secondary">
                                <div>
                                    <small class="text-warning">Combined Final Prompt:</small>
                                    <textarea class="form-control bg-dark text-warning border-warning" 
                                              id="finalPromptInput" 
                                              rows="8" 
                                              style="font-size: 0.85rem;"></textarea>
                                    <div class="form-text text-muted">
                                        <small>This is what will be sent to the API. Edit freely!</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Cost Display -->
                        <div class="mb-3 rounded-4 overflow-hidden" id="costDisplaySection" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 1px solid rgba(255,255,255,0.1);">
                            <div class="p-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center gap-2">
                                        <div class="rounded-circle d-flex align-items-center justify-content-center" style="width: 36px; height: 36px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                                            <i class="bi bi-lightning-charge-fill text-white"></i>
                                        </div>
                                        <div>
                                            <div class="text-white-50 small">Total Cost</div>
                                            <div class="text-white fw-bold fs-5" id="totalCostDisplay">0</div>
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <div class="text-white-50 small">Your Balance</div>
                                        <div class="fw-bold fs-5" id="userPointsDisplay" style="color: #4ade80;">{{userPoints}}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="px-3 py-2" style="background: rgba(0,0,0,0.2); border-top: 1px solid rgba(255,255,255,0.05);">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="text-white-50 small">
                                        <i class="bi bi-calculator me-1"></i>
                                        <span id="costPerImage">{{imageCostPerUnit}}</span> pts Ã— <span id="imageCountDisplay">0</span> image(s)
                                    </span>
                                    <span class="badge rounded-pill" id="costStatusBadge" style="background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%); color: #000;">
                                        <i class="bi bi-check-circle-fill me-1"></i>Ready
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- Generate Button -->
                        <button class="btn btn-primary btn-lg w-100" id="generateBtn" onclick="startGeneration()">
                            <i class="bi bi-play-fill me-2"></i>Start Generation
                        </button>
                    </div>
                </div>
            </div>

            <!-- Center Panel: Results -->
            <div class="{{#if isAdmin}}col-lg-5{{else}}col-lg-8{{/if}} mb-4">
                <div class="card bg-dark border-secondary h-100">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-image me-2"></i>Generation Results</h5>
                        <span id="totalTimeDisplay" class="badge bg-light text-dark d-none">Total: 0s</span>
                    </div>
                    <div class="card-body" id="resultsContainer" style="min-height: 400px; max-height: 600px; overflow-y: auto;">
                        <div class="text-center text-muted py-5" id="noResultsPlaceholder">
                            <i class="bi bi-image display-1"></i>
                            <p class="mt-3">Select models and click "Start Generation" to begin testing</p>
                        </div>
                    </div>
                </div>
            </div>

            {{#if isAdmin}}
            <!-- Right Panel: Statistics (Admin Only) -->
            <div class="col-lg-3 mb-4">
                <div class="card bg-dark border-secondary mb-4">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="bi bi-bar-chart me-2"></i>Model Statistics</h5>
                    </div>
                    <div class="card-body" id="statsContainer">
                        {{#each models}}
                        <div class="stat-card mb-3 p-3 rounded" data-model-id="{{this.id}}">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="text-white mb-0">{{this.name}}</h6>
                                <span class="badge bg-secondary">{{this.totalTests}} tests</span>
                            </div>
                            <div class="row text-center mb-2">
                                <div class="col-4">
                                    <small class="text-muted d-block">Avg</small>
                                    <span class="text-info fw-bold stat-avg">
                                        {{#if this.averageTime}}
                                        {{divide this.averageTime 1000}}s
                                        {{else}}
                                        --
                                        {{/if}}
                                    </span>
                                </div>
                                <div class="col-4">
                                    <small class="text-muted d-block">Min</small>
                                    <span class="text-success fw-bold stat-min">
                                        {{#if this.minTime}}
                                        {{divide this.minTime 1000}}s
                                        {{else}}
                                        --
                                        {{/if}}
                                    </span>
                                </div>
                                <div class="col-4">
                                    <small class="text-muted d-block">Max</small>
                                    <span class="text-danger fw-bold stat-max">
                                        {{#if this.maxTime}}
                                        {{divide this.maxTime 1000}}s
                                        {{else}}
                                        --
                                        {{/if}}
                                    </span>
                                </div>
                            </div>
                            {{#if this.averageRating}}
                            <div class="text-center mt-2 pt-2 border-top border-secondary">
                                <small class="text-muted d-block mb-1">Average Rating</small>
                                <div class="d-flex justify-content-center align-items-center gap-1">
                                    <span class="text-warning fw-bold stat-rating">{{this.averageRating}}</span>
                                    <i class="bi bi-star-fill text-warning"></i>
                                    <small class="text-muted">({{this.totalRatings}} ratings)</small>
                                </div>
                            </div>
                            {{/if}}
                        </div>
                        {{/each}}
                    </div>
                </div>

                <!-- Default Model Settings (Admin Only) -->
                <div class="card bg-dark border-secondary">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="bi bi-gear me-2"></i>Default Character Models</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label text-white">Anime Style</label>
                            <select class="form-select bg-secondary text-white border-secondary" 
                                    id="defaultAnimeModel" 
                                    onchange="setDefaultModel('anime', this.value)">
                                {{#each models}}
                                <option value="{{this.id}}" {{#if (eq this.id ../defaultModels.anime)}}selected{{/if}}>
                                    {{this.name}}
                                </option>
                                {{/each}}
                            </select>
                        </div>
                        <div class="mb-0">
                            <label class="form-label text-white">Photorealistic Style</label>
                            <select class="form-select bg-secondary text-white border-secondary" 
                                    id="defaultPhotoModel" 
                                    onchange="setDefaultModel('photorealistic', this.value)">
                                {{#each models}}
                                <option value="{{this.id}}" {{#if (eq this.id ../defaultModels.photorealistic)}}selected{{/if}}>
                                    {{this.name}}
                                </option>
                                {{/each}}
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            {{/if}}
        </div>

        <!-- Test History -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card bg-dark border-secondary">
                    <div class="card-header bg-secondary text-white">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>{{#if isAdmin}}Recent Test History{{else}}Your Generation History{{/if}}</h5>
                            <button class="btn btn-sm btn-outline-light" onclick="loadHistory()">
                                <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                            </button>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <label class="text-white small mb-0" for="modelFilter">Filter by Model:</label>
                            <select class="form-select form-select-sm bg-dark text-white border-secondary" 
                                    id="modelFilter" 
                                    style="max-width: 250px;"
                                    onchange="loadHistory()">
                                <option value="">All Models</option>
                                {{#each models}}
                                <option value="{{this.id}}">{{this.name}}</option>
                                {{/each}}
                                {{#if activeSDModels.length}}
                                <option value="sd-txt2img">SD Text to Image</option>
                                {{/if}}
                            </select>
                        </div>
                    </div>
                    <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-dark table-hover" id="historyTable">
                            <thead>
                                <tr>
                                    <th style="width: 80px;">Image</th>
                                    <th>Model</th>
                                    <th>Prompt</th>
                                    <th>Size</th>
                                    <th>Time</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody">
                                {{#each recentTests}}
                                <tr {{#if this.images.length}}data-has-image="true" data-image-url="{{this.images.[0].imageUrl}}" data-model-name="{{this.modelName}}" data-generation-time="{{this.generationTime}}" data-test-id="{{this._id}}" data-prompt="{{this.prompt}}" style="cursor: pointer;"{{/if}}>
                                    <td>
                                        {{#if this.images.length}}
                                        <div class="position-relative d-inline-block">
                                            <img src="{{this.images.[0].imageUrl}}" 
                                                 alt="Generated" 
                                                 class="history-thumbnail cursor-pointer"
                                                 data-image-url="{{this.images.[0].imageUrl}}"
                                                 data-model-name="{{this.modelName}}"
                                                 data-generation-time="{{this.generationTime}}"
                                                 data-test-id="{{this._id}}"
                                                 data-prompt="{{this.prompt}}"
                                                 data-is-nsfw="{{this.isNSFW}}"
                                                 onerror="this.src='/img/placeholder.png'">
                                        </div>
                                        {{else}}
                                        <span class="text-muted">--</span>
                                        {{/if}}
                                    </td>
                                    <td>{{this.modelName}}</td>
                                    <td>
                                        <div class="d-flex align-items-center gap-2">
                                            <span class="text-truncate" style="max-width: 200px; flex: 1;" title="{{this.prompt}}">{{this.prompt}}</span>
                                            <button class="btn btn-sm btn-outline-info copy-prompt-btn" 
                                                    data-prompt="{{json this.prompt}}"
                                                    title="Copy prompt">
                                                <i class="bi bi-clipboard"></i>
                                            </button>
                                        </div>
                                    </td>
                                    <td>{{this.params.size}}</td>
                                    <td>{{#if this.generationTime}}{{divide this.generationTime 1000}}s{{else}}--{{/if}}</td>
                                    <td>
                                        {{#if (eq this.status "completed")}}
                                        <span class="badge bg-success">Completed</span>
                                        {{else if (eq this.status "failed")}}
                                        <span class="badge bg-danger">Failed</span>
                                        {{else}}
                                        <span class="badge bg-warning">{{this.status}}</span>
                                        {{/if}}
                                    </td>
                                    <td>
                                        <span class="small">{{formatDate this.testedAt}}</span>
                                    </td>
                                </tr>
                                {{/each}}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Image Preview Modal -->
    <div class="modal fade" id="imagePreviewModal" tabindex="-1" aria-labelledby="imagePreviewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title" id="imagePreviewModalLabel">Image Preview</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="previewImage" src="" alt="Preview" class="img-fluid rounded">
                    <div class="mt-3">
                        <p id="previewModelName" class="mb-1"></p>
                        <p id="previewTime" class="text-muted mb-0"></p>
                        <p id="previewPrompt" class="text-secondary small mt-2 mb-0" style="display: none;"></p>
                        <div class="mt-3">
                            <label class="form-label text-white mb-2">Rate this image:</label>
                            <div class="rating-stars d-flex justify-content-center gap-1" id="ratingStars">
                                <i class="bi bi-star rating-star" data-rating="1" data-bs-toggle="tooltip" title="1 star"></i>
                                <i class="bi bi-star rating-star" data-rating="2" data-bs-toggle="tooltip" title="2 stars"></i>
                                <i class="bi bi-star rating-star" data-rating="3" data-bs-toggle="tooltip" title="3 stars"></i>
                                <i class="bi bi-star rating-star" data-rating="4" data-bs-toggle="tooltip" title="4 stars"></i>
                                <i class="bi bi-star rating-star" data-rating="5" data-bs-toggle="tooltip" title="5 stars"></i>
                            </div>
                            <small class="text-muted d-block mt-2" id="ratingStatus">Click a star to rate</small>
                        </div>
                        <!-- Save as Draft Post Section -->
                        <div class="mt-4 pt-3 border-top border-secondary">
                            <div class="d-flex justify-content-center gap-2 flex-wrap">
                                <button class="btn btn-outline-primary" id="saveAsDraftBtn" onclick="saveAsDraftPost()">
                                    <i class="bi bi-file-earmark-plus me-1"></i>Save as Draft Post
                                </button>
                                <button class="btn btn-outline-success" id="createCharacterBtn" onclick="openCreateCharacterModal()">
                                    <i class="bi bi-person-plus me-1"></i>Use as Character Base
                                </button>
                                <button class="btn btn-outline-info" id="addToCharacterGalleryBtn" onclick="openAddToGalleryModal()">
                                    <i class="bi bi-images me-1"></i>Add to Character Gallery
                                </button>
                            </div>
                            <small class="text-muted d-block mt-2">
                                Create a new character or add to existing gallery
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Save as Draft Modal -->
    <div class="modal fade" id="saveDraftModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">
                        <i class="bi bi-file-earmark-plus me-2"></i>Save as Draft Post
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <img id="draftPreviewImage" src="" alt="Preview" class="img-fluid rounded mb-3" style="max-height: 200px;">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Caption</label>
                        <textarea class="form-control bg-secondary text-white border-secondary" id="draftCaptionText" rows="8" placeholder="Enter a caption for your post..."></textarea>
                        <small class="text-muted">A caption will be auto-generated if left empty</small>
                    </div>
                    <div class="row g-2 mb-3">
                        <div class="col-md-6">
                            <label class="form-label small">Style</label>
                            <select class="form-select form-select-sm bg-secondary text-white border-secondary" id="draftCaptionStyle">
                                <option value="engaging" selected>Engaging</option>
                                <option value="casual">Casual</option>
                                <option value="professional">Professional</option>
                                <option value="funny">Funny</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small">Language</label>
                            <select class="form-select form-select-sm bg-secondary text-white border-secondary" id="draftCaptionLanguage">
                                <option value="english">ðŸ‡¬ðŸ‡§ English</option>
                                <option value="japanese">ðŸ‡¯ðŸ‡µ æ—¥æœ¬èªž</option>
                                <option value="french">ðŸ‡«ðŸ‡· FranÃ§ais</option>
                                <option value="portuguese">ðŸ‡§ðŸ‡· PortuguÃªs</option>
                                <option value="spanish">ðŸ‡ªðŸ‡¸ EspaÃ±ol</option>
                                <option value="chinese">ðŸ‡¨ðŸ‡³ ä¸­æ–‡</option>
                                <option value="korean">ðŸ‡°ðŸ‡· í•œêµ­ì–´</option>
                                <option value="thai">ðŸ‡¹ðŸ‡­ à¹„à¸—à¸¢</option>
                                <option value="german">ðŸ‡©ðŸ‡ª Deutsch</option>
                                <option value="italian">ðŸ‡®ðŸ‡¹ Italiano</option>
                                <option value="russian">ðŸ‡·ðŸ‡º Ð ÑƒÑÑÐºÐ¸Ð¹</option>
                                <option value="hindi">ðŸ‡®ðŸ‡³ à¤¹à¤¿à¤¨à¥à¤¦à¥€</option>
                            </select>
                        </div>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-outline-info btn-sm" id="generateCaptionBtn" onclick="generateDraftCaption()">
                            <i class="bi bi-magic me-1"></i>Generate Caption with AI
                        </button>
                    </div>
                    <!-- Caption History -->
                    <div id="draftCaptionHistory" class="mt-3"></div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Cancel
                    </button>
                    <button type="button" class="btn btn-primary" id="confirmSaveDraftBtn" onclick="confirmSaveDraft()">
                        <i class="bi bi-check me-1"></i>Save Draft
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- User Model Search Modal -->
    <div class="modal fade civitai-search-modal" id="userModelSearchModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">
                        <i class="bi bi-search me-2"></i>Search & Add Custom Models
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <div class="input-group">
                            <input type="text" 
                                class="form-control bg-secondary text-white border-secondary" 
                                id="userModelSearchInput" 
                                placeholder="Search for SD models (e.g., 'anime', 'realistic', 'portrait'...)"
                                autocomplete="off">
                            <button class="btn btn-primary" type="button" id="userModelSearchBtn">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                        <small class="text-muted">Search through thousands of Stable Diffusion models to add to your collection</small>
                    </div>
                    
                    <!-- Search Results -->
                    <div id="userModelSearchResults">
                        <div class="text-center text-muted py-4" id="userModelSearchPlaceholder">
                            <i class="bi bi-box-seam fs-1 d-block mb-2"></i>
                            <p>Enter a search term to find models</p>
                        </div>
                        <div class="text-center py-4 d-none" id="userModelSearchLoading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 text-muted">Searching models...</p>
                        </div>
                        <div id="userModelSearchResultsList"></div>
                        <div class="text-center py-4 d-none" id="userModelNoResults">
                            <i class="bi bi-emoji-frown fs-1 d-block mb-2 text-muted"></i>
                            <p class="text-muted">No models found</p>
                            <small class="text-muted">Try a different search term</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Character from Image Modal -->
    <div class="modal fade" id="createCharacterModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">
                        <i class="bi bi-person-plus me-2"></i>Create Character from Image
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-5 mb-3">
                            <img id="characterPreviewImage" src="" alt="Character Base" class="img-fluid rounded" style="max-height: 300px;">
                            <p class="text-muted small mt-2" id="characterPromptPreview"></p>
                        </div>
                        <div class="col-md-7">
                            <div class="mb-3">
                                <label class="form-label">Character Name (optional)</label>
                                <input type="text" class="form-control bg-secondary text-white border-secondary" 
                                       id="characterNameInput" placeholder="Leave empty for AI-generated name">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Personality & Background</label>
                                <textarea class="form-control bg-secondary text-white border-secondary" 
                                          id="characterPersonalityInput" rows="8"
                                          placeholder="Describe the character's personality, background, occupation, etc. The AI will use the image prompt combined with your input to create a complete character profile."></textarea>
                                <small class="text-muted">The AI will analyze the image prompt and your input to generate a complete character profile</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Language</label>
                                <select class="form-select bg-secondary text-white border-secondary" id="characterLanguageSelect">
                                    <option value="english">English</option>
                                    <option value="french">FranÃ§ais</option>
                                    <option value="japanese">æ—¥æœ¬èªž</option>
                                </select>
                            </div>
                            <div class="mb-3" id="characterImageModelSection" style="display: none;">
                                <label for="characterImageModelSelect" class="form-label">
                                    <i class="bi bi-palette me-1"></i>Text-to-Image Model
                                </label>
                                <select class="form-select bg-secondary text-white border-secondary" id="characterImageModelSelect">
                                    <!-- Options will be populated dynamically -->
                                </select>
                                <small class="form-text text-muted d-block mt-1">
                                    Select a model for generating images in character chat
                                </small>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="characterNsfwCheck">
                                <label class="form-check-label" for="characterNsfwCheck">
                                    Mark as NSFW
                                </label>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="useImageAsBaseFaceCheck">
                                <label class="form-check-label" for="useImageAsBaseFaceCheck">
                                    <i class="bi bi-person-bounding-box me-1"></i>Use this Image as Base for the Face
                                </label>
                                <small class="d-block text-muted mt-1">When enabled, this face will be automatically merged into future generated images for this character</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="confirmCreateCharacterBtn" onclick="confirmCreateCharacter()">
                        <i class="bi bi-person-plus me-1"></i>Create Character
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Image to Character Gallery Modal -->
    <div class="modal fade" id="addToGalleryModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">
                        <i class="bi bi-images me-2"></i>Add Image to Character Gallery
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <img id="galleryPreviewImage" src="" alt="Image Preview" class="img-fluid rounded" style="max-height: 200px;">
                        </div>
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label class="form-label">Search Character</label>
                                <div class="input-group">
                                    <input type="text" class="form-control bg-secondary text-white border-secondary" 
                                           id="characterSearchInput" placeholder="Search by name...">
                                    <button class="btn btn-primary" type="button" onclick="searchCharactersForGallery()">
                                        <i class="bi bi-search"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="character-search-results" id="characterSearchResults" style="max-height: 300px; overflow-y: auto;">
                                <div class="text-center text-muted py-4">
                                    <i class="bi bi-person-circle display-4"></i>
                                    <p class="mt-2">Search for a character to add this image to their gallery</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-info" id="confirmAddToGalleryBtn" onclick="confirmAddToGallery()" disabled>
                        <i class="bi bi-plus-lg me-1"></i>Add to Gallery
                    </button>
                </div>
            </div>
        </div>
    </div>

    {{> dashboard-footer}}
    <script>
        // Pricing configuration passed from server
        window.PRICING = {
            imageCostPerUnit: {{imageCostPerUnit}},
            faceMergeCost: {{faceMergeCost}},
            userPoints: {{userPoints}}
        };
        // User subscription info for NSFW blur handling
        window.userSubscriptionStatus = {{#if subscriptionStatus}}true{{else}}false{{/if}};
        window.isTemporaryUser = {{#if isTemporary}}true{{else}}false{{/if}};
        // User models data from server (if we want to preload)
        window.userCustomModels = [];
    </script>
    <script src="/js/admin-image-test.js"></script>
</body>
</html>
