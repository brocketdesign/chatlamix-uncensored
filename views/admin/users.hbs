<!DOCTYPE html>
<html lang="ja">
    {{> dashboard-header}}
    <link rel="stylesheet" href="/css/user-analytics.css">
    <link rel="stylesheet" href="/css/pagination.css">
<body class="bg-light">
    {{> dashboard-nav}}
    
    <div class="analytics-wrapper">
        <div class="container-fluid px-3 py-3">
            <!-- Header Section -->
            <div class="dashboard-header-section mb-3">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <div class="page-title-wrapper">
                            <div class="icon-wrapper">
                                <i class="bi bi-people-fill"></i>
                            </div>
                            <div>
                                <h1 class="dashboard-title">{{title}}</h1>
                                <p class="text-muted mb-0" style="font-size: 0.8rem;">Manage and monitor user accounts</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 text-md-end mt-2 mt-md-0">
                        <div class="d-flex justify-content-md-end gap-1 flex-wrap">
                            <a href="/admin/users/analytics" class="btn btn-primary btn-shadow btn-sm">
                                <i class="bi bi-graph-up me-1"></i>Analytics
                            </a>
                            <a href="/admin/nsfw-analytics" class="btn btn-danger btn-shadow btn-sm">
                                <i class="bi bi-fire me-1"></i>NSFW
                            </a>
                            <button id="openCsvModal" class="btn btn-success btn-shadow btn-sm">
                                <i class="bi bi-download me-1"></i>CSV
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats Cards Section -->
            <div class="section-header mb-2">
                <h5 class="section-title">
                    <i class="bi bi-speedometer2 me-2"></i>Quick Stats
                </h5>
            </div>
            
            <div class="row g-2 mb-3">
                <div class="col-xl-3 col-lg-6 col-md-6">
                    <div class="stat-card stat-card-primary">
                        <div class="stat-card-body">
                            <div class="stat-card-content">
                                <div class="stat-info">
                                    <div class="stat-label-wrapper">
                                        <span class="stat-label">Total Users</span>
                                    </div>
                                    <h2 class="stat-value mb-0">{{pagination.totalUsers}}</h2>
                                </div>
                                <div class="stat-icon-wrapper">
                                    <div class="stat-icon"><i class="bi bi-people-fill"></i></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-lg-6 col-md-6">
                    <div class="stat-card stat-card-success">
                        <div class="stat-card-body">
                            <div class="stat-card-content">
                                <div class="stat-info">
                                    <div class="stat-label-wrapper">
                                        <span class="stat-label">Female Users</span>
                                    </div>
                                    <h2 class="stat-value mb-0">{{femaleCount}}</h2>
                                    <p class="stat-change mb-0" style="opacity:0.75"><span class="change-value">{{femalePercentage}}%</span></p>
                                </div>
                                <div class="stat-icon-wrapper">
                                    <div class="stat-icon"><i class="bi bi-gender-female"></i></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-lg-6 col-md-6">
                    <div class="stat-card stat-card-info">
                        <div class="stat-card-body">
                            <div class="stat-card-content">
                                <div class="stat-info">
                                    <div class="stat-label-wrapper">
                                        <span class="stat-label">Male Users</span>
                                    </div>
                                    <h2 class="stat-value mb-0">{{maleCount}}</h2>
                                    <p class="stat-change mb-0" style="opacity:0.75"><span class="change-value">{{malePercentage}}%</span></p>
                                </div>
                                <div class="stat-icon-wrapper">
                                    <div class="stat-icon"><i class="bi bi-gender-male"></i></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-lg-6 col-md-6">
                    <div class="stat-card stat-card-warning">
                        <div class="stat-card-body">
                            <div class="stat-card-content">
                                <div class="stat-info">
                                    <div class="stat-label-wrapper">
                                        <span class="stat-label">Quick Actions</span>
                                    </div>
                                    <div class="mt-2">
                                        <button id="bulkAddToClerk" class="btn btn-secondary btn-sm" style="font-size: 0.75rem;">
                                            <i class="bi bi-key me-1"></i>Bulk Clerk
                                        </button>
                                    </div>
                                </div>
                                <div class="stat-icon-wrapper">
                                    <div class="stat-icon"><i class="bi bi-lightning-charge-fill"></i></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filter Tabs & Search -->
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3 mt-2">
                <div class="d-flex align-items-center gap-2">
                    <a href="/admin/users" class="btn btn-sm btn-outline-dark" style="font-size: 0.8rem;">
                        <i class="bi bi-clock-history me-1"></i>{{translations.admin_user.recent_users}}
                    </a>
                    <a href="/admin/users/registered" class="btn btn-sm btn-outline-dark" style="font-size: 0.8rem;">
                        <i class="bi bi-person-check me-1"></i>{{translations.admin_user.registered_users}}
                    </a>
                </div>
                <div class="user-search-bar">
                    <form id="userSearchForm" method="GET" class="d-flex align-items-center gap-2" style="margin: 0;">
                        <div class="input-group input-group-sm" style="width: 280px;">
                            <span class="input-group-text" style="background: #fff; border-right: 0; border-color: #ddd;">
                                <i class="bi bi-search" style="font-size: 0.75rem; color: #999;"></i>
                            </span>
                            <input type="text" id="userSearchInput" name="search" class="form-control form-control-sm"
                                placeholder="Search by name, nickname, or email..."
                                value="{{searchQuery}}"
                                style="font-size: 0.8rem; border-left: 0; border-color: #ddd;">
                            {{#if searchQuery}}
                            <button type="button" id="clearSearch" class="btn btn-sm btn-outline-secondary" style="font-size: 0.75rem; border-color: #ddd;">
                                <i class="bi bi-x-lg"></i>
                            </button>
                            {{/if}}
                        </div>
                    </form>
                </div>
            </div>

            <div class="table-with-pagination">
                <!-- Top Pagination -->
                <div class="pagination-container">
                    <div class="pagination-info">
                        <span>Showing</span>
                        <strong id="start-index">{{#if users}}1{{else}}0{{/if}}</strong>
                        <span>-</span>
                        <strong id="end-index">{{users.length}}</strong>
                        <span>of</span>
                        <strong id="total-count">{{pagination.totalUsers}}</strong>
                    </div>
                    <div class="items-per-page">
                        <label for="pageSize">Rows:</label>
                        <select id="pageSize">
                            <option value="10" {{#if (eq pagination.limit 10)}}selected{{/if}}>10</option>
                            <option value="15" {{#if (eq pagination.limit 15)}}selected{{/if}}>15</option>
                            <option value="25" {{#if (eq pagination.limit 25)}}selected{{/if}}>25</option>
                            <option value="50" {{#if (eq pagination.limit 50)}}selected{{/if}}>50</option>
                            <option value="100" {{#if (eq pagination.limit 100)}}selected{{/if}}>100</option>
                        </select>
                    </div>
                </div>

                <div class="chart-card card-shadow">
                    <div class="chart-card-body p-0">
                        <div class="table-responsive" style="max-height: 70vh; overflow-y: auto;">
                            <table class="table table-hover mb-0" id="usersTable">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>{{translations.admin_user.avatar}}</th>
                                        <th>{{translations.admin_user.date}}</th>
                                        <th>{{translations.admin_user.email}}</th>
                                        <th>{{translations.admin_user.gender}}</th>
                                        <th>{{translations.admin_user.language}}</th>
                                        <th>{{translations.admin_user.subscription}}</th>
                                        <th>{{translations.admin_user.actions}}</th>
                                        <th>{{translations.admin_user.profile}}</th>
                                        <th>Clerk</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {{#each users}}
                                    <tr data-user-id="{{this._id}}">
                                        <td>{{increment (add @index (subtract (multiply (subtract pagination.page 1) pagination.limit) 1))}}</td>
                                        <td>
                                            <a href="/user/{{this._id}}" target="_blank" style="text-decoration:none;">
                                                <div class="d-flex align-items-center gap-2">
                                                    {{#if this.profileUrl}}
                                                        <img src="{{this.profileUrl}}" alt="{{this.nickname}}" class="rounded-circle" style="width:28px;height:28px;object-fit:cover;">
                                                    {{else}}
                                                        <div class="rounded-circle d-flex align-items-center justify-content-center" style="width:28px;height:28px;background:#1a73e8;color:white;font-size:0.7rem;font-weight:600;">
                                                            {{substring this.nickname 0 1}}
                                                        </div>
                                                    {{/if}}
                                                    <span class="nickname" style="font-size:0.75rem;color:#333;">{{this.nickname}}</span>
                                                </div>
                                            </a>
                                        </td>
                                        <td class="jp-d" style="font-size:0.75rem;color:#666;">{{this.createdAt}}</td>
                                        <td style="font-size:0.75rem;">{{this.email}}</td>
                                        <td>
                                            {{#if (eq this.gender "female")}}
                                                <span class="badge" style="background:#e91e63;color:#fff;">F</span>
                                            {{else}}
                                                <span class="badge" style="background:#2196f3;color:#fff;">M</span>
                                            {{/if}}
                                        </td>
                                        <td>
                                            <span class="badge" style="background:#f5f5f5;color:#333;">{{this.lang}}</span>
                                        </td>
                                        <td class="subscriptionStatus">
                                            {{#if (eq this.subscriptionStatus "premium")}}
                                                <span class="badge" style="background:#ff9800;color:#fff;"><i class="bi bi-star-fill" style="font-size:0.6rem;"></i> Pro</span>
                                            {{else}}
                                                <span class="badge" style="background:#f5f5f5;color:#999;">Free</span>
                                            {{/if}}
                                        </td>
                                        <td>
                                            <div class="d-flex gap-1">
                                                <button class="btn btn-sm btn-outline-secondary subscriptionToggle" data-user-id="{{this._id}}" title="Toggle Subscription">
                                                    <i class="bi bi-pencil-square"></i>
                                                </button>
                                                <a class="btn btn-sm btn-outline-secondary" href="/admin/chat/{{this._id}}" title="View Chat">
                                                    <i class="bi bi-chat-dots"></i>
                                                </a>
                                                <button class="btn btn-sm btn-outline-danger delete-user" data-user-id="{{this._id}}" title="Delete User">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                        <td>
                                            <a href="/user/{{this._id}}" target="_blank" class="btn btn-sm btn-outline-primary">
                                                <i class="bi bi-box-arrow-up-right"></i>
                                            </a>
                                        </td>
                                        <td>
                                            {{#if this.clerkId}}
                                                <button class="btn btn-sm btn-success check-clerk-status" data-user-id="{{this._id}}" data-user-email="{{this.email}}" data-clerk-id="{{this.clerkId}}" title="In Clerk">
                                                    <i class="bi bi-check-circle-fill"></i>
                                                </button>
                                            {{else}}
                                                <button class="btn btn-sm btn-outline-info check-clerk-status" data-user-id="{{this._id}}" data-user-email="{{this.email}}" title="Add to Clerk">
                                                    <i class="bi bi-key-fill"></i>
                                                </button>
                                            {{/if}}
                                        </td>
                                    </tr>
                                    {{/each}}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Bottom Pagination -->
                <div class="pagination-container pagination-sticky">
                    <div class="pagination-info">
                        <span>Page</span>
                        <strong id="current-page">{{pagination.page}}</strong>
                        <span>of</span>
                        <strong id="total-pages">{{pagination.totalPages}}</strong>
                    </div>
                    <div class="pagination-controls" id="paginationControls">
                        {{#if pagination.hasPrevPage}}
                            <a href="?page=1&limit={{pagination.limit}}{{#if searchQuery}}&search={{searchQuery}}{{/if}}" class="pagination-btn prev-btn" title="First Page">
                                <i class="bi bi-chevron-double-left"></i>
                            </a>
                            <a href="?page={{subtract pagination.page 1}}&limit={{pagination.limit}}{{#if searchQuery}}&search={{searchQuery}}{{/if}}" class="pagination-btn prev-btn" title="Previous Page">
                                <i class="bi bi-chevron-left"></i> Prev
                            </a>
                        {{else}}
                            <button class="pagination-btn prev-btn" disabled>
                                <i class="bi bi-chevron-double-left"></i>
                            </button>
                            <button class="pagination-btn prev-btn" disabled>
                                <i class="bi bi-chevron-left"></i> Prev
                            </button>
                        {{/if}}

                        {{#each (range 1 (add pagination.totalPages 1))}}
                            {{#if (eq this ../pagination.page)}}
                                <button class="pagination-btn page-number active" disabled>{{this}}</button>
                            {{else}}
                                {{#if (and (gte this (subtract ../pagination.page 2)) (lte this (add ../pagination.page 2)))}}
                                    <a href="?page={{this}}&limit={{../pagination.limit}}{{#if ../searchQuery}}&search={{../searchQuery}}{{/if}}" class="pagination-btn page-number">{{this}}</a>
                                {{/if}}
                            {{/if}}
                        {{/each}}

                        {{#if pagination.hasNextPage}}
                            <a href="?page={{add pagination.page 1}}&limit={{pagination.limit}}{{#if searchQuery}}&search={{searchQuery}}{{/if}}" class="pagination-btn next-btn" title="Next Page">
                                Next <i class="bi bi-chevron-right"></i>
                            </a>
                            <a href="?page={{pagination.totalPages}}&limit={{pagination.limit}}{{#if searchQuery}}&search={{searchQuery}}{{/if}}" class="pagination-btn next-btn" title="Last Page">
                                <i class="bi bi-chevron-double-right"></i>
                            </a>
                        {{else}}
                            <button class="pagination-btn next-btn" disabled>
                                Next <i class="bi bi-chevron-right"></i>
                            </button>
                            <button class="pagination-btn next-btn" disabled>
                                <i class="bi bi-chevron-double-right"></i>
                            </button>
                        {{/if}}
                    </div>
                </div>
            </div>

    <!-- CSV Modal -->
    <div class="modal fade modal-dialog-scrollable" id="csvModal" tabindex="-1" aria-labelledby="csvModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content" style="border-radius: 20px; border: none; box-shadow: 0 10px 40px rgba(0,0,0,0.15);">
                <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 20px 20px 0 0;">
                    <h5 class="modal-title" id="csvModalLabel">
                        <i class="bi bi-file-earmark-spreadsheet me-2"></i>{{translations.admin_user.column_csv}}
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <!-- User Type Selection -->
                    <div class="mb-4">
                        <h6 class="fw-bold mb-3">
                            <i class="bi bi-people me-2"></i>User Type
                        </h6>
                        <div class="segmented-control segmented-control-light">
                            <input type="radio" class="btn-check" name="userType" id="userTypeRegistered" value="registered" checked>
                            <label class="segment-btn" for="userTypeRegistered">
                                <i class="bi bi-person-check"></i>
                                <span>Registered</span>
                            </label>
                            
                            <input type="radio" class="btn-check" name="userType" id="userTypeRecent" value="recent">
                            <label class="segment-btn" for="userTypeRecent">
                                <i class="bi bi-clock-history"></i>
                                <span>Recent</span>
                            </label>
                            
                            <input type="radio" class="btn-check" name="userType" id="userTypeAll" value="all">
                            <label class="segment-btn" for="userTypeAll">
                                <i class="bi bi-people-fill"></i>
                                <span>All Users</span>
                            </label>
                        </div>
                    </div>

                    <!-- Field Selection -->
                    <div class="mb-3">
                        <h6 class="fw-bold mb-3">
                            <i class="bi bi-table me-2"></i>Select Fields to Export
                        </h6>
                        <div class="row g-2">
                            <div class="col-md-6">
                                <h6 class="text-muted small">Basic Information</h6>
                                <div class="d-flex flex-wrap gap-2 mb-3">
                                    <button type="button" class="btn btn-outline-primary field-btn" data-field="createdAt" style="border-radius: 8px;">
                                        <i class="bi bi-calendar-event me-1"></i>{{translations.admin_user.date}}
                                    </button>
                                    <button type="button" class="btn btn-outline-primary field-btn" data-field="email" style="border-radius: 8px;">
                                        <i class="bi bi-envelope me-1"></i>{{translations.admin_user.email}}
                                    </button>
                                    <button type="button" class="btn btn-outline-primary field-btn" data-field="nickname" style="border-radius: 8px;">
                                        <i class="bi bi-person me-1"></i>{{translations.admin_user.name}}
                                    </button>
                                    <button type="button" class="btn btn-outline-primary field-btn" data-field="username" style="border-radius: 8px;">
                                        <i class="bi bi-at me-1"></i>Username
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-muted small">Demographics</h6>
                                <div class="d-flex flex-wrap gap-2 mb-3">
                                    <button type="button" class="btn btn-outline-primary field-btn" data-field="gender" style="border-radius: 8px;">
                                        <i class="bi bi-gender-ambiguous me-1"></i>{{translations.admin_user.gender}}
                                    </button>
                                    <button type="button" class="btn btn-outline-primary field-btn" data-field="lang" style="border-radius: 8px;">
                                        <i class="bi bi-globe me-1"></i>{{translations.admin_user.language}}
                                    </button>
                                    <button type="button" class="btn btn-outline-primary field-btn" data-field="birthDate" style="border-radius: 8px;">
                                        <i class="bi bi-cake me-1"></i>Birth Date
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="row g-2">
                            <div class="col-md-6">
                                <h6 class="text-muted small">Account Status</h6>
                                <div class="d-flex flex-wrap gap-2 mb-3">
                                    <button type="button" class="btn btn-outline-primary field-btn" data-field="subscriptionStatus" style="border-radius: 8px;">
                                        <i class="bi bi-star me-1"></i>{{translations.admin_user.subscription}}
                                    </button>
                                    <button type="button" class="btn btn-outline-primary field-btn" data-field="points" style="border-radius: 8px;">
                                        <i class="bi bi-coin me-1"></i>Points
                                    </button>
                                    <button type="button" class="btn btn-outline-primary field-btn" data-field="clerkId" style="border-radius: 8px;">
                                        <i class="bi bi-key me-1"></i>Clerk ID
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-muted small">Profile Data</h6>
                                <div class="d-flex flex-wrap gap-2 mb-3">
                                    <button type="button" class="btn btn-outline-primary field-btn" data-field="bio" style="border-radius: 8px;">
                                        <i class="bi bi-chat-text me-1"></i>Bio
                                    </button>
                                    <button type="button" class="btn btn-outline-primary field-btn" data-field="profileUrl" style="border-radius: 8px;">
                                        <i class="bi bi-image me-1"></i>Profile Image
                                    </button>
                                    <button type="button" class="btn btn-outline-primary field-btn" data-field="ageVerification" style="border-radius: 8px;">
                                        <i class="bi bi-shield-check me-1"></i>Age Verified
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Select Options -->
                    <div class="mb-3">
                        <h6 class="text-muted small mb-2">Quick Select</h6>
                        <div class="d-flex flex-wrap gap-2">
                            <button type="button" class="btn btn-outline-secondary btn-sm quick-select" data-fields="createdAt,email,nickname,gender,subscriptionStatus" style="border-radius: 8px;">
                                Basic Info
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm quick-select" data-fields="createdAt,email,nickname,gender,lang,subscriptionStatus,points" style="border-radius: 8px;">
                                Standard Export
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm quick-select" data-fields="createdAt,email,nickname,username,gender,lang,birthDate,subscriptionStatus,points,clerkId,bio,ageVerification" style="border-radius: 8px;">
                                Complete Profile
                            </button>
                            <button type="button" class="btn btn-outline-warning btn-sm" id="selectAllFields" style="border-radius: 8px;">
                                Select All
                            </button>
                            <button type="button" class="btn btn-outline-danger btn-sm" id="clearAllFields" style="border-radius: 8px;">
                                Clear All
                            </button>
                        </div>
                    </div>

                    <!-- Advanced Options -->
                    <div class="mb-3">
                        <h6 class="text-muted small mb-2">Advanced Options</h6>
                        <div class="form-check p-3" style="background: #f8f9fa; border-radius: 12px;">
                            <input class="form-check-input" type="checkbox" value="" id="includeAnalytics">
                            <label class="form-check-label fw-bold" for="includeAnalytics">
                                <i class="bi bi-graph-up me-1"></i>Include Analytics Data
                            </label>
                            <small class="form-text text-muted d-block mt-1">
                                Adds columns for total images generated, total messages, and total chats per user. 
                                <strong>Note:</strong> This will significantly increase export time for large datasets.
                            </small>
                        </div>
                    </div>

                    <input type="hidden" id="selectedFields" name="fields">
                    <input type="hidden" id="selectedUserType" name="userType" value="registered">
                </div>
                <div class="modal-footer" style="border-top: 1px solid #f0f0f0;">
                    <div class="d-flex justify-content-between align-items-center w-100">
                        <small class="text-muted">
                            <span id="exportInfo"></span>
                        </small>
                        <div>
                            <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal" style="border-radius: 12px;">
                                Cancel
                            </button>
                            <button id="submitCsv" type="button" class="btn btn-success" style="border-radius: 12px;">
                                <i class="bi bi-download me-2"></i>{{translations.admin_user.download_csv}}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete User Modal -->
    <div class="modal fade" id="deleteUserModal" tabindex="-1" aria-labelledby="deleteUserModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content" style="border-radius: 20px; border: none; box-shadow: 0 10px 40px rgba(0,0,0,0.15);">
                <div class="modal-header" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; border-radius: 20px 20px 0 0;">
                    <h5 class="modal-title" id="deleteUserModalLabel">
                        <i class="bi bi-exclamation-triangle me-2"></i>{{translations.admin_user.delete}}
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <p>{{translations.admin_user.delete_confirm}}</p>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #f0f0f0;">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="border-radius: 12px;">{{translations.admin_user.cancel}}</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteUser" style="border-radius: 12px;">{{translations.admin_user.delete}}</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add to Clerk Modal -->
    <div class="modal fade" id="addToClerkModal" tabindex="-1" aria-labelledby="addToClerkModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content" style="border-radius: 20px; border: none; box-shadow: 0 10px 40px rgba(0,0,0,0.15);">
                <div class="modal-header" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; border-radius: 20px 20px 0 0;">
                    <h5 class="modal-title" id="addToClerkModalLabel">
                        <i class="bi bi-key me-2"></i>Add User to Clerk
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <p>Add <span id="clerkUserEmail" class="fw-bold"></span> to Clerk authentication system?</p>
                    <div class="mb-3">
                        <input type="hidden" id="clerkUserId">
                        <div class="form-check mb-3 p-3" style="background: #f8f9fa; border-radius: 12px;">
                            <input class="form-check-input" type="checkbox" value="" id="sendEmailInvite" checked>
                            <label class="form-check-label fw-bold" for="sendEmailInvite">
                                Send email invitation
                            </label>
                            <small class="form-text text-muted d-block mt-1">
                                Clerk will automatically send an invitation email to the user
                            </small>
                        </div>
                        <div class="form-check p-3" style="background: #f8f9fa; border-radius: 12px;">
                            <input class="form-check-input" type="checkbox" value="" id="skipPasswordCreation">
                            <label class="form-check-label fw-bold" for="skipPasswordCreation">
                                Skip password creation
                            </label>
                            <small class="form-text text-muted d-block mt-1">
                                When checked, users can sign in using OAuth only (Google, etc.)
                            </small>
                        </div>
                    </div>
                    <div id="clerkAddStatus" class="alert d-none" style="border-radius: 12px;"></div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #f0f0f0;">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="border-radius: 12px;">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmAddToClerk" style="border-radius: 12px;">Add to Clerk</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Add to Clerk Modal -->
    <div class="modal fade" id="bulkAddToClerkModal" tabindex="-1" aria-labelledby="bulkAddToClerkModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" style="border-radius: 20px; border: none; box-shadow: 0 10px 40px rgba(0,0,0,0.15);">
                <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 20px 20px 0 0;">
                    <h5 class="modal-title" id="bulkAddToClerkModalLabel">
                        <i class="bi bi-people-fill me-2"></i>Bulk Add to Clerk
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <p>This will check all users and add those not in Clerk to the Clerk authentication system.</p>
                    <div class="mb-3">
                        <div class="form-check mb-3 p-3" style="background: #f8f9fa; border-radius: 12px;">
                            <input class="form-check-input" type="checkbox" value="" id="bulkSendEmailInvite" checked>
                            <label class="form-check-label fw-bold" for="bulkSendEmailInvite">
                                Have Clerk send email invitations
                            </label>
                            <small class="form-text text-muted d-block mt-1">
                                When checked, Clerk will automatically send invitation emails to users
                            </small>
                        </div>
                        <div class="form-check p-3" style="background: #f8f9fa; border-radius: 12px;">
                            <input class="form-check-input" type="checkbox" value="" id="bulkSkipPasswordCreation">
                            <label class="form-check-label fw-bold" for="bulkSkipPasswordCreation">
                                Skip password creation
                            </label>
                            <small class="form-text text-muted d-block mt-1">
                                When checked, users can sign in using OAuth only (Google, etc.)
                            </small>
                        </div>
                    </div>
                    <div class="alert alert-info" style="border-radius: 12px; border: none; background: linear-gradient(135deg, #d4e9ff 0%, #e8f4ff 100%);">
                        <i class="bi bi-info-circle me-2"></i>
                        <small>
                            You can add users to Clerk without sending invitation emails by unchecking the first option. 
                            Users will still be able to sign in if they visit your application, but won't receive an automatic invitation.
                        </small>
                    </div>
                    <div id="bulkAddProgress" class="progress d-none" style="height: 25px; border-radius: 12px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                    </div>
                    <div id="bulkAddStatus" class="mt-3"></div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #f0f0f0;">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="border-radius: 12px;">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmBulkAddToClerk" style="border-radius: 12px;">
                        <i class="bi bi-play-fill me-1"></i>Start Process
                    </button>
                </div>
            </div>
        </div>
    </div>

    <style>.sticky-bottom, #footer-toolbar {display:none;}</style>
    {{> dashboard-footer}}
    
    <script>
    $(document).ready(function(){
        // ============================================
        // USER SEARCH HANDLER
        // ============================================
        const searchForm = document.getElementById('userSearchForm');
        const searchInput = document.getElementById('userSearchInput');
        const clearSearchBtn = document.getElementById('clearSearch');

        if (searchForm) {
            searchForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const searchValue = searchInput.value.trim();
                const currentUrl = new URL(window.location);
                if (searchValue) {
                    currentUrl.searchParams.set('search', searchValue);
                } else {
                    currentUrl.searchParams.delete('search');
                }
                currentUrl.searchParams.set('page', 1);
                window.location.href = currentUrl.toString();
            });
        }

        if (clearSearchBtn) {
            clearSearchBtn.addEventListener('click', function() {
                const currentUrl = new URL(window.location);
                currentUrl.searchParams.delete('search');
                currentUrl.searchParams.set('page', 1);
                window.location.href = currentUrl.toString();
            });
        }

        $("#openCsvModal").click(function(){
            $("#csvModal").modal('show');
            updateExportInfo(); // Initialize export info when modal opens
        });
        
        // Field selection functionality
        $('.field-btn').click(function(){
            $(this).toggleClass('selected');
            if($(this).hasClass('selected')){
                $(this).removeClass('btn-outline-primary').addClass('btn-primary');
            } else {
                $(this).removeClass('btn-primary').addClass('btn-outline-primary');
            }
            updateSelectedFields();
        });

        // User type selection
        $('input[name="userType"]').change(function(){
            $('#selectedUserType').val($(this).val());
            updateExportInfo();
        });

        // Analytics checkbox
        $('#includeAnalytics').change(function(){
            updateExportInfo();
        });

        // Quick select functionality
        $('.quick-select').click(function(){
            var fieldsToSelect = $(this).data('fields').split(',');
            $('.field-btn').removeClass('selected btn-primary').addClass('btn-outline-primary');
            fieldsToSelect.forEach(function(field){
                $('.field-btn[data-field="' + field + '"]')
                    .addClass('selected btn-primary')
                    .removeClass('btn-outline-primary');
            });
            updateSelectedFields();
        });

        // Select all fields
        $('#selectAllFields').click(function(){
            $('.field-btn')
                .addClass('selected btn-primary')
                .removeClass('btn-outline-primary');
            updateSelectedFields();
        });

        // Clear all fields
        $('#clearAllFields').click(function(){
            $('.field-btn')
                .removeClass('selected btn-primary')
                .addClass('btn-outline-primary');
            updateSelectedFields();
        });

        function updateSelectedFields() {
            var fields = [];
            $('.field-btn.selected').each(function(){
                fields.push($(this).data('field'));
            });
            $('#selectedFields').val(fields.join(','));
            updateExportInfo();
        }

        function updateExportInfo() {
            var selectedCount = $('.field-btn.selected').length;
            var userType = $('input[name="userType"]:checked').val() || 'registered';
            var includeAnalytics = $('#includeAnalytics').is(':checked');
            
            var userTypeText = userType === 'registered' ? 'Registered Users' : 
                              userType === 'recent' ? 'Recent Users' : 'All Users';
            
            var info = `${selectedCount} fields selected | ${userTypeText}`;
            if (includeAnalytics) {
                info += ' | With Analytics';
            }
            
            $('#exportInfo').text(info);
        }

        $("#submitCsv").click(function(){
            var fields = $('#selectedFields').val();
            var userType = $('#selectedUserType').val();
            var includeAnalytics = $('#includeAnalytics').is(':checked');
            
            if (!fields) {
                Swal.fire('Error', 'Please select at least one field to export', 'error');
                return;
            }
            
            var baseUrl = includeAnalytics ? '/admin/users/csv/enhanced' : '/admin/users/csv';
            var query = '?fields=' + fields + '&userType=' + userType;
            
            if (includeAnalytics) {
                query += '&includeStats=true';
            }
            
            // Show different loading messages for analytics
            var loadingText = includeAnalytics ? 
                '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Generating with Analytics...' :
                '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Generating...';
            
            // Show loading indicator
            $(this).prop('disabled', true).html(loadingText);
            
            // Show additional warning for analytics export
            if (includeAnalytics) {
                Swal.fire({
                    title: 'Generating Enhanced Export',
                    text: 'This may take a while to calculate analytics for all users...',
                    icon: 'info',
                    showConfirmButton: false,
                    allowOutsideClick: false,
                    timer: 3000
                });
            }
            
            // Create a temporary link to trigger download
            var link = document.createElement('a');
            link.href = baseUrl + query;
            link.download = ''; // Browser will use filename from Content-Disposition header
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Reset button after a longer delay for analytics
            var resetDelay = includeAnalytics ? 5000 : 2000;
            setTimeout(() => {
                $(this).prop('disabled', false).html('<i class="bi bi-download me-2"></i>{{translations.admin_user.download_csv}}');
                $('#csvModal').modal('hide');
                if (includeAnalytics) {
                    Swal.fire('Success', 'Enhanced export with analytics data has been generated!', 'success');
                }
            }, resetDelay);
        });

        // Function to check if user exists in Clerk
        function checkClerkStatus(userId, email, clerkId) {
            if (!email) {
                Swal.fire('Error', 'User does not have an email address', 'error');
                return;
            }
            
            // If we already know the user has a clerkId, show that info
            if (clerkId) {
                Swal.fire('User Found', `User already exists in Clerk with ID: ${clerkId}`, 'info');
                return;
            }
            
            $.ajax({
                url: '/admin/clerk/check-user',
                type: 'GET',
                data: { email },
                success: function(response) {
                    if (response.exists) {
                        // Update button to show user is already in Clerk
                        $(`button.check-clerk-status[data-user-id="${userId}"]`)
                            .removeClass('btn-outline-info')
                            .addClass('btn-success')
                            .html('<i class="bi bi-check"></i>')
                            .attr('data-clerk-id', response.clerkId);
                            
                        Swal.fire('User Found', `User already exists in Clerk with ID: ${response.clerkId}`, 'info');
                    } else {
                        // Show modal to add user to Clerk
                        $('#clerkUserId').val(userId);
                        $('#clerkUserEmail').text(email);
                        $('#clerkAddStatus').addClass('d-none').removeClass('alert-success alert-danger');
                        $('#addToClerkModal').modal('show');
                    }
                },
                error: function(xhr) {
                    Swal.fire('Error', xhr.responseJSON?.error || 'Failed to check Clerk status', 'error');
                }
            });
        }

        // Click handler for checking Clerk status
        $('.check-clerk-status').click(function() {
            const userId = $(this).data('user-id');
            const email = $(this).data('user-email');
            const clerkId = $(this).data('clerk-id');
            checkClerkStatus(userId, email, clerkId);
        });

        // Click handler for adding user to Clerk
        $('#confirmAddToClerk').click(function() {
            const userId = $('#clerkUserId').val();
            const sendEmailInvite = $('#sendEmailInvite').is(':checked');
            const skipPasswordCreation = $('#skipPasswordCreation').is(':checked');
            
            // Disable button and show loading state
            $(this).prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Adding...');
            
            $.ajax({
                url: '/admin/clerk/add-user',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    userId,
                    sendEmailInvite,
                    skipPasswordCreation
                }),
                success: function(response) {
                    $('#clerkAddStatus')
                        .removeClass('d-none alert-danger')
                        .addClass('alert-success')
                        .html(`User added to Clerk successfully! Clerk ID: ${response.clerkId}`);
                    // Update button in table to show success
                    $(`button.check-clerk-status[data-user-id="${userId}"]`)
                        .removeClass('btn-outline-info')
                        .addClass('btn-success')
                        .html('<i class="bi bi-check"></i>');
                        
                    // Re-enable button table to show success table to show success
                    $('#confirmAddToClerk').prop('disabled', false).text('Add to Clerk');
                },
                error: function(xhr) {
                    $('#clerkAddStatus')
                        .removeClass('d-none alert-success')
                        .addClass('alert-danger')
                        .text(xhr.responseJSON?.error || 'Failed to add user to Clerk');
                    // Re-enable button
                    $('#confirmAddToClerk').prop('disabled', false).text('Add to Clerk');
                }
            });
        });

        // Click handler for opening bulk add modal
        $('#bulkAddToClerk').click(function() {
            $('#bulkAddProgress').addClass('d-none');
            $('#bulkAddStatus').empty();
            $('#bulkAddToClerkModal').modal('show');
        });

        // Click handler for bulk adding users to Clerk
        $('#confirmBulkAddToClerk').click(function() {
            const sendEmailInvite = $('#bulkSendEmailInvite').is(':checked');
            const skipPasswordCreation = $('#bulkSkipPasswordCreation').is(':checked');
            
            // Get all user IDs and emails from the table
            const users = [];
            $('.check-clerk-status').each(function() {
                // Skip users who already have a clerkId
                if (!$(this).data('clerk-id')) {
                    users.push({
                        userId: $(this).data('user-id'),
                        email: $(this).data('user-email')
                    });
                }
            });
            const totalUsers = users.length;
            if (totalUsers === 0) {
                $('#bulkAddStatus').html('<div class="alert alert-warning">No users found to process</div>');
                return;
            }
            // Disable button and show progress
            $(this).prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...');
            $('#bulkAddProgress').removeClass('d-none');
            $('#bulkAddStatus').html('<div class="mt-3">Processing users...</div>');
            
            // Start the bulk process
            $.ajax({
                url: '/admin/clerk/bulk-add-users',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    users,
                    sendEmailInvite,
                    skipPasswordCreation
                }),
                success: function(response) {
                    updateBulkProgress(100);
                    
                    let statusHtml = '<div class="alert alert-success mt-3">';
                    statusHtml += `<p>Processed ${response.total} users</p>`;
                    statusHtml += `<p>Added to Clerk: ${response.added}</p>`;
                    statusHtml += `<p>Already in Clerk: ${response.existing}</p>`;
                    statusHtml += `<p>Failed: ${response.failed}</p>`;
                    statusHtml += '</div>';
                    
                    $('#bulkAddStatus').html(statusHtml);
                    
                    // Update UI for buttons
                    response.results.forEach(result => {
                        if (result.added) {
                            $(`button.check-clerk-status[data-user-id="${result.userId}"]`)
                                .removeClass('btn-outline-info')
                                .addClass('btn-success')
                                .html('<i class="bi bi-check"></i>');
                        }
                    });
                    
                    // Re-enable button
                    $('#confirmBulkAddToClerk').prop('disabled', false).text('Start Process');
                },
                error: function(xhr) {
                    $('#bulkAddStatus').html(`<div class="alert alert-danger mt-3">${xhr.responseJSON?.error || 'Failed to process bulk add'}</div>`);
                    $('#confirmBulkAddToClerk').prop('disabled', false).text('Start Process');
                }
            });
            
            // Setup progress monitoring
            let progress = 0;
            const progressInterval = setInterval(function() {
                $.ajax({
                    url: '/admin/clerk/bulk-progress',
                    type: 'GET',
                    success: function(response) {
                        updateBulkProgress(response.progress);
                        if (response.progress >= 100) {
                            clearInterval(progressInterval);
                        }
                    }
                });
            }, 1000);
            
            function updateBulkProgress(percent) {
                const progressBar = $('#bulkAddProgress .progress-bar');
                progressBar.css('width', percent + '%');
                progressBar.attr('aria-valuenow', percent);
                progressBar.text(percent + '%');
            }
        });

        function convertToJapaneseDate(dateString) {
            var options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric', 
                weekday: 'long', 
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit', 
                hour12: false // Use 24-hour format
            };
            var date = new Date(dateString);
            return date.toLocaleDateString('ja-JP', options);
        }
        
        $('.jp-d').each(function() {
            var originalDate = $(this).text();
            var japaneseDate = convertToJapaneseDate(originalDate);
            $(this).text(japaneseDate);
        });
        
        $('.ip-agent').each(function() {
            var original = $(this).text();
            var newText = original.split('-')[0];
            $(this).text(newText);
        });

        $('.subscriptionToggle').on('click', function() {
            var userId = $(this).data('user-id');
            $.ajax({
                type: 'PUT',
                url: '/admin/users/' + userId + '/subscription',
                success: function(response) {
                    console.log('Subscription toggled successfully!');
                    const subscriptionStatus = response.subscriptionStatus;
                    // Update the subscription status in the table
                    $(`tr[data-user-id="${userId}"] .subscriptionStatus`).text(subscriptionStatus);
                },
                error: function(xhr, status, error) {
                    console.log('Error toggling subscription:', error);
                    Swal.fire('Error!', 'Failed to toggle subscription.', 'error');
                }
            });
        });

        // Store the user ID to be deleted
        let userIdToDelete;

        $('.delete-user').on('click', function() {
            userIdToDelete = $(this).data('user-id');
            // Show the Bootstrap modal instead of SweetAlert
            var deleteModal = new bootstrap.Modal(document.getElementById('deleteUserModal'));
            deleteModal.show();
        });

        // Handle the confirm delete action
        $('#confirmDeleteUser').on('click', function() {
            if (userIdToDelete) {
                $.ajax({
                    type: 'DELETE',
                    url: '/admin/users/' + userIdToDelete,
                    success: function() {
                        console.log('User deleted successfully!');
                        $(`tr[data-user-id="${userIdToDelete}"]`).hide();
                        // Hide the modal
                        $('#deleteUserModal').modal('hide');
                    },
                    error: function(xhr, status, error) {
                        console.log('Error deleting user:', error);
                        // Hide the current modal
                        $('#deleteUserModal').modal('hide');
                        
                        // Show error message in a new Bootstrap modal
                        const errorModal = `
                            <div class="modal" tabindex="-1" id="errorModal">
                                <div class="modal-dialog">
                                    <div class="modal-content mx-auto">
                                        <div class="modal-header">
                                            <h5 class="modal-title">Error!</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <p>Failed to delete user.</p>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        // Append the error modal if it doesn't exist yet
                        if (!$('#errorModal').length) {
                            $('body').append(errorModal);
                        }
                        // Show the error modal
                        new bootstrap.Modal(document.getElementById('errorModal')).show();
                    }
                });
            }
        });
    });
    </script>
    <script src="/js/user-management-pagination.js"></script>
</body>
</html>