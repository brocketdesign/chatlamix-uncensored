<!DOCTYPE html>
<html lang="{{user.lang}}">
    {{> dashboard-header}}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <link rel="stylesheet" href="/css/chat-suggestions.css">
    <link rel="stylesheet" href="/css/speech-to-text.css">
    <link rel="stylesheet" href="/css/chat-scenario.css">
    <link rel="stylesheet" href="/css/chat-goals-widget.css">
    <link rel="stylesheet" href="/css/chat-list-tabs.css">
    <link rel="stylesheet" href="/css/chat-history-sidebar.css">
<body>
    {{> onboarding-modals}}
    <!-- Fullscreen overlay with loading spinner -->
    <div class="fullscreen-overlay justify-content-center align-items-center" id="loadingOverlay">
        <div class="loading-spinner-container">
            <div class="loading-circle shadow" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="loading-center-content rounded-circle" style="width: 100px; height: 100px; background: white;">
                <i class="bi bi-chat-heart-fill" style="font-size: 3em; color: #b58afe;"></i>
            </div>
        </div>
    </div>
    <div id="swup-none">
        <div id="overlay" class="d-sm-none bg-dark" style="position: fixed; inset: 0; z-index: 1033; display: none; opacity: 0.4; overflow: hidden;"></div>
        <div class="content collapsed">
            <nav class="navbar navbar-expand-lg navbar-white fixed-top shadow-0 flex-column" style="z-index: 1020; background-color: transparent !important;">
                <div class="container-fluid">
                    <div class="d-flex align-items-center justify-content-center">
                        <div style="position: absolute;left:10px;top:13px;">
                            <button 
                            class="btn badge-sm text-white shadow-0 onchat-on" 
                            style="background-color: color(display-p3 0.731 0.632 0.98 / 0.17);"
                            onclick="showDiscovery()"><i class="bi bi-chevron-left"></i></button>

                            <button id="chat-actions-btn" 
                                class="btn badge-sm text-white shadow-0 onchat-on" 
                                style="background-color: color(display-p3 0.731 0.632 0.98 / 0.17); display: none;"
                                onclick="openChatActionsModal()">
                                <i class="bi bi-three-dots"></i>
                            </button>
                        </div>
                        <div class="d-flex flex-row " style="cursor: pointer; min-height: 40px;" onclick="showDiscovery()">
                            <div class="brand-logo me-3 onchat-off" style="display: flex; position: absolute; left: 10px;">
                                <i class="bi bi-chat-heart-fill text-white fs-3"></i>
                            </div>
                        </div>  
                        <div>
                            <div class="navbar-collapse" id="navbarNav" style="position: absolute;right: -50vw;top: 10px;">
                                <ul class="navbar-nav ms-auto flex-row mb-lg-0">
                                    {{> dashboard-avatar}}
                                </ul>
                            </div>
                        </div>   
                    </div>
                </div>
            {{> chat-header}}
            </nav>
            {{> chat-list}}
            <section id="chat-discovery" class="onchat-off" style="display: block; padding-top: 180px;">
                
                {{#if isTemporaryOrGuest}}
                <!-- Welcome Section for First-Time Users -->
                <div class="welcome-section mb-5 px-4">
                    <div class="text-center mb-5">
                        <h1 class="display-5 fw-bold mb-2 text-gradient" style="background: linear-gradient(135deg, #b58afe 0%, #6c5ce7 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                            {{translations.welcomeSection.title}}
                        </h1>
                        <p class="lead text-muted mb-4">
                            {{translations.welcomeSection.subtitle}}
                        </p>
                        <button class="btn btn-primary px-4 py-2" onclick="openLoginForm()">
                            <i class="bi bi-box-arrow-in-right me-2"></i>{{translations.welcomeSection.signIn}}
                        </button>
                    </div>

                    <!-- Steps Grid -->
                    <div class="row g-3 mb-5" style="max-width: 1000px; margin-left: auto; margin-right: auto;">
                        <div class="col-md-6 col-lg-3">
                            <div class="card h-100 border-0 shadow-sm text-center" style="background: linear-gradient(135deg, rgba(181, 138, 254, 0.1) 0%, rgba(108, 92, 231, 0.1) 100%);">
                                <div class="card-body d-flex flex-column justify-content-center py-4">
                                    <div class="mb-3">
                                        <i class="bi bi-person-heart text-primary" style="font-size: 2.5rem;"></i>
                                    </div>
                                    <h6 class="card-title fw-bold">{{translations.welcomeSection.steps.step1.title}}</h6>
                                    <p class="card-text text-muted small">{{translations.welcomeSection.steps.step1.description}}</p>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6 col-lg-3">
                            <div class="card h-100 border-0 shadow-sm text-center" style="background: linear-gradient(135deg, rgba(181, 138, 254, 0.1) 0%, rgba(108, 92, 231, 0.1) 100%);">
                                <div class="card-body d-flex flex-column justify-content-center py-4">
                                    <div class="mb-3">
                                        <i class="bi bi-chat-dots text-primary" style="font-size: 2.5rem;"></i>
                                    </div>
                                    <h6 class="card-title fw-bold">{{translations.welcomeSection.steps.step2.title}}</h6>
                                    <p class="card-text text-muted small">{{translations.welcomeSection.steps.step2.description}}</p>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6 col-lg-3">
                            <div class="card h-100 border-0 shadow-sm text-center" style="background: linear-gradient(135deg, rgba(181, 138, 254, 0.1) 0%, rgba(108, 92, 231, 0.1) 100%);">
                                <div class="card-body d-flex flex-column justify-content-center py-4">
                                    <div class="mb-3">
                                        <i class="bi bi-image text-primary" style="font-size: 2.5rem;"></i>
                                    </div>
                                    <h6 class="card-title fw-bold">{{translations.welcomeSection.steps.step3.title}}</h6>
                                    <p class="card-text text-muted small">{{translations.welcomeSection.steps.step3.description}}</p>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6 col-lg-3">
                            <div class="card h-100 border-0 shadow-sm text-center" style="background: linear-gradient(135deg, rgba(181, 138, 254, 0.1) 0%, rgba(108, 92, 231, 0.1) 100%);">
                                <div class="card-body d-flex flex-column justify-content-center py-4">
                                    <div class="mb-3">
                                        <i class="bi bi-film text-primary" style="font-size: 2.5rem;"></i>
                                    </div>
                                    <h6 class="card-title fw-bold">{{translations.welcomeSection.steps.step4.title}}</h6>
                                    <p class="card-text text-muted small">{{translations.welcomeSection.steps.step4.description}}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {{/if}}

                
            </section>
            <div id="chat-wrapper" class="px-0 onchat-on" style="background-position: top center;background-repeat: no-repeat;">
                <!-- Chat Container Overlay -->
                <div id="chat-container" class="container mx-auto shadow-0 border-0 rounded-0" style="border-radius:0 !important;position: relative;">
                    <div class="chat-overlay d-flex justify-content-center align-items-center w-100 h-100vh position-absolute top-0 start-0 bottom-0" id="chatOverlay" style="display: none;"></div>
                    
                    <div class="card-body text-center p-0 container" style="min-height:250px;overflow-y:hidden;display: flex;flex-direction: column;position: relative;z-index: 990;">
                        <!-- Chat Scenarios Container - positioned absolutely but within chat wrapper to avoid toolbar overlap -->
                        <div class="scenario-container"></div>
                        <div id="chatContainer" data-id="" class="pt-2 fade-content" style="padding-bottom: 180px !important;"></div>
                    </div>
                </div>  
            </div>  
        </div>
    </div>
 {{> dashboard-footer}}

    <!-- Chat Actions Modal -->
    <div class="modal fade" id="chatActionsModal" tabindex="-1" aria-labelledby="chatActionsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-sm">
            <div class="modal-content border-0 shadow-lg" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border-radius: 20px; overflow: hidden;">
                <!-- Modal Header with Chat Avatar -->
                <div class="modal-header border-0 pb-0 pt-4 px-4">
                    <div class="d-flex align-items-center w-100">
                        <i class="bi bi-chevron-left text-white" style="cursor: pointer; font-size: 1.2rem;" data-bs-dismiss="modal" aria-label="Close"></i>
                        <div class="flex-grow-1"></div>
                        <div class="text-end me-3">
                            <h6 id="chatActionsName" class="mb-0 text-white fw-semibold">Chat Name</h6>
                            <small class="text-muted">{{translations.chatActions}}</small>
                        </div>
                        <div class="position-relative">
                            <img id="chatActionsAvatar" src="/img/logo.webp" alt="Chat Avatar"
                                 class="rounded-circle shadow"
                                 style="width: 50px; height: 50px; object-fit: cover; border: 2px solid rgba(181, 138, 254, 0.5);">
                        </div>
                    </div>
                </div>
                
                <!-- Modal Body with Action Items -->
                <div class="modal-body px-3 py-4 mt-3">
                    <div id="chatActionsContent" class="d-flex flex-column gap-2">
                        <!-- Actions will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
    /* Chat Actions Modal Styles */
    #chatActionsModal .modal-content {
        backdrop-filter: blur(10px);
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%) !important;
    }
    
    #chatActionsModal .chat-action-item {
        display: flex;
        align-items: center;
        padding: 14px 16px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.12);
        color: #ffffff;
        text-decoration: none;
        transition: all 0.2s ease;
        cursor: pointer;
    }
    
    #chatActionsModal .chat-action-item:hover {
        background: rgba(181, 138, 254, 0.25);
        border-color: rgba(181, 138, 254, 0.4);
        transform: translateX(4px);
    }
    
    #chatActionsModal .chat-action-item .action-icon {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 10px;
        margin-right: 14px;
        font-size: 1.2rem;
    }
    
    #chatActionsModal .chat-action-item .action-icon.primary {
        background: rgba(59, 130, 246, 0.3);
        color: #93c5fd;
    }
    
    #chatActionsModal .chat-action-item .action-icon.info {
        background: rgba(34, 211, 238, 0.3);
        color: #67e8f9;
    }
    
    #chatActionsModal .chat-action-item .action-icon.warning {
        background: rgba(251, 191, 36, 0.3);
        color: #fcd34d;
    }
    
    #chatActionsModal .chat-action-item .action-icon.success {
        background: rgba(34, 197, 94, 0.3);
        color: #86efac;
    }
    
    #chatActionsModal .chat-action-item .action-icon.purple {
        background: rgba(181, 138, 254, 0.3);
        color: #c4b5fd;
    }
    
    #chatActionsModal .chat-action-item .action-icon.danger {
        background: rgba(239, 68, 68, 0.3);
        color: #fca5a5;
    }
    
    #chatActionsModal .chat-action-item .action-text {
        font-size: 1rem;
        font-weight: 600;
        color: #ffffff;
        letter-spacing: 0.01em;
    }
    
    #chatActionsModal .chat-action-item .action-arrow {
        margin-left: auto;
        opacity: 0.4;
        transition: opacity 0.2s ease;
        color: #ffffff;
    }
    
    #chatActionsModal .chat-action-item:hover .action-arrow {
        opacity: 1;
        color: #b58afe;
    }
    
    #chatActionsModal .action-divider {
        height: 1px;
        background: rgba(255, 255, 255, 0.15);
        margin: 8px 0;
    }
    
    #chatActionsModal .modal-header {
        background: rgba(0, 0, 0, 0.2);
    }

    #chatActionsModal #chatActionsName {
        color: #ffffff !important;
        font-size: 1.1rem;
    }
    
    #chatActionsModal .text-muted {
        color: rgba(255, 255, 255, 0.6) !important;
    }

    /* Admin Section Styles */
    #chatActionsModal .admin-section-header {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 16px;
        background: rgba(181, 138, 254, 0.15);
        border-radius: 8px;
        margin-bottom: 8px;
        border: 1px solid rgba(181, 138, 254, 0.3);
    }

    #chatActionsModal .admin-section-header i {
        color: #b58afe;
        font-size: 1rem;
    }

    #chatActionsModal .admin-section-header span {
        color: #c4b5fd;
        font-size: 0.85rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    #chatActionsModal .admin-model-section {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        padding: 14px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    #chatActionsModal .admin-model-section .model-label {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 10px;
        color: rgba(255, 255, 255, 0.8);
        font-size: 0.85rem;
        font-weight: 500;
    }

    #chatActionsModal .admin-model-section .model-label i {
        color: #b58afe;
    }

    #chatActionsModal .current-model-display {
        background: rgba(181, 138, 254, 0.1);
        border-radius: 8px;
        padding: 8px 12px;
        margin-bottom: 10px;
        border: 1px solid rgba(181, 138, 254, 0.2);
    }

    #chatActionsModal .current-model-display .current-model-name {
        color: #e9d5ff;
        font-size: 0.9rem;
        font-weight: 500;
    }

    #chatActionsModal .model-dropdown {
        width: 100%;
        padding: 10px 12px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.15);
        background: rgba(0, 0, 0, 0.3);
        color: #ffffff;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    #chatActionsModal .model-dropdown:hover {
        border-color: rgba(181, 138, 254, 0.5);
    }

    #chatActionsModal .model-dropdown:focus {
        outline: none;
        border-color: #b58afe;
        box-shadow: 0 0 0 2px rgba(181, 138, 254, 0.2);
    }

    #chatActionsModal .model-dropdown option {
        background: #1a1a2e;
        color: #ffffff;
        padding: 8px;
    }

    #chatActionsModal .model-dropdown optgroup {
        background: #16213e;
        color: #b58afe;
        font-weight: 600;
    }

    #chatActionsModal .model-dropdown:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    </style>

    <script>
    window.GEN_DASHBOARD_CONFIG = window.GEN_DASHBOARD_CONFIG || {};
    window.GEN_DASHBOARD_CONFIG.imageModels = {{#if imageModels}}{{{json imageModels}}}{{else}}[]{{/if}};
    </script>

    <script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.19.0/js/md5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script src="/js/viewport-height-fix.js"></script>
    <script src="/js/merge-face.js"></script>
    <script src="/js/txt2speech.js"></script>
    <script src="/js/dashboard-category.js"></script>
    <script src="/js/chat-tool-swiper.js"></script>
    <script src="/js/chat-tool-toolbar.js"></script>
    <script src="/js/social-connections.js"></script>
    <script src="/js/chat-tool-edit.js"></script>
    <script src="/js/chat-tool-infos.js"></script>
    <script src="/js/chat-list.js"></script>
    <script src="/js/favorites.js"></script>
    <script src="/js/chat-tool-prompts.js"></script>
    <script src="/js/chat-tool-gifts.js"></script>
    <script src="/js/chat-tool-settings.js"></script>
    <script src="/js/chat-tool-message.js"></script>
    <script src="/js/chat-tool-goals.js"></script>
    <script src="/js/chat-suggestions.js"></script>
    <script src="/js/chat-scenario.js"></script>
    <script src="/js/chat-footer.js"></script>
    <script src="/js/live-goals-widget.js"></script>
    <script src="/js/chat.js"></script>
    <script src="/js/nsfw-upsell-modal.js"></script>
    <script src="/js/character-infos.js"></script>
    <script src="/js/img2video.js"></script>
    <script src="/js/speech-to-text-init.js"></script>
    <script src="/js/speech-to-text-ui.js"></script>
    <script src="/js/speech-to-text-utils.js"></script>

    <!-- Modularized scripts extracted from inline block -->
    <script src="/js/modules/layout-adjustments.js"></script>
    <script src="/js/modules/iframe-communication.js"></script>
    <script src="/js/modules/chat-history.js"></script>
    <script src="/js/modules/popular-chats.js"></script>
    <script src="/js/modules/latest-chats.js"></script>
    <script src="/js/modules/chat-filters.js"></script>
    <script src="/js/modules/ui-helpers.js"></script>
    <script src="/js/modules/checkout.js"></script>
    <script src="/js/modules/init.js"></script>

    {{#if shouldUpdateUrl}}
    <script>
    // Update URL from /chat to /chat/ without page reload
    (function() {
        if (window.location.pathname === '/chat') {
            const newUrl = '/chat/' + window.location.search + window.location.hash;
            window.history.replaceState({ path: newUrl }, '', newUrl);
        }
    })();
    </script>
    {{/if}}

    <script>
    // Update URL from / to /chat/ without page reload
    (function() {
        if (window.location.pathname === '/' || window.location.pathname === '') {
            const newUrl = '/chat/' + window.location.search + window.location.hash;
            window.history.replaceState({ path: newUrl }, '', newUrl);
        }
    })();
    </script>

</body>
</html>